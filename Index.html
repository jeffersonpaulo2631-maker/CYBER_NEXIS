<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Canal Secreto - CyberNexis</title>
  <style>
    * { box-sizing: border-box; }
    body {
      background-color: black;
      color: red;
      font-family: "Courier New", monospace;
      margin: 0;
      padding: 0;
    }
    header { text-align: center; padding: 20px; }
    header img {
      max-width: 150px;
      filter: drop-shadow(0 0 8px red);
    }
    #chat-container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background-color: #111;
      border: 2px solid red;
      border-radius: 10px;
      box-shadow: 0 0 20px red;
    }
    h2 {
      text-align: center;
      color: red;
      text-shadow: 0 0 5px red;
      font-size: 1.6rem;
    }
    #chat-log {
      height: 300px;
      overflow-y: auto;
      background-color: #000;
      padding: 10px;
      border: 1px solid red;
      border-radius: 5px;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .mensagem {
      max-width: 80%;
      padding: 10px;
      border-radius: 10px;
      background-color: #111;
      border: 1px solid red;
      word-wrap: break-word;
      animation: aparecer 0.3s ease-in-out;
    }
    .mensagem span.remetente {
      font-weight: bold;
      color: red;
      display: block;
      margin-bottom: 5px;
      text-shadow: 0 0 5px red;
    }
    .mensagem.usuario { align-self: flex-end; background-color: #220000; }
    .mensagem.bot { align-self: flex-start; background-color: #001111; border-color: cyan; }
    .arquiteto span.remetente { color: #ff3333; text-shadow: 0 0 8px #ff3333; }
    @keyframes aparecer {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 5px;
      border: none;
      background-color: #000;
      color: red;
      font-family: monospace;
      font-size: 16px;
    }
    input:focus {
      outline: none;
      background-color: #111;
    }
    button {
      width: 100%;
      padding: 10px;
      background-color: red;
      color: black;
      font-weight: bold;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover { background-color: darkred; }
    @media (max-width: 600px) {
      #chat-container { margin: 20px; padding: 15px; }
      h2 { font-size: 1.2rem; }
      .mensagem { font-size: 14px; }
    }
  </style>
</head>
<body>

<header>
  <img src="Imagem/Logotipo.jpg" alt="CyberNexis Logo">
</header>

<div id="chat-container">
  <h2>Canal de ComunicaÃ§Ã£o Secreta</h2>
  <div id="chat-log"></div>
  <input id="codinome" type="text" placeholder="Digite seu codinome">
  <input id="chat-input" type="text" placeholder="Digite sua mensagem">
  <input id="file-input" type="file" accept="image/*" style="display:none;">
  <button onclick="document.getElementById('file-input').click()">ðŸ“Ž Enviar Imagem</button>
  <button onclick="limparChat()">Limpar Conversa</button>
  <button onclick="exportarConversa()">Exportar Conversa</button>
</div>

<audio id="som-msg" src="mensagem.mp3" preload="auto"></audio>

<script>
const chatLog = document.getElementById("chat-log");
const input = document.getElementById("chat-input");
const codinomeInput = document.getElementById("codinome");
const fileInput = document.getElementById("file-input");
const som = document.getElementById("som-msg");

window.onload = () => {
  const dados = localStorage.getItem("chat-log");
  if (dados) {
    chatLog.innerHTML = dados;
    chatLog.scrollTop = chatLog.scrollHeight;
  }
};

function limparChat() {
  if (confirm("Tem certeza que deseja apagar toda a conversa?")) {
    chatLog.innerHTML = "";
    localStorage.removeItem("chat-log");
  }
}

function exportarConversa() {
  const texto = chatLog.innerText;
  const blob = new Blob([texto], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "chat_cybernexis.txt";
  a.click();
  URL.revokeObjectURL(url);
}

input.addEventListener("keydown", async (e) => {
  if (e.key === "Enter" && input.value.trim() !== "") {
    await enviarMensagemTexto(input.value.trim());
    input.value = "";
  }
});

async function enviarMensagemTexto(texto) {
  const codinome = codinomeInput.value.trim() || "Desconhecido";
  const chave = await gerarChave(codinome);
  const criptografada = await criptografarMensagem(texto, chave);
  adicionarMensagem(codinome, criptografada);

  setTimeout(async () => {
    let resposta = "Mensagem recebida. OperaÃ§Ã£o confirmada.";
    if (texto.toLowerCase().includes("ajuda")) resposta = "Envie o cÃ³digo da missÃ£o ou setor desejado.";
    const criptadaResposta = await criptografarMensagem(resposta, chave);
    adicionarMensagem("Agente-X", criptadaResposta);
  }, 1000);
}

fileInput.addEventListener("change", async () => {
  const arquivo = fileInput.files[0];
  if (!arquivo || !arquivo.type.startsWith("image/")) return;
  if (arquivo.size > 1024 * 1024) return alert("Imagem muito grande (limite: 1MB)");

  const leitor = new FileReader();
  leitor.onload = async () => {
    const base64 = leitor.result;
    const codinome = codinomeInput.value.trim() || "Desconhecido";
    const chave = await gerarChave(codinome);
    const criptografada = await criptografarMensagem(base64, chave);
    adicionarMensagem(codinome, criptografada, true);
  };
  leitor.readAsDataURL(arquivo);
});

function adicionarMensagem(remetente, textoCriptografado, isImagem = false) {
  descriptografarMensagem(textoCriptografado, gerarChave(remetente)).then((conteudo) => {
    const div = document.createElement("div");
    const classeRemetente = remetente.toLowerCase();
    const isUsuario = classeRemetente !== "agente-x";
    const classe = classeRemetente === "arquiteto" ? "arquiteto" : "";

    div.classList.add("mensagem", isUsuario ? "usuario" : "bot");
    if (classe) div.classList.add(classe);

    div.innerHTML = `<span class='remetente'>[${remetente}]</span>` +
      (isImagem ? `<img src="${conteudo}" style="max-width: 100%; border: 1px solid red; border-radius: 6px;">` : conteudo);

    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
    localStorage.setItem("chat-log", chatLog.innerHTML);
    som.play();
  });
}

async function gerarChave(senha) {
  const encoder = new TextEncoder();
  const hash = await crypto.subtle.digest("SHA-256", encoder.encode(senha));
  return crypto.subtle.importKey("raw", hash, { name: "AES-GCM" }, false, ["encrypt", "decrypt"]);
}

async function criptografarMensagem(texto, chave) {
  const encoder = new TextEncoder();
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const dados = encoder.encode(texto);
  const cifrado = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, chave, dados);
  const bufferTotal = new Uint8Array(iv.length + cifrado.byteLength);
  bufferTotal.set(iv, 0);
  bufferTotal.set(new Uint8Array(cifrado), iv.length);
  return btoa(String.fromCharCode(...bufferTotal));
}

async function descriptografarMensagem(textoCriptografado, chavePromessa) {
  const chave = await chavePromessa;
  const dados = Uint8Array.from(atob(textoCriptografado), c => c.charCodeAt(0));
  const iv = dados.slice(0, 12);
  const cifrado = dados.slice(12);
  const decifrado = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, chave, cifrado);
  return new TextDecoder().decode(decifrado);
}
</script>
</body>
</html>
