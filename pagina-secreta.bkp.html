<!DOCTYPE html>
<html lang="pt-br">
<head>
 <!-- Firebase SDKs (Compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  
 <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js">
</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cyber-Nexis - Sistema Secreto</title>
  <style>
    body {
      background-color: black;
      color: lime;
      font-family: monospace;
      cursor: crosshair;
      margin: 0;
      padding: 0;
    }
    .oculto { display: none; }
    input, button, select, textarea {
      background: black;
      color: lime;
      border: 1px solid lime;
      padding: 5px;
      margin: 5px;
      width: calc(100% - 22px);
    }
    .header, .menu, .content, .logs {
      border: 1px solid lime;
      padding: 10px;
      margin: 5px;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
    }
    .menu {
      width: 220px;
    }
    .content {
      flex: 1;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    ul li {
      cursor: pointer;
      padding: 4px;
    }
    ul li:hover {
      background-color: #0f0;
      color: black;
    }
    .codebox {
      background: #111;
      border: 1px dashed lime;
      padding: 10px;
      font-family: monospace;
      white-space: pre-wrap;
      margin-top: 10px;
    }
    .logo {
      width: 100px;
      display: block;
      margin: 10px auto;
    }
    .log-item {
  background-color: black; /* fundo preto */
  color: lime;             /* texto verde */
  font-family: monospace;  /* estilo de terminal */
  padding: 5px 10px;
  margin-bottom: 3px;
  border-left: 3px solid lime; /* efeito visual tipo terminal */
  border-radius: 2px;
  white-space: pre-wrap;   /* mantém quebras de linha */
}
  </style>
</head>
<body>

<!--SOM-->
<audio id="som-baixo" src="Sons/error_sound-221445.mp3"></audio>
<audio id="som-medio" src="Sons/beep-warning-6387.mp3"></audio>
<audio id="som-critico" src="Sons/siren-alert-96052.mp3"></audio>

<!-- TELA DE CADASTRO -->
<div id="telaCadastro">
  <h2>Cadastro de Agente</h2>
  <input id="cadastro-usuario" placeholder="Usuário"><br>
<input id="cadastro-senha" type="password" placeholder="Senha"><br>
<input id="cadastro-frase" placeholder="Frase de segurança"><br>
<select id="cadastro-nivel" onchange="mostrarSetorSeComandante()">
    <option value="Observador">Observador</option>
    <option value="Iniciado">Iniciado</option>
 <option value="Operador">Operador</option>
    <option value="Comandante">Comandante</option>
    <option value="Arquiteto">Arquiteto</option>
   <option value="Líder Supremo">Líder Supremo</option>
  </select><br/>
  
<div id="escolha-setor" style="display:none; margin-top:10px;">
  <label>Escolha o Setor:</label>
  <select id="cadastro-setor">
    <option value="">-- Selecione o setor --</option>
    <option value="seguranca_info">🔒 Segurança da Informação</option>
    <option value="psicologia">🧠 Psicologia Estratégica</option>
    <option value="contra_inteligencia">🎭 Contra-Inteligência</option>
    <option value="financas">💰 Finanças Secretas</option>
    <option value="operacao_campo">🛰️ Operação de Campo</option>
    <option value="ia_estrategica">🤖 IA Estratégica</option>
  </select>
</div>

<button onclick="verificarCadastro()">✅ Cadastrar</button>

  <button onclick="irParaLogin()">Já tenho cadastro</button>
  <p id="cadastro-msg"></p>
</div>

<!-- TELA DE LOGIN -->
<div id="telaLogin" class="oculto">
  <img src="Imagem/Logo terminal.png" alt="Logo terminal.png" class="logo"/>
  <h2>Acesso Restrito</h2>
  <input type="text" id="login-usuario" placeholder="Agente" />
  <input type="password" id="login-senha" placeholder="Senha" />
  <input type="text" id="login-frase" placeholder="Frase secreta/token" />
  <button onclick="login()">Entrar</button>
  <button onclick="irParaCadastro()">Novo agente</button>
  <p id="login-msg"></p>
</div>

<!-- TELA DO SISTEMA PRINCIPAL -->
<div id="telaSistema" class="oculto">
  <div class="header">
    <h1>🛡️ Cyber-Nexis</h1>
    <div id="alertaSistema">Nível de Alerta: 🟢 Baixo</div>
    <button onclick="trocarAlerta()">🔁 Alternar Alerta</button>
    <button onclick="logout()">🚪 Sair</button>
  </div>

  <div class="container">
    <div class="menu">
      <h3>Setores</h3>
      <ul>
       <li onclick="abrirChatOnline()">💬 Chat Online</li>
       <li onclick="abrirPainelAnalise()">📊 Painel Analítico</li>
        <li onclick="mostrarSetor('hacker')">💻 Hacker Avançado</li>
        <li onclick="abrirCriptografia()">🔐 Criptografia AES</li>
        <li onclick="abrirLogs()">📜 Logs & Localização</li>
        <li onclick="abrirMensagens()">💬 Mensagens Secretas</li>
        <li onclick="abrirQuiz()">🧠 Teste Psicológico</li>
        <li onclick="abrirOperacoes()">🛰️ Operações ao Vivo</li>
     <li onclick="abrirPastas()">📁 Pastas Seguras</li>
<li onclick="abrirSetor('seguranca_info')">🔒 Divisão de Segurança da Informação</li>
<li onclick="abrirSetor('psicologia')">🧠 Divisão de Psicologia Estratégica</li>
<li onclick="abrirSetor('contra_inteligencia')">🎭 Divisão Contra-Inteligência</li>
<li onclick="abrirSetor('financas')">💰 Divisão de Finanças Secretas</li>
<li onclick="abrirSetor('operacao_campo')">🛰️ Divisão de Operação de Campo</li>
<li onclick="abrirSetor('ia_estrategica')">🤖 Divisão de IA Estratégica & Deep Learning</li>
 
        <li onclick="abrirAdmin()">👑 Painel do Líder Supremo</li>
      </ul>
    </div>

   <div class="content" id="conteudo">
  <h2>Bem-vindo à Cyber-Nexis</h2>
  <img src="Imagem/Logo terminal.png" width="100" height="200 alt="Logo terminal.png" class="logo" />
 
</div>

  <div class="logs">
    <h3>Logs do Sistema</h3>
    <ul id="log-list"></ul>
  </div>
</div>

<script>
// Configuração do Firebase (seu projeto)
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBc2jZvuUfuUxwR977B1y5bWGrB3--mF6Q",
  authDomain: "chat-secreto-27118.firebaseapp.com",
  databaseURL: "https://chat-secreto-27118-default-rtdb.firebaseio.com",
  projectId: "chat-secreto-27118",
  storageBucket: "chat-secreto-27118.firebasestorage.app",
  messagingSenderId: "494067321271",
  appId: "1:494067321271:web:5cb7c8db77f7797b55c032",
  measurementId: "G-6WKHHJEJ49"
};

// Inicializa Firebase
firebase.initializeApp(FIREBASE_CONFIG);
const auth = firebase.auth();
const db = firebase.database();
    
// ---------- Helpers de segurança ----------
function safeTextNode(tag, text) {
  const el = document.createElement(tag || "div");
  el.textContent = text;
  return el;
}

function appendSafe(parent, tag, text) {
  parent.appendChild(safeTextNode(tag, text));
}

function clearElement(el) {
  while (el.firstChild) el.removeChild(el.firstChild);
}

async function gerarSalt() {
  const salt = crypto.getRandomValues(new Uint8Array(16));
  return Array.from(salt).map(b => ('00' + b.toString(16)).slice(-2)).join('');
}

async function pbkdf2Hash(password, saltHex, iterations = 200000) {
  const enc = new TextEncoder().encode(password);
  const salt = new Uint8Array(saltHex.match(/.{2}/g).map(h => parseInt(h,16)));
  const key = await crypto.subtle.importKey('raw', enc, {name:'PBKDF2'}, false, ['deriveBits']);
  const derived = await crypto.subtle.deriveBits(
    { name: 'PBKDF2', salt, iterations, hash: 'SHA-256' },
    key,
    256
  );
  return btoa(String.fromCharCode(...new Uint8Array(derived)));
}

// Criptografia de mensagens helpers
async function deriveKeyFromPassword(password, saltHex) {
  const enc = new TextEncoder().encode(password);
  const salt = new Uint8Array(saltHex.match(/.{2}/g).map(h => parseInt(h,16)));
  const baseKey = await crypto.subtle.importKey('raw', enc, 'PBKDF2', false, ['deriveKey']);
  const key = await crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt, iterations: 200000, hash: 'SHA-256' },
    baseKey,
    { name: 'AES-GCM', length: 256 },
    false, // non-extractable
    ['encrypt','decrypt']
  );
  return key;
}

function bytesToBase64(bytes) {
  return btoa(String.fromCharCode(...bytes));
}
function base64ToBytes(b64) {
  return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
}

async function encryptMessageWithPassword(message, password) {
  const salt = await gerarSalt();
  const key = await deriveKeyFromPassword(password, salt);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, new TextEncoder().encode(message));
  return {
    salt,
    iv: Array.from(iv),
    cipher: Array.from(new Uint8Array(ciphertext))
  };
}

async function decryptMessageWithPassword(obj, password) {
  const key = await deriveKeyFromPassword(password, obj.salt);
  const iv = new Uint8Array(obj.iv);
  const cipher = new Uint8Array(obj.cipher);
  const plain = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, cipher);
  return new TextDecoder().decode(plain);
}    
    
function mostrarSetorSeComandante() {
  const nivel = document.getElementById("cadastro-nivel").value;
  const setorDiv = document.getElementById("escolha-setor");
  setorDiv.style.display = (nivel === "Comandante") ? "block" : "none";
}
let usuarioAtual = null;
let alertaAtual = "baixo";

// ===== FUNÇÃO DE CADASTRO =====
async function verificarCadastro() {
  const nome = document.getElementById("cadastro-usuario").value.trim();
  const senha = document.getElementById("cadastro-senha").value;
  const frase = document.getElementById("cadastro-frase").value.trim().toLowerCase();
  const nivel = document.getElementById("cadastro-nivel").value;

  if (!nome || !senha || !frase || !nivel) {
    alert("⚠️ Preencha todos os campos.");
    return;
  }

  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  if (usuarios[nome]) {
    alert("⚠️ Este agente já existe.");
    return;
  }

  const salt = await gerarSalt();
  const verificador = await pbkdf2Hash(senha, salt);

  if (nivel === "Comandante") {
    const setorEscolhido = document.getElementById("cadastro-setor").value;
    if (!setorEscolhido) {
      alert("⚠️ Escolha um setor para o Comandante.");
      return;
    }
    const jaExiste = Object.values(usuarios).some(u => u.nivel === "Comandante" && u.setor === setorEscolhido);
    if (jaExiste) {
      alert(`⛔ Já existe um Comandante para o setor ${setorEscolhido}.`);
      return;
    }
    usuarios[nome] = { salt, verificador, nivel, frase, setor: setorEscolhido, criadoEm: (nivel==='Observador'?Date.now():null) };
    localStorage.setItem("usuarios", JSON.stringify(usuarios));
    alert(`✅ Cadastro concluído! ${nome} é o novo Comandante de ${setorEscolhido}.`);
    abrirSetor(setorEscolhido);
    return;
  }

  if (nivel === "Líder Supremo") {
    const existeSupremo = Object.values(usuarios).some(u => u.nivel === "Líder Supremo");
    if (existeSupremo) {
      alert("⛔ Já existe um Líder Supremo. A criação não é permitida.");
      return;
    }
  }

  usuarios[nome] = { salt, verificador, nivel, frase, criadoEm: (nivel==='Observador'?Date.now():null) };
  localStorage.setItem("usuarios", JSON.stringify(usuarios));
  alert("✅ Cadastro realizado com sucesso!");
  irParaLogin();
}

// ===== FUNÇÃO DE LOGIN COM VALIDAÇÃO DE OBSERVADOR =====
async function login() {
  const nome = document.getElementById("login-usuario").value.trim();
  const senha = document.getElementById("login-senha").value;
  const frase = document.getElementById("login-frase").value.trim();

  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");

  if (!usuarios[nome]) {
    document.getElementById("login-msg").innerText = "Usuário não encontrado!";
    return;
  }

  const u = usuarios[nome];

  // Recalcula o verificador com a senha informada
  const verificadorLogin = await pbkdf2Hash(senha, u.salt);

  if (u.verificador !== verificadorLogin || u.frase !== frase) {
    document.getElementById("login-msg").innerText = "Senha ou frase secreta incorreta!";
    return;
  }

  // Se passou, login bem-sucedido
  usuarioAtual = { nome, nivel: u.nivel, criadoEm: u.criadoEm };
  localStorage.setItem("sessaoAtual", JSON.stringify(usuarioAtual));

  document.getElementById("login-msg").innerText = "Login realizado com sucesso!";
  logAcao(`🔑 Usuário ${nome} logou no sistema.`);
  mostrarTela("telaSistema");

  // chama a função única e externa de geolocalização
  if (typeof registrarAcessoComGeolocalizacao === 'function') {
    try { registrarAcessoComGeolocalizacao(usuarioAtual); } catch(e) { console.warn(e); }
  }

  const usuario = usuarios[nome];

  // Limite de 24h para Observador
  if (usuario.nivel === "Observador" && usuario.criadoEm) {
    const agora = Date.now();
    const limite = usuario.criadoEm + 24 * 60 * 60 * 1000; // 24h em ms
    if (agora > limite) {
      alert("⛔ Sua conta de Observador expirou. Login bloqueado.");
      return;
    }
    // se ainda válido, iniciar cronômetro
    iniciarCronometroObservador();
  }
}

// ===== FUNÇÃO DE CRONÔMETRO PARA OBSERVADOR =====
async function iniciarCronometroObservador() {
  const areaAlerta = document.getElementById("alertaSistema");
  const limite = usuarioAtual.criadoEm + 24 * 60 * 60 * 1000;

  const interval = setInterval(() => {
    const restante = limite - Date.now();
    if (restante <= 0) {
      clearInterval(interval);
      alert("⛔ Tempo de Observador expirou. Você será desconectado.");
      logout();
      return;
    }
    const horas = Math.floor(restante / (1000 * 60 * 60));
    const minutos = Math.floor((restante % (1000 * 60 * 60)) / (1000 * 60));
    const segundos = Math.floor((restante % (1000 * 60)) / 1000);
    areaAlerta.innerHTML = `Nível de Alerta: 🟢 Baixo | Tempo restante: ${horas}h ${minutos}m ${segundos}s`;
  }, 1000);
}

// ===== FUNÇÕES DE NAVEGAÇÃO =====
function mostrarTela(id) {
  ["telaCadastro", "telaLogin", "telaSistema"].forEach(tela => {
    document.getElementById(tela).classList.add("oculto");
  });
  document.getElementById(id).classList.remove("oculto");
}

function irParaLogin() {
  mostrarTela("telaLogin");
}

function irParaCadastro() {
  mostrarTela("telaCadastro");
}

// ===== LOGOUT =====
function logout() {
  usuarioAtual = null;
  localStorage.removeItem("sessaoAtual");
  mostrarTela("telaLogin");
  log("🚪 Sessão encerrada.");
}

// ===== LOG =====
function log(mensagem) {
  const ul = document.getElementById("log-list");
  const li = document.createElement("li");
  li.textContent = new Date().toLocaleTimeString() + " - " + mensagem;
  li.classList.add("log-item"); // aplica o estilo de terminal
  ul.appendChild(li);
}

// ===== RESTAURAR SESSÃO =====
window.onload = () => {
    const salvo = JSON.parse(localStorage.getItem("sessaoAtual"));
    if (salvo) {
        usuarioAtual = salvo;
        mostrarTela("telaSistema");
        log("🔐 Sessão restaurada automaticamente.");

        try {
            registrarAcessoComGeolocalizacao();
        } catch (e) {
            console.error("Erro na geolocalização:", e);
        }

        if (usuarioAtual.nivel === "Observador") {
            iniciarCronometroObservador();
        }
    } else {""
        mostrarTela("telaCadastro");
    }
};

  function tocarSomAlerta(nivel) {
  document.getElementById("som-baixo").pause();
  document.getElementById("som-medio").pause();
  document.getElementById("som-critico").pause();

  if (nivel === "baixo") document.getElementById("som-baixo").play();
  else if (nivel === "médio") document.getElementById("som-medio").play();
  else if (nivel === "crítico") document.getElementById("som-critico").play();
}

function trocarAlerta() {
  const alerta = document.getElementById("alertaSistema");
  if (alertaAtual === "baixo") {
    alertaAtual = "médio";
    alerta.innerHTML = "Nível de Alerta: 🟡 Médio";
    alerta.style.color = "yellow";
  } else if (alertaAtual === "médio") {
    alertaAtual = "crítico";
    alerta.innerHTML = "Nível de Alerta: 🔴 Crítico";
    alerta.style.color = "red";
  } else {
    alertaAtual = "baixo";
    alerta.innerHTML = "Nível de Alerta: 🟢 Baixo";
    alerta.style.color = "lime";
  }
  tocarSomAlerta(alertaAtual); // 🔊 reproduz som
  log("🚨 Alerta ajustado para " + alertaAtual.toUpperCase());
}

  function registrarAcessoComGeolocalizacao() {
    if (!navigator.geolocation) {
      log("🛑 Geolocalização não suportada.");
      return;
    }

    if (confirm("Deseja compartilhar sua localização com a base da Cyber-Nexis?")) {
      navigator.geolocation.getCurrentPosition(async position => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
          const data = await response.json();
          const cidade = data.address.city || data.address.town || data.address.village || "Desconhecida";
          const pais = data.address.country || "Desconhecido";
          log(`🛰️ Agente ${usuarioAtual.nome} acessou de ${cidade}, ${pais}`);
        } catch {
          log(`🌐 Acesso de ${usuarioAtual.nome}, mas falha ao localizar.`);
        }
      }, () => {
        log(`⚠️ Localização negada por ${usuarioAtual.nome}.`);
      });
    } else {
      log("📌 Localização não autorizada.");
    }
  };
</script>

<script>
  const perguntasQuiz = [
    {
      imagem: "quiz1.jpg",
      pergunta: "Você descobriu uma falha que dá acesso a dados bancários. O que faz?",
      opcoes: [
        { texto: "Explora para ganhar dinheiro.", pontos: 0 },
        { texto: "Ignora, não é problema seu.", pontos: 1 },
        { texto: "Reporta de forma anônima.", pontos: 2 }
      ]
    },
    {
      imagem: "quiz2.jpg",
      pergunta: "Seu melhor amigo está cometendo crimes digitais. Você:",
      opcoes: [
        { texto: "Encobre para protegê-lo.", pontos: 0 },
        { texto: "Confronta, mas não denuncia.", pontos: 1 },
        { texto: "Reporta ou tenta impedir.", pontos: 2 }
      ]
    },
    {
      imagem: "quiz3.jpg",
      pergunta: "Um sistema opressor censura a internet. Você:",
      opcoes: [
        { texto: "Invade e sabota servidores.", pontos: 2 },
        { texto: "Faz protesto pacífico online.", pontos: 1 },
        { texto: "Evita se envolver.", pontos: 0 }
      ]
    },
    {
      imagem: "quiz4.jpg",
      pergunta: "Te oferecem muito dinheiro para vazar dados de inocentes. Você:",
      opcoes: [
        { texto: "Aceita sem pensar.", pontos: 0 },
        { texto: "Recusa a oferta.", pontos: 2 },
        { texto: "Finge aceitar e avisa a vítima.", pontos: 1 }
      ]
    },
    {
      imagem: "quiz5.jpg",
      pergunta: "Você pode sabotar um político corrupto. Você:",
      opcoes: [
        { texto: "Expõe dados com provas reais.", pontos: 2 },
        { texto: "Divulga fakes para enfraquecer.", pontos: 0 },
        { texto: "Não se envolve com política.", pontos: 1 }
      ]
    },
    {
      imagem: "quiz6.jpg",
      pergunta: "Se fosse líder da Cyber-Nexis, seu foco seria:",
      opcoes: [
        { texto: "Poder e dominação digital.", pontos: 0 },
        { texto: "Educação e liberdade da informação.", pontos: 2 },
        { texto: "Proteção e sigilo absoluto.", pontos: 1 }
      ]
    },
    {
      imagem: "quiz7.jpg",
      pergunta: "Você vê injustiça social aumentada por tecnologia. Você:",
      opcoes: [
        { texto: "Cria soluções acessíveis para todos.", pontos: 2 },
        { texto: "Denuncia online com provas.", pontos: 1 },
        { texto: "Ignora, pois não é afetado.", pontos: 0 }
      ]
    },
    {
      imagem: "quiz8.jpg",
      pergunta: "Você tem acesso a um sistema de vigilância global. Você:",
      opcoes: [
        { texto: "Usa para monitorar e proteger.", pontos: 1 },
        { texto: "Divulga as falhas ao público.", pontos: 2 },
        { texto: "Usa para espionar rivais.", pontos: 0 }
      ]
    },
    {
      imagem: "quiz9.jpg",
      pergunta: "Se pudesse apagar todo histórico digital de alguém. Você:",
      opcoes: [
        { texto: "Usa como chantagem.", pontos: 0 },
        { texto: "Apaga para dar segunda chance.", pontos: 2 },
        { texto: "Venda para empresas.", pontos: 0 }
      ]
    },
    {
      imagem: "quiz10.jpg",
      pergunta: "O que significa 'ética hacker' para você?",
      opcoes: [
        { texto: "Quebrar regras por diversão.", pontos: 0 },
        { texto: "Usar o conhecimento com responsabilidade.", pontos: 2 },
        { texto: "Fazer o que for necessário.", pontos: 1 }
      ]
    }
  ];

  let indiceAtual = 0;
  let pontuacao = 0;

  function abrirQuiz() {
    indiceAtual = 0;
    pontuacao = 0;
    mostrarPerguntaQuiz();
    log("🧠 Iniciou Teste Psicológico");
  }

  function mostrarPerguntaQuiz() {
    const conteudo = document.getElementById("conteudo");
    const pergunta = perguntasQuiz[indiceAtual];

    let opcoesHtml = "";
    pergunta.opcoes.forEach((op, i) => {
      opcoesHtml += `<button onclick="responderQuiz(${op.pontos})">${op.texto}</button><br>`;
    });
   conteudo.innerHTML = `
      <h2>🧠 Teste Psicológico (${indiceAtual + 1}/10)</h2>
      <img src="${pergunta.imagem}" alt="Imagem Quiz" style="max-width:100%; border:1px solid lime; margin-bottom:10px;"><br>
      <p><strong>${pergunta.pergunta}</strong></p>
      ${opcoesHtml}
    `;
  }
function responderQuiz(pontos) {
  pontuacao += pontos;
  indiceAtual++;
  if (indiceAtual < perguntasQuiz.length) {
    mostrarPerguntaQuiz();
  } else {
    finalizarQuiz();
  }
}

// final do quiz
function finalizarQuiz() {
  let nivelFinal = "";
  if (pontuacao <= 3) {
    nivelFinal = "Observador";
  } else if (pontuacao <= 6) {
    nivelFinal = "Iniciado";
  } else if (pontuacao <= 8) {
    nivelFinal = "Operador";
  } else {
    nivelFinal = "Comandante";
  }

  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  usuarios[usuarioAtual.nome].nivel = nivelFinal;
  localStorage.setItem("usuarios", JSON.stringify(usuarios));
  usuarioAtual.nivel = nivelFinal;

  const conteudo = document.getElementById("conteudo");
  conteudo.innerHTML = `
    <h2>✅ Teste Finalizado</h2>
    <p>Você atingiu <strong>${pontuacao} ponto(s)</strong>.</p>
    <p>Nível atribuído: <strong>${nivelFinal}</strong></p>
  `;
  log(`🧠 Teste concluído — novo nível: ${nivelFinal}`);
}
  
</script>

<script>
  // ===== CRIPTOGRAFIA AES =====
  let chaveAES = null;

  function abrirCriptografia() {
    const conteudo = document.getElementById("conteudo");
    conteudo.innerHTML = `
      <h2>🔐 Criptografia AES (GCM)</h2>
      <button onclick="gerarChave()">🔑 Gerar Nova Chave</button><br><br>
      <label>Mensagem:</label><br>
      <textarea id="mensagem-cripto" rows="4"></textarea><br>
      <button onclick="criptografarAES()">Criptografar</button>
      <button onclick="descriptografarAES()">Descriptografar</button><br><br>
      <label>Resultado:</label><br>
      <textarea id="resultado-cripto" rows="4" readonly></textarea><br>
      <label>Chave AES (Base64):</label><br>
      <textarea id="chave-base64" rows="2" readonly></textarea>
    `;
    log("🔐 Acessou módulo de Criptografia");
  }

  async function gerarChave() {
    chaveAES = await crypto.subtle.generateKey({ name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]);
    const raw = await crypto.subtle.exportKey("raw", chaveAES);
    const base64 = btoa(String.fromCharCode(...new Uint8Array(raw)));
    document.getElementById("chave-base64").value = base64;
    log("🔑 Nova chave AES gerada");
  }

  async function criptografarAES() {
    const texto = document.getElementById("mensagem-cripto").value;
    if (!chaveAES) return alert("Gere a chave primeiro.");
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const dados = new TextEncoder().encode(texto);
    const cifrado = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, chaveAES, dados);
    const resultado = {
      iv: Array.from(iv),
      dados: Array.from(new Uint8Array(cifrado))
    };
    document.getElementById("resultado-cripto").value = btoa(JSON.stringify(resultado));
    log("🔒 Mensagem criptografada");
  }

  async function descriptografarAES() {
    const base64 = document.getElementById("resultado-cripto").value;
    if (!chaveAES) return alert("Gere a chave primeiro.");
    try {
      const obj = JSON.parse(atob(base64));
      const iv = new Uint8Array(obj.iv);
      const dados = new Uint8Array(obj.dados);
      const decifrado = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, chaveAES, dados);
      const texto = new TextDecoder().decode(decifrado);
      document.getElementById("mensagem-cripto").value = texto;
      log("🔓 Mensagem descriptografada");
    } catch {
      alert("❌ Erro na descriptografia.");
      log("⚠️ Falha na descriptografia");
    }
  }

  // ===== MENSAGENS SECRETAS COM TEMPO LIMITADO =====
function abrirMensagens() {
  const conteudo = document.getElementById("conteudo");
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");

  let opcoes = "";
  for (let nome in usuarios) {
    if (nome !== usuarioAtual.nome) {
      opcoes += `<option value="${nome}">${nome}</option>`;
    }
  }

  conteudo.innerHTML = `
    <h2>💬 Mensagens Secretas</h2>
    <h3>Enviar Mensagem</h3>
    <select id="destinatario">${opcoes}</select><br>
    <textarea id="mensagem-secreta" rows="4"></textarea><br>
    <label>Tempo de expiração (segundos):</label>
    <input type="number" id="tempo-expiracao" value="60" min="5" max="3600"><br>
    <button onclick="enviarMensagem()">Enviar</button>
    <h3>📥 Caixa de Entrada</h3>
    <div id="caixa-entrada"></div>
  `;

  exibirMensagens();
  log("💬 Acessou Mensagens Secretas");

  // Atualiza automaticamente a cada 5 segundos
  setInterval(() => {
    if (document.getElementById("caixa-entrada")) {
      exibirMensagens();
    }
  }, 5000);
}

function enviarMensagem() {
  const para = document.getElementById("destinatario").value;
  const texto = document.getElementById("mensagem-secreta").value.trim();
  const tempo = parseInt(document.getElementById("tempo-expiracao").value, 10) || 60;

  if (!texto) return alert("Digite uma mensagem!");
  if (tempo < 5) return alert("O tempo mínimo é 5 segundos.");

  const expiracao = Date.now() + tempo * 1000;
  const codificada = btoa(texto);
  const todas = JSON.parse(localStorage.getItem("mensagens") || "{}");
  if (!todas[para]) todas[para] = [];

  todas[para].push({
    de: usuarioAtual.nome,
    conteudo: codificada,
    data: new Date().toLocaleString(),
    expiracao
  });

  localStorage.setItem("mensagens", JSON.stringify(todas));
  document.getElementById("mensagem-secreta").value = "";
  alert(`Mensagem enviada! Ela será apagada automaticamente em ${tempo} segundos.`);
  log(`📨 Mensagem enviada para ${para}`);
  exibirMensagens();
}

function exibirMensagens() {
  const caixa = document.getElementById("caixa-entrada");
  const todas = JSON.parse(localStorage.getItem("mensagens") || "{}");
  const agora = Date.now();

  // Remove mensagens expiradas
  for (let usuario in todas) {
    todas[usuario] = todas[usuario].filter(msg => !msg.expiracao || msg.expiracao > agora);
  }
  localStorage.setItem("mensagens", JSON.stringify(todas));

  const mensagens = todas[usuarioAtual.nome] || [];
  if (mensagens.length === 0) {
    caixa.innerHTML = "<p>(Nenhuma mensagem recebida)</p>";
    return;
  }

  let html = "<ul>";
  mensagens.forEach((msg, i) => {
    const tempoRestante = Math.max(0, Math.floor((msg.expiracao - agora) / 1000));
    html += `
      <li>
        <strong>De:</strong> ${msg.de}<br>
        <strong>Data:</strong> ${msg.data}<br>
        <strong>Mensagem:</strong> ${atob(msg.conteudo)}<br>
        <em>⏱️ Expira em: ${tempoRestante}s</em>
      </li><hr>`;
  });
  html += "</ul>";
  caixa.innerHTML = html;
}

  // ===== OPERAÇÕES EM TEMPO REAL =====
  let operacoes = JSON.parse(localStorage.getItem("operacoes") || "[]");

  function abrirOperacoes() {
    const conteudo = document.getElementById("conteudo");
    conteudo.innerHTML = `
      <h2>🛰️ Operações ao Vivo</h2>
      <button onclick="novaOperacao()">➕ Nova Operação</button>
      <div id="lista-operacoes"></div>`;
    exibirOperacoes();
    log("🎯 Acessou Operações ao Vivo");
  }

  function novaOperacao() {
    const nome = prompt("Nome da nova operação:");
    if (!nome) return;
    const nova = {
      id: Date.now(),
      nome,
      criador: usuarioAtual.nome,
      status: "Ativa",
      eventos: [
        { hora: new Date().toLocaleTimeString(), descricao: `🔃 Operação '${nome}' iniciada por ${usuarioAtual.nome}` }
      ]
    };
    operacoes.push(nova);
    localStorage.setItem("operacoes", JSON.stringify(operacoes));
    exibirOperacoes();
    log(`➕ Nova operação: ${nome}`);
  }

  function exibirOperacoes() {
    const area = document.getElementById("lista-operacoes");
    if (operacoes.length === 0) {
      area.innerHTML = "<p>(Nenhuma operação ativa)</p>";
      return;
    }

    area.innerHTML = "";
    operacoes.forEach(op => {
      area.innerHTML += `
        <div style="border:1px solid lime; padding:10px; margin:10px;">
          <h3>🛰️ ${op.nome}</h3>
          <p><strong>Criador:</strong> ${op.criador} | <strong>Status:</strong> ${op.status}</p>
          <div id="linha-${op.id}" style="background:#000; padding:5px; border:1px solid #0f0; max-height:150px; overflow:auto;">
            ${op.eventos.map(e => `<p>🕒 ${e.hora} - ${e.descricao}</p>`).join("")}
          </div>
          <textarea id="input-${op.id}" rows="2" cols="50" placeholder="Atualizar operação..."></textarea><br>
          <button onclick="atualizarOperacao(${op.id})">➤ Atualizar</button>
          <button onclick="encerrarOperacao(${op.id})">🛑 Encerrar</button>
        </div>`;
    });
  }

  function atualizarOperacao(id) {
    const index = operacoes.findIndex(op => op.id === id);
    const texto = document.getElementById(`input-${id}`).value.trim();
    if (!texto) return;

    const evento = {
      hora: new Date().toLocaleTimeString(),
      descricao: `${usuarioAtual.nome}: ${texto}`
    };

    operacoes[index].eventos.push(evento);
    localStorage.setItem("operacoes", JSON.stringify(operacoes));
    exibirOperacoes();
    log(`📡 Operação ${operacoes[index].nome} atualizada`);
  }

  function encerrarOperacao(id) {
    const index = operacoes.findIndex(op => op.id === id);
    operacoes[index].status = "Encerrada";
    operacoes[index].eventos.push({
      hora: new Date().toLocaleTimeString(),
      descricao: `🛑 Operação encerrada por ${usuarioAtual.nome}`
    });
    localStorage.setItem("operacoes", JSON.stringify(operacoes));
    exibirOperacoes();
    log(`🛑 Operação encerrada: ${operacoes[index].nome}`);
  }

  // ===== PAINEL DO LÍDER SUPREMO =====
  function abrirAdmin() {
    if (!usuarioAtual || usuarioAtual.nivel !== "Líder Supremo") {
      alert("⛔ Acesso restrito ao Líder Supremo.");
      log("🚫 Tentativa de acesso não autorizada ao Painel do Líder");
      return;
    }

const conteudo = document.getElementById("conteudo");
    const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");

    let lista = "";
    for (let nome in usuarios) {
      lista += `
        <li>
          👤 ${nome} — ${usuarios[nome].nivel}
          <button onclick="removerUsuario('${nome}')">🗑️</button>
          <button onclick="promoverUsuario('${nome}')">⬆️</button>
        </li>
      `;
    }
    
    conteudo.innerHTML = `
      <h2>👑 Painel Administrativo - Líder Supremo</h2>
      <h3>🌍 Histórico de Localizações</h3>
<div id="historico-local"></div>
      <h3>🕵️ Agentes Registrados</h3>
      <ul>${lista}</ul>
      <hr>
      <h3>⚙️ Controles Globais</h3>
      <button onclick="limparTudo()">🧨 Resetar Sistema</button>
      <button onclick="limparLogs()">🧹 Limpar Logs Visuais</button>
    `;
    log("👑 Líder Supremo acessou o Painel Administrativo");
  }

  function removerUsuario(nome) {
    if (confirm(`Deseja remover o agente ${nome}?`)) {
      const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
      delete usuarios[nome];
      localStorage.setItem("usuarios", JSON.stringify(usuarios));
      log(`❌ Agente ${nome} removido`);
      abrirAdmin(); // Recarrega
    }
  }

function mostrarHistoricoLocal() {
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  let html = "<ul>";
  for (let nome in usuarios) {
    if (usuarios[nome].historicoLocais) {
      html += `<li><strong>${nome}</strong><ul>`;
      usuarios[nome].historicoLocais.forEach(loc => {
        html += `<li>📍 ${loc.cidade}, ${loc.pais} — ${loc.data} (±${loc.precisao}m)</li>`;
      });
      html += "</ul></li>";
    }
  }
  html += "</ul>";
  document.getElementById("historico-local").innerHTML = html;
}
  function promoverUsuario(nome) {
    const novoNivel = prompt(`Digite o novo nível para ${nome} (ex: Operador, Comandante):`);
    if (!novoNivel) return;
    const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
    usuarios[nome].nivel = novoNivel;
    localStorage.setItem("usuarios", JSON.stringify(usuarios));
    log(`⬆️ Agente ${nome} promovido para ${novoNivel}`);
    abrirAdmin(); // Recarrega
  }

  function limparTudo() {
    if (confirm("⚠️ Isso apagará TODOS os dados da Cyber-Nexis. Tem certeza?")) {
      localStorage.clear();
      log("🧨 Sistema foi resetado pelo Líder Supremo");
      alert("Sistema reiniciado. Recarregue a página.");
      location.reload();
    }
  }

  function limparLogs() {
    document.getElementById("log-list").innerHTML = "";
    log("🧹 Logs visuais foram apagados");
  }
  
// ===== UTILITÁRIOS =====
function getPastas() {
  return JSON.parse(localStorage.getItem("pastas") || "{}");
}

function setPastas(pastas) {
  localStorage.setItem("pastas", JSON.stringify(pastas));
}

function logAcao(mensagem) {
  const logList = document.getElementById("log-list");
  const li = document.createElement("li");
  li.textContent = `${new Date().toLocaleTimeString()} - ${mensagem}`;
  logList.appendChild(li);
}

// ===== ABRIR PASTAS =====
function abrirPastas() {
  const conteudo = document.getElementById("conteudo");
  const pastas = getPastas();

  let listaPastas = "";
  for (let nome in pastas) {
    listaPastas += `
      <li>
        ${nome} 
        <button onclick="abrirPasta('${nome}')">Abrir</button>
        <button onclick="removerPasta('${nome}')">🗑️ Apagar</button>
      </li>`;
  }

  conteudo.innerHTML = `
    <h2>📁 Pastas Seguras</h2>
    <h3>Criar Nova Pasta</h3>
    <input type="text" id="nova-pasta-nome" placeholder="Nome da pasta"><br>
    <input type="password" id="nova-pasta-senha" placeholder="Senha da pasta"><br>
    <button onclick="criarPasta()">Criar Pasta</button>
    <hr>
    <h3>Pastas Existentes</h3>
    <ul>${listaPastas || "<p>(Nenhuma pasta criada)</p>"}</ul>
    <div id="area-pasta"></div>
  `;
}

// ===== CRIAR PASTA =====
// ===== LIMITES DE ARQUIVOS =====
const LIMITE_ARQUIVOS_PASTA = 10;   // máximo por pasta
const LIMITE_ARQUIVOS_GLOBAL = 50;  // máximo global
const LIMITE_EXPORTACAO = 5;        // máximo para exportar de uma vez
function criarPasta() {
  const nome = document.getElementById("nova-pasta-nome").value.trim();
  const senha = document.getElementById("nova-pasta-senha").value;

  if (!nome || !senha) return alert("Preencha nome e senha!");

  const pastas = getPastas();
  if (pastas[nome]) return alert("Pasta já existe!");

  pastas[nome] = { senha, arquivos: {} };
  setPastas(pastas);
  alert(`Pasta "${nome}" criada com sucesso!`);
  abrirPastas();
  logAcao(`Pasta "${nome}" criada.`);
}

// ===== ABRIR PASTA =====
function abrirPasta(nome) {
  const senha = prompt(`Digite a senha da pasta "${nome}":`);
  if (!senha) return;

  const pastas = getPastas();
  if (!pastas[nome]) return alert("Pasta não encontrada!");
  if (pastas[nome].senha !== senha) return alert("Senha incorreta!");

  mostrarConteudoPasta(nome, pastas[nome]);
  logAcao(`Pasta "${nome}" aberta.`);
}

// ===== MOSTRAR CONTEÚDO DA PASTA =====
function mostrarConteudoPasta(nome, pasta) {
  const area = document.getElementById("area-pasta");

  // Ordenar arquivos por nome
  const arquivosOrdenados = Object.keys(pasta.arquivos).sort();

  let listaArquivos = "";
  arquivosOrdenados.forEach(arquivo => {
    listaArquivos += `
      <li>
        ${arquivo} 
        <button onclick="editarArquivo('${nome}','${arquivo}')">✏️ Editar</button>
        <button onclick="baixarArquivo('${arquivo}', '${pasta.arquivos[arquivo]}')">⬇️ Baixar</button>
        <button onclick="removerArquivo('${nome}','${arquivo}')">🗑️ Apagar</button>
      </li>`;
  });

  area.innerHTML = `
    <h3>📂 Pasta: ${nome}</h3>
    <button onclick="exportarArquivos('${nome}')">📤 Exportar Arquivos</button>

    <h4>Criar Arquivo de Texto</h4>
    <input type="text" id="novo-arquivo-nome" placeholder="Nome do arquivo"><br>
    <textarea id="novo-arquivo-conteudo" rows="4" placeholder="Conteúdo"></textarea><br>
    <button onclick="criarArquivo('${nome}')">Salvar Arquivo</button>

    <h4>📤 Upload de Arquivo</h4>
    <input type="file" id="upload-arquivo"><br>
    <div id="drop-area" style="border:2px dashed lime; padding:20px; margin-top:10px; text-align:center;">
      Arraste arquivos aqui
    </div>
    <button onclick="uploadArquivo('${nome}')">Enviar Arquivo</button>

    <hr>
    <h4>Arquivos Existentes</h4>
    <ul>${listaArquivos || "<p>(Nenhum arquivo)</p>"}</ul>

    <div id="preview-arquivo"></div>
  `;

  // Drag & Drop
  const dropArea = document.getElementById("drop-area");
  dropArea.addEventListener("dragover", e => { e.preventDefault(); dropArea.style.background="#222"; });
  dropArea.addEventListener("dragleave", e => { dropArea.style.background=""; });
  dropArea.addEventListener("drop", e => {
    e.preventDefault();
    const arquivos = e.dataTransfer.files;
    handleUploadFiles(nome, arquivos);
  });
}

// ===== CRIAR ARQUIVO DE TEXTO =====
function criarArquivo(nomePasta) {
  const arquivo = document.getElementById("novo-arquivo-nome").value.trim();
  const conteudo = document.getElementById("novo-arquivo-conteudo").value;

  if (!arquivo) return alert("Digite o nome do arquivo!");

  const pastas = getPastas();
  pastas[nomePasta] = pastas[nomePasta] || { arquivos: {} };

  // Conta total global
  let totalArquivos = 0;
  for (let p in pastas) {
    totalArquivos += Object.keys(pastas[p].arquivos || {}).length;
  }

  // Verifica limite global
  if (totalArquivos >= LIMITE_ARQUIVOS_GLOBAL) {
    alert("⛔ Limite global de arquivos atingido!");
    return;
  }

  // Verifica limite da pasta
  if (Object.keys(pastas[nomePasta].arquivos).length >= LIMITE_ARQUIVOS_PASTA) {
    alert(`⛔ A pasta "${nomePasta}" já atingiu o limite de ${LIMITE_ARQUIVOS_PASTA} arquivos!`);
    return;
  }

  pastas[nomePasta].arquivos[arquivo] = btoa(conteudo);
  setPastas(pastas);

  alert(`Arquivo "${arquivo}" salvo!`);
  abrirPasta(nomePasta);
  logAcao(`Arquivo "${arquivo}" criado na pasta "${nomePasta}".`);
}

// ===== EDITAR ARQUIVO =====
function editarArquivo(nomePasta, arquivo) {
  const pastas = getPastas();
  const conteudo = atob(pastas[nomePasta].arquivos[arquivo]);

  const novoConteudo = prompt(`Editar arquivo "${arquivo}":`, conteudo);
  if (novoConteudo === null) return;

  pastas[nomePasta].arquivos[arquivo] = btoa(novoConteudo);
  setPastas(pastas);
  alert(`Arquivo "${arquivo}" atualizado!`);
  abrirPasta(nomePasta);
  logAcao(`Arquivo "${arquivo}" editado na pasta "${nomePasta}".`);
}

// ===== DOWNLOAD DE ARQUIVO =====
function baixarArquivo(nomeArquivo, dataBase64) {
  const conteudo = atob(dataBase64);
  const blob = new Blob([conteudo], { type: "application/octet-stream" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = nomeArquivo;
  a.click();
  URL.revokeObjectURL(url);

  logAcao(`Arquivo "${nomeArquivo}" baixado.`);
}

// ===== EXPORTAR ARQUIVOS DA PASTA =====
function exportarArquivos(nomePasta) {
  const pastas = getPastas();
  if (!pastas[nomePasta]) return alert("⛔ Pasta não encontrada");

  const arquivos = Object.keys(pastas[nomePasta].arquivos || {});

  // Verifica limite de exportação
  if (arquivos.length > LIMITE_EXPORTACAO) {
    alert(`⚠️ Só é permitido exportar até ${LIMITE_EXPORTACAO} arquivos por vez.`);
    return;
  }

  const blob = new Blob([JSON.stringify(pastas[nomePasta].arquivos, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `export_${nomePasta}_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);

  logAcao(`📤 Exportando ${arquivos.length} arquivos da pasta "${nomePasta}"`);
}

// ===== REMOVER ARQUIVO =====
function removerArquivo(nomePasta, arquivo) {
  if (!confirm(`Apagar arquivo "${arquivo}"?`)) return;

  const pastas = getPastas();
  delete pastas[nomePasta].arquivos[arquivo];
  setPastas(pastas);
  abrirPasta(nomePasta);
  logAcao(`Arquivo "${arquivo}" removido da pasta "${nomePasta}".`);
}

// ===== REMOVER PASTA =====
function removerPasta(nome) {
  if (!confirm(`Apagar pasta "${nome}" e todos os arquivos?`)) return;

  const pastas = getPastas();
  delete pastas[nome];
  setPastas(pastas);
  abrirPastas();
  logAcao(`Pasta "${nome}" removida.`);
}

// ===== UPLOAD DE ARQUIVOS =====
function uploadArquivo(nomePasta) {
  const fileInput = document.getElementById("upload-arquivo");
  if (fileInput.files.length === 0) return alert("Selecione um arquivo!");
  handleUploadFiles(nomePasta, fileInput.files);
}

// ===== HANDLER DE UPLOAD =====
function handleUploadFiles(nomePasta, arquivos) {
  const pastas = getPastas();
  Array.from(arquivos).forEach(file => {
    if (file.size > 2 * 1024 * 1024) return alert(`Arquivo "${file.name}" excede 2MB!`);
    const allowed = ['image/png','image/jpeg','text/plain','application/pdf'];
    if (!allowed.includes(file.type)) return alert(`Tipo de arquivo "${file.type}" não permitido: ${file.name}`);

    const reader = new FileReader();
    reader.onload = function(e) {
      pastas[nomePasta].arquivos[file.name] = e.target.result;
      setPastas(pastas);
      abrirPasta(nomePasta);
      logAcao(`Arquivo "${file.name}" enviado para pasta "${nomePasta}".`);
    };
    reader.readAsDataURL(file);
  });
}

function notificarSistema(mensagem) {
  const area = document.getElementById("conteudo"); // ou outra div de notificações
  const div = document.createElement("div");
  div.textContent = mensagem;
  div.classList.add("log-item"); // mesmo estilo de terminal
  area.prepend(div); // adiciona no topo da área
}

function mostrarMapa(lat, lon, cidade, pais) {
  const conteudo = document.getElementById("conteudo");
  conteudo.innerHTML = `
    <h2>🌍 Localização Atual</h2>
    <p>📍 ${cidade}, ${pais}</p>
    <div id="mapa" style="height:400px; border:1px solid lime; margin-top:10px;"></div>
  `;

  const mapa = L.map('mapa').setView([lat, lon], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(mapa);

  L.marker([lat, lon]).addTo(mapa)
    .bindPopup(`Agente ${usuarioAtual.nome}<br>${cidade}, ${pais}`)
    .openPopup();
}

function abrirSetor(idSetor) {
  const setores = JSON.parse(localStorage.getItem("setores") || "{}");
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");

  // Verifica se existe comandante registrado
  if (!setores[idSetor]) {
    alert("⚠️ Ainda não existe comandante para este setor.");
    log(`🚫 Tentativa de acesso ao setor ${idSetor} sem comandante.`);
    return;
  }

  // Verifica se usuário tem permissão
  if (
    usuarioAtual.nome !== setores[idSetor] &&
    usuarioAtual.nivel !== "Líder Supremo"
  ) {
    alert("⛔ Acesso negado. Apenas o comandante deste setor ou o Líder Supremo podem acessar.");
    log(`🚫 Acesso negado ao setor ${idSetor} por ${usuarioAtual.nome}`);
    return;
  }

  // Nome bonito para cada setor
  const nomesSetores = {
    seguranca_info: "🔒 Divisão de Segurança da Informação",
    psicologia: "🧠 Divisão de Psicologia Estratégica",
    contra_inteligencia: "🎭 Divisão Contra-Inteligência",
    financas: "💰 Divisão de Finanças Secretas",
    operacao_campo: "🛰️ Divisão de Operação de Campo",
    ia_estrategica: "🤖 Divisão de IA Estratégica & Deep Learning"
  };
  
  if (idSetor === "psicologia") {
  document.getElementById("acoes-psicologia").innerHTML = `
    <h3>🧠 Ferramentas de Psicologia Estratégica</h3>
    <button onclick="listarPerfis()">📊 Ver Perfis Psicológicos</button>
    <button onclick="avaliarRisco()">⚠️ Avaliar Risco dos Agentes</button>
    <button onclick="mensagemSubliminar()">💭 Enviar Mensagem Subliminar</button>
    <button onclick="controleMoral()">📈 Controle de Moral</button>
    <div id="resultado-psicologia" style="margin-top:10px;"></div>
  `;
}
 
if (idSetor === "financas") {
  document.getElementById("acoes-financas").innerHTML = `
    <h3>💰 Ferramentas de Finanças Secretas</h3>
    <button onclick="mostrarSaldos()">📊 Cofre Virtual</button>
    <button onclick="transferirCreditos()">💸 Transferir Créditos</button>
    <button onclick="auditoriaFinanceira()">📜 Auditoria de Transações</button>
    <button onclick="depositoPIX()">⚡ Depositar via PIX</button>
    <button onclick="depositoBTC()">₿ Depositar via Bitcoin</button>
    <div id="resultado-financas" style="margin-top:10px;"></div>
  `;
}

if (idSetor === "operacao_campo") {
  document.getElementById("acoes-operacao_campo").innerHTML = `
    <h3>🛰️ Ferramentas de Operação de Campo</h3>
    <button onclick="criarMissao()">🎯 Criar Nova Missão</button>
    <button onclick="listarMissoes()">📋 Listar Missões</button>
    <button onclick="mapaMissoes()">🗺️ Mostrar no Mapa</button>
    <button onclick="atualizarStatusMissao()">⚡ Atualizar Status</button>
    <div id="resultado-operacao" style="margin-top:10px;"></div>
    <div id="mapa-missoes" style="height:400px; margin-top:10px;"></div>
  `;
}

if (idSetor === "ia_estrategica") {
  document.getElementById("acoes-ia_estrategica").innerHTML = `
    <h3>🤖 Ferramentas de IA Estratégica</h3>
    <button onclick="analisarLogsGlobais()">📊 Analisar Logs Globais</button>
    <button onclick="detectarRiscoEstrategico()">⚠️ Detectar Risco Estratégico</button>
    <button onclick="previsaoOperacoes()">📈 Previsão de Operações</button>
    <button onclick="gerarRelatorioEstrategico()">📝 Gerar Relatório Estratégico</button>
    <div id="resultado-ia" style="margin-top:10px;"></div>
  `;
}

  // Exibir painel
  const conteudo = document.getElementById("conteudo");
  conteudo.innerHTML = `
    <h2>${nomesSetores[idSetor]}</h2>
    <p>👤 Comandante responsável: <strong>${setores[idSetor]}</strong></p>
    <div id="logs-${idSetor}" style="border:1px solid lime; padding:10px; margin-top:10px; background:#000; height:200px; overflow:auto;"></div>
    <div id="acoes-${idSetor}" style="margin-top:15px;">
      <p>(Ferramentas específicas desta divisão aparecerão aqui)</p>
    </div>
  `;

  logSetor(idSetor, `✅ ${usuarioAtual.nome} acessou o painel administrativo`);
}

function logSetor(setorId, mensagem) {
  const key = `logs_${setorId}`;
  const logs = JSON.parse(localStorage.getItem(key) || "[]");
  logs.push(`${new Date().toLocaleTimeString()} - ${mensagem}`);
  localStorage.setItem(key, JSON.stringify(logs));

  // Exibir se o painel estiver aberto
  const area = document.getElementById(`logs-${setorId}`);
  if (area) {
    area.innerHTML = logs.map(l => `<div class="log-item">${l}</div>`).join("");
    area.scrollTop = area.scrollHeight; // auto-scroll
  }
}

// ======= DIVISÃO DE SEGURANÇA DA INFORMAÇÃO =======

// 1. Monitor de Incidentes
function registrarIncidente() {
  const descricao = prompt("Descreva o incidente detectado:");
  if (!descricao) return;
  logSetor("seguranca_info", `⚠️ Incidente registrado: ${descricao}`);
  document.getElementById("resultado-seguranca").innerHTML =
    `<p style="color:yellow">⚠️ Incidente registrado: ${descricao}</p>`;
}

// 2. Gerenciamento de Chaves AES
function gerarChaveSeguranca() {
  crypto.subtle.generateKey({ name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"])
    .then(async chave => {
      const raw = await crypto.subtle.exportKey("raw", chave);
      const base64 = btoa(String.fromCharCode(...new Uint8Array(raw)));
      const chaves = JSON.parse(localStorage.getItem("chavesAES") || "[]");
      chaves.push(base64);
      localStorage.setItem("chavesAES", JSON.stringify(chaves));
      logSetor("seguranca_info", "🔑 Nova chave AES gerada.");
      listarChaves();
    });
}

function listarChaves() {
  const chaves = JSON.parse(localStorage.getItem("chavesAES") || "[]");
  const area = document.getElementById("resultado-seguranca");
  if (chaves.length === 0) {
    area.innerHTML = "<p>(Nenhuma chave registrada)</p>";
    return;
  }
  let html = "<h4>🔑 Chaves AES Ativas</h4><ul>";
  chaves.forEach((chave, i) => {
    html += `<li>${chave.substring(0,20)}... 
      <button onclick="revogarChave(${i})">🗑️ Revogar</button></li>`;
  });
  html += "</ul>";
  area.innerHTML = html;
}

function revogarChave(index) {
  let chaves = JSON.parse(localStorage.getItem("chavesAES") || "[]");
  if (!chaves[index]) return;
  if (confirm("Revogar esta chave?")) {
    chaves.splice(index, 1);
    localStorage.setItem("chavesAES", JSON.stringify(chaves));
    logSetor("seguranca_info", "🗑️ Uma chave AES foi revogada.");
    listarChaves();
  }
}

// 3. Simulação de Ataque
function simularAtaque() {
  logSetor("seguranca_info", "🚨 ALERTA: Tentativa de invasão detectada!");
  document.getElementById("resultado-seguranca").innerHTML =
    `<p style="color:red">🚨 Simulação: Tentativa de invasão detectada!</p>`;
}

// 4. Scanner Interno
function scannerInterno() {
  const pastas = JSON.parse(localStorage.getItem("pastas") || "{}");
  let vulneraveis = [];
  for (let nome in pastas) {
    if (!pastas[nome].senha || pastas[nome].senha.trim() === "") {
      vulneraveis.push(nome);
    }
  }
  if (vulneraveis.length === 0) {
    document.getElementById("resultado-seguranca").innerHTML =
      "<p style='color:lime'>✅ Nenhuma vulnerabilidade encontrada.</p>";
    logSetor("seguranca_info", "🔍 Scanner concluído — nenhuma falha encontrada.");
  } else {
    document.getElementById("resultado-seguranca").innerHTML =
      `<p style="color:orange">⚠️ Pastas vulneráveis: ${vulneraveis.join(", ")}</p>`;
    logSetor("seguranca_info", `⚠️ Scanner encontrou pastas vulneráveis: ${vulneraveis.join(", ")}`);
  }
}

// ======= DIVISÃO DE PSICOLOGIA ESTRATÉGICA =======

// 1. Listar perfis psicológicos (baseado no quiz)
function listarPerfis() {
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  let html = "<h4>📊 Perfis Psicológicos</h4><ul>";
  for (let nome in usuarios) {
    html += `<li>${nome} — Perfil: ${usuarios[nome].perfil || "❓ Não definido"}</li>`;
  }
  html += "</ul>";
  document.getElementById("resultado-psicologia").innerHTML = html;
  logSetor("psicologia", "📊 Listagem de perfis psicológicos exibida.");
}

// 2. Avaliação de risco
function avaliarRisco() {
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  let html = "<h4>⚠️ Avaliação de Risco</h4><ul>";
  for (let nome in usuarios) {
    const perfil = usuarios[nome].perfil || "indefinido";
    let risco = "✅ Estável";
    if (perfil.includes("sombrio")) risco = "🚨 Crítico";
    else if (perfil.includes("neutro")) risco = "⚠️ Instável";
    html += `<li>${nome} — ${risco}</li>`;
  }
  html += "</ul>";
  document.getElementById("resultado-psicologia").innerHTML = html;
  logSetor("psicologia", "⚠️ Avaliação de risco realizada.");
}

// 3. Mensagens subliminares
function mensagemSubliminar() {
  const usuario = prompt("Enviar mensagem subliminar para qual agente?");
  const msg = prompt("Digite a mensagem subliminar:");
  if (!usuario || !msg) return;
  logSetor("psicologia", `💭 Mensagem subliminar enviada para ${usuario}`);
  const area = document.getElementById("resultado-psicologia");
  area.innerHTML = `<p style="color:cyan">💭 ${usuario} recebeu: "${msg}"</p>`;
  setTimeout(() => {
    area.innerHTML = "<p style='color:gray'>(Mensagem subliminar expirada)</p>";
  }, 5000);
}

// 4. Controle de moral
function controleMoral() {
  const usuario = prompt("Controle de moral — Qual agente?");
  const valor = parseInt(prompt("Digite o novo nível de moral (0 a 100):"), 10);
  if (!usuario || isNaN(valor)) return;

  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  if (!usuarios[usuario]) {
    alert("Agente não encontrado!");
    return;
  }

  usuarios[usuario].moral = Math.max(0, Math.min(100, valor));
  localStorage.setItem("usuarios", JSON.stringify(usuarios));
  logSetor("psicologia", `📈 Moral de ${usuario} ajustada para ${valor}.`);
  document.getElementById("resultado-psicologia").innerHTML =
    `<p>📈 Moral de ${usuario} agora é ${valor}.</p>`;
}

// ======= DIVISÃO DE CONTRA-INTELIGÊNCIA =======

// 1. Verificação de Logs Suspeitos
function verificarLogsSuspeitos() {
  const logs = JSON.parse(localStorage.getItem("logs_contra_inteligencia") || "[]");
  if (logs.length === 0) {
    document.getElementById("resultado-contra").innerHTML =
      "<p>✅ Nenhum acesso suspeito registrado.</p>";
  } else {
    document.getElementById("resultado-contra").innerHTML =
      "<h4>📜 Logs Suspeitos</h4><ul>" +
      logs.map(l => `<li>${l}</li>`).join("") + "</ul>";
  }
  logSetor("contra_inteligencia", "📜 Verificação de logs realizada.");
}

// 2. Rastrear Comportamento
function rastrearComportamento() {
  const logs = JSON.parse(localStorage.getItem("logs_contra_inteligencia") || "[]");
  let contador = {};
  logs.forEach(l => {
    const match = l.match(/por (\w+)/);
    if (match) {
      const user = match[1];
      contador[user] = (contador[user] || 0) + 1;
    }
  });

  let html = "<h4>👀 Rastreio de Tentativas</h4><ul>";
  for (let u in contador) {
    html += `<li>${u} — ${contador[u]} tentativas</li>`;
  }
  html += "</ul>";

  document.getElementById("resultado-contra").innerHTML = html;
  logSetor("contra_inteligencia", "👀 Rastreamento de comportamento executado.");
}

// 3. Armadilha Digital
function armadilhaDigital() {
  const pastas = JSON.parse(localStorage.getItem("pastas") || "{}");
  const fakeName = "TOP_SECRET_" + Math.floor(Math.random() * 1000);
  pastas[fakeName] = { senha: "", fake: true };
  localStorage.setItem("pastas", JSON.stringify(pastas));
  logSetor("contra_inteligencia", `🪤 Armadilha criada: ${fakeName}`);
  document.getElementById("resultado-contra").innerHTML =
    `<p>🪤 Armadilha digital criada: ${fakeName}</p>`;
}

// 4. Detector de Identidades Duplicadas
function detectarDuplicidade() {
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  let frases = {};
  let duplicados = [];

  for (let nome in usuarios) {
    const frase = usuarios[nome].frase || "";
    if (frases[frase]) {
      duplicados.push(`${nome} e ${frases[frase]} usam a mesma frase de segurança`);
    } else {
      frases[frase] = nome;
    }
  }

  if (duplicados.length === 0) {
    document.getElementById("resultado-contra").innerHTML =
      "<p>✅ Nenhuma identidade duplicada encontrada.</p>";
  } else {
    document.getElementById("resultado-contra").innerHTML =
      "<h4>🕵️ Identidades Duplicadas</h4><ul>" +
      duplicados.map(d => `<li>${d}</li>`).join("") + "</ul>";
  }

  logSetor("contra_inteligencia", "🕵️ Detector de identidades duplicadas executado.");
}

async function depositoPIX() {
  const paraUser = prompt("ID do agente que vai receber (número):");
  const valor = parseInt(prompt("Valor (centavos):"), 10);
  const r = await fetch("http://localhost:8080/api/pix/charge", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ paraUser: Number(paraUser), valorCentavos: valor })
  });
  const j = await r.json();
  document.getElementById("resultado-financas").innerHTML =
    `<p>TXID: ${j.txid}</p><p>PIX Copia e Cola:</p><textarea>${j.copia_cola}</textarea>`;
}

async function depositoBTC() {
  const paraUser = prompt("ID do agente que vai receber (número):");
  const valorUSD = parseFloat(prompt("Valor (USD):"));
  const r = await fetch("http://localhost:8080/api/btc/charge", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ paraUser: Number(paraUser), valorUSD })
  });
  const j = await r.json();
  document.getElementById("resultado-financas").innerHTML =
    `<p>Abra para pagar em BTC:</p><a href="${j.url}" target="_blank">${j.url}</a>`;
}

// ======= DIVISÃO DE OPERAÇÃO DE CAMPO =======

// Criar missão
function criarMissao() {
  const titulo = prompt("Título da missão:");
  const local = prompt("Local da missão (ex: São Paulo - SP):");
  const agentes = prompt("Agentes envolvidos (separados por vírgula):");
  const lat = parseFloat(prompt("Latitude do local:"));
  const lng = parseFloat(prompt("Longitude do local:"));

  if (!titulo || !local || !lat || !lng) {
    alert("❌ Informações insuficientes para criar missão!");
    return;
  }

  const missoes = JSON.parse(localStorage.getItem("missoes") || "[]");
  const id = "M" + String(missoes.length + 1).padStart(3, "0");

  const nova = {
    id,
    titulo,
    local,
    coordenadas: [lat, lng],
    agentes: agentes.split(",").map(a => a.trim()),
    status: "ativa",
    criadoEm: new Date().toISOString()
  };

  missoes.push(nova);
  localStorage.setItem("missoes", JSON.stringify(missoes));

  document.getElementById("resultado-operacao").innerHTML =
    `<p>✅ Missão criada: <strong>${nova.titulo}</strong> (${nova.id})</p>`;
  logSetor("operacao_campo", `🎯 Missão criada: ${nova.titulo} (${nova.id})`);
}

// Listar missões
function listarMissoes() {
  const missoes = JSON.parse(localStorage.getItem("missoes") || "[]");
  if (missoes.length === 0) {
    document.getElementById("resultado-operacao").innerHTML =
      "<p>📭 Nenhuma missão registrada.</p>";
    return;
  }

  let html = "<h4>📋 Missões Registradas</h4><ul>";
  missoes.forEach(m => {
    html += `<li>${m.id} — ${m.titulo} | ${m.local} | Status: ${m.status} | Agentes: ${m.agentes.join(", ")}</li>`;
  });
  html += "</ul>";

  document.getElementById("resultado-operacao").innerHTML = html;
  logSetor("operacao_campo", "📋 Listagem de missões exibida.");
}

// Mostrar no mapa
function mapaMissoes() {
  const missoes = JSON.parse(localStorage.getItem("missoes") || "[]");
  if (missoes.length === 0) {
    alert("⚠️ Nenhuma missão cadastrada!");
    return;
  }

  const divMapa = document.getElementById("mapa-missoes");
  divMapa.innerHTML = ""; // limpar
  const mapa = L.map(divMapa).setView(missoes[0].coordenadas, 5);

  function mapaMissoes() {
  const divMapa = document.getElementById("mapa-missoes");
  divMapa.innerHTML = ""; // limpa antes de recarregar

  // Inicia o mapa
  var mapa = L.map("mapa-missoes").setView([-15.7801, -47.9292], 4);

  // Camada base do mapa (OpenStreetMap)
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> colaboradores'
  }).addTo(mapa);

  // Recupera missões do localStorage
  const missoes = JSON.parse(localStorage.getItem("missoes") || "[]");

  missoes.forEach(m => {
    if (m.local && m.local.lat && m.local.lng) {
      L.marker([m.local.lat, m.local.lng])
        .addTo(mapa)
        .bindPopup(`<b>${m.nome}</b><br>Status: ${m.status}`);
    }
  });
}

  missoes.forEach(m => {
    L.marker(m.coordenadas).addTo(mapa)
      .bindPopup(`<b>${m.titulo}</b><br>${m.local}<br>Status: ${m.status}`);
  });
<!--  -->
  logSetor("operacao_campo", "🗺️ Mapa de missões exibido.");
}

// Atualizar status da missão
function atualizarStatusMissao() {
  const id = prompt("Digite o ID da missão (ex: M001):");
  const status = prompt("Novo status (ativa, concluida, falha):");
  if (!id || !status) return;

  const missoes = JSON.parse(localStorage.getItem("missoes") || "[]");
  const missao = missoes.find(m => m.id === id);
  if (!missao) {
    alert("❌ Missão não encontrada!");
    return;
  }

  missao.status = status;
  localStorage.setItem("missoes", JSON.stringify(missoes));

  document.getElementById("resultado-operacao").innerHTML =
    `<p>⚡ Missão ${id} atualizada para <strong>${status}</strong>.</p>`;
  logSetor("operacao_campo", `⚡ Missão ${id} atualizada para ${status}.`);
}

// ======= DIVISÃO DE IA ESTRATÉGICA & DEEP LEARNING =======

// 1. Analisar logs globais
function analisarLogsGlobais() {
  const setores = ["seguranca_info","psicologia","contra_inteligencia","financas","operacao_campo","ia_estrategica"];
  let html = "<h4>📊 Análise de Logs Globais</h4><ul>";

  setores.forEach(s => {
    const logs = JSON.parse(localStorage.getItem("logs_" + s) || "[]");
    html += `<li>${s}: ${logs.length} eventos registrados</li>`;
  });

  html += "</ul>";
  document.getElementById("resultado-ia").innerHTML = html;
  logSetor("ia_estrategica", "📊 Logs globais analisados.");
}

// 2. Detectar risco estratégico
function detectarRiscoEstrategico() {
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  let risco = [];

  for (let nome in usuarios) {
    const u = usuarios[nome];
    if ((u.moral || 100) < 30) {
      risco.push(`${nome} — 🚨 Moral crítica`);
    }
    if ((u.perfil || "").includes("sombrio")) {
      risco.push(`${nome} — ⚠️ Perfil psicológico sombrio`);
    }
  }

  if (risco.length === 0) {
    document.getElementById("resultado-ia").innerHTML = "<p>✅ Nenhum risco estratégico detectado.</p>";
  } else {
    document.getElementById("resultado-ia").innerHTML =
      "<h4>⚠️ Agentes em Zona de Risco</h4><ul>" + risco.map(r => `<li>${r}</li>`).join("") + "</ul>";
  }

  logSetor("ia_estrategica", "⚠️ Detecção de risco estratégico executada.");
}

// 3. Previsão de operações (baseada em missões concluídas/falhas)
function previsaoOperacoes() {
  const missoes = JSON.parse(localStorage.getItem("missoes") || "[]");
  const concluidas = missoes.filter(m => m.status === "concluida").length;
  const falhas = missoes.filter(m => m.status === "falha").length;
  const total = concluidas + falhas;

  let chance = "Indefinida";
  if (total > 0) {
    chance = Math.round((concluidas / total) * 100) + "%";
  }

  document.getElementById("resultado-ia").innerHTML =
    `<p>📈 Chance estimada de sucesso em próximas operações: <strong>${chance}</strong></p>`;
  logSetor("ia_estrategica", "📈 Previsão de operações calculada.");
}

// 4. Gerar relatório estratégico (download .txt)
function gerarRelatorioEstrategico() {
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  const missoes = JSON.parse(localStorage.getItem("missoes") || "[]");
  const auditoria = JSON.parse(localStorage.getItem("auditoria_financas") || "[]");

  let relatorio = "=== RELATÓRIO ESTRATÉGICO CYBER NEXIS ===\n\n";

  relatorio += "👥 Usuários Registrados:\n";
  for (let nome in usuarios) {
    relatorio += `- ${nome} | Nível: ${usuarios[nome].nivel} | Moral: ${usuarios[nome].moral || 100}\n`;
  }

  relatorio += "\n🎯 Missões:\n";
  missoes.forEach(m => {
    relatorio += `- ${m.id} | ${m.titulo} | Status: ${m.status} | Agentes: ${m.agentes.join(", ")}\n`;
  });

  relatorio += "\n💰 Auditoria Financeira:\n";
  auditoria.slice(-5).forEach(a => {
    relatorio += `- ${a.de || "?"} -> ${a.para || "?"} | ${a.valor} | ${a.data}\n`;
  });

  const blob = new Blob([relatorio], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "relatorio_estrategico.txt";
  a.click();
  URL.revokeObjectURL(url);

  logSetor("ia_estrategica", "📝 Relatório estratégico gerado.");
}

function mostrarFormularioComandante(nome, senha, nivel) {
  const conteudo = document.getElementById("conteudo");
  conteudo.innerHTML = `
    <h2>📋 Cadastro de Comandante</h2>
    <p>Usuário: <strong>${nome}</strong></p>
    <p>Nível: <strong>${nivel}</strong></p>

    <label>Escolha a divisão:</label>
    <select id="setorComando" onchange="mostrarPerguntasSetor()">
      <option value="">-- Selecione --</option>
      <option value="seguranca_info">🔒 Segurança da Informação</option>
      <option value="psicologia">🧠 Psicologia Estratégica</option>
      <option value="contra_inteligencia">🎭 Contra-Inteligência</option>
      <option value="financas">💰 Finanças Secretas</option>
      <option value="operacao_campo">🛰️ Operação de Campo</option>
      <option value="ia_estrategica">🤖 IA Estratégica</option>
    </select>

    <div id="perguntas-setor" style="margin-top:15px;"></div>
    <button onclick="finalizarCadastroComandante('${nome}','${senha}','${nivel}')">✅ Finalizar Cadastro</button>
  `;
}

function mostrarPerguntasSetor() {
  const setor = document.getElementById("setorComando").value;
  const area = document.getElementById("perguntas-setor");

  let html = "";
  if (setor === "seguranca_info") {
    html = `
      <p>1. Você tem experiência com criptografia AES?</p>
      <input type="text" id="q1">
      <p>2. Como reagiria a uma tentativa de invasão?</p>
      <input type="text" id="q2">
    `;
  } else if (setor === "psicologia") {
    html = `
      <p>1. Como lidaria com um agente em colapso emocional?</p>
      <input type="text" id="q1">
      <p>2. O que significa disciplina estratégica para você?</p>
      <input type="text" id="q2">
    `;
  } else if (setor === "contra_inteligencia") {
    html = `
      <p>1. Como identificaria um infiltrado?</p>
      <input type="text" id="q1">
      <p>2. Qual seria sua primeira ação ao detectar duplicidade de identidade?</p>
      <input type="text" id="q2">
    `;
  } else if (setor === "financas") {
    html = `
      <p>1. Como garantiria a integridade de recursos secretos?</p>
      <input type="text" id="q1">
      <p>2. Como lidaria com suspeita de corrupção interna?</p>
      <input type="text" id="q2">
    `;
  } else if (setor === "operacao_campo") {
    html = `
      <p>1. Como coordenaria agentes em campo sob risco?</p>
      <input type="text" id="q1">
      <p>2. O que significa “disciplina operacional” para você?</p>
      <input type="text" id="q2">
    `;
  } else if (setor === "ia_estrategica") {
    html = `
      <p>1. Qual a importância de prever falhas antes de ocorrerem?</p>
      <input type="text" id="q1">
      <p>2. Como usaria IA para melhorar operações da organização?</p>
      <input type="text" id="q2">
    `;
  }

  area.innerHTML = html;
}
function finalizarCadastroComandante(nome, senha, nivel) {
  const setor = document.getElementById("setorComando").value;
  if (!setor) {
    alert("❌ Você precisa escolher uma divisão!");
    return;
  }

  const setores = JSON.parse(localStorage.getItem("setores") || "{}");
  if (setores[setor]) {
    alert(`❌ Já existe um comandante registrado na divisão ${setor}.`);
    return;
  }

  const resposta1 = document.getElementById("q1")?.value || "";
  const resposta2 = document.getElementById("q2")?.value || "";

  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  usuarios[nome] = { senha, nivel, setor, respostas: [resposta1, resposta2] };
  localStorage.setItem("usuarios", JSON.stringify(usuarios));

  setores[setor] = nome;
  localStorage.setItem("setores", JSON.stringify(setores));

  log(`✅ Comandante ${nome} registrado na divisão ${setor}.`);
  alert(`✅ Cadastro concluído! Agora ${nome} é o comandante de ${setor}.`);

  abrirSetor(setor); // já abre o painel do setor escolhido
}

function irParaLogin() {
  const conteudo = document.getElementById("conteudo");
  conteudo.innerHTML = `
    <h2>🔑 Login</h2>
    <input id="login-nome" placeholder="Usuário"><br>
    <input id="login-senha" type="password" placeholder="Senha"><br>
    <button onclick="fazerLogin()">Entrar</button>
  `;
}

function fazerLogin() {
  const nome = document.getElementById("login-nome").value;
  const senha = document.getElementById("login-senha").value;

  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  if (!usuarios[nome]) {
    alert("❌ Usuário não encontrado!");
    return;
  }

  if (usuarios[nome].senha !== senha) {
    alert("❌ Senha incorreta!");
    return;
  }

  alert(`✅ Bem-vindo ${nome}!`);
  abrirPainel(usuarios[nome]); // essa função já deve existir no seu sistema
}

<!-- COLE ESTE BLOCO DENTRO DO MESMO <script> (ou em app.js) -->
// ===== IMPLEMENTAÇÕES REAIS (MÓDULOS) =====

/**
 * scannerInterno()
 * - Varre pastas, arquivos e usuários em busca de vulnerabilidades simples:
 *   - pastas sem senha, senhas fracas (<6), arquivos grandes (>1MB em dataURL),
 *   - usuários com senha fraca (<6).
 * - Exibe resultados em #resultado-seguranca e registra logSetor.
 */
function scannerInterno() {
  const pastas = JSON.parse(localStorage.getItem("pastas") || "{}");
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");

  let resultados = {
    pastas_sem_senha: [],
    pastas_senha_fraca: [],
    arquivos_grandes: [],
    usuarios_senha_fraca: []
  };

  // Verifica pastas
  for (let nome in pastas) {
    const p = pastas[nome];
    const senha = (p.senha || "").toString();
    if (!senha) resultados.pastas_sem_senha.push(nome);
    else if (senha.length < 6) resultados.pastas_senha_fraca.push({ nome, senha });

    // arquivos (procuramos dataURLs grandes)
    for (let arq in (p.arquivos || {})) {
      const conteudo = p.arquivos[arq];
      // se for dataURL verifique o tamanho aproximado
      if (typeof conteudo === "string" && conteudo.startsWith("data:")) {
        // estima tamanho do payload base64
        const base64 = conteudo.split(",")[1] || "";
        const tamanhoBytes = Math.round((base64.length * 3) / 4);
        if (tamanhoBytes > 1 * 1024 * 1024) { // >1MB
          resultados.arquivos_grandes.push({ pasta: nome, arquivo: arq, tamanhoBytes });
        }
      }
    }
  }

  // Verifica senhas fracas de usuários
  for (let nome in usuarios) {
    const u = usuarios[nome];
    const s = (u.senha || "").toString();
    if (!s || s.length < 6) resultados.usuarios_senha_fraca.push(nome);
  }

  // Monta saída legível
  let html = "<h4>🔍 Resultado do Scanner Interno</h4>";
  if (resultados.pastas_sem_senha.length === 0 &&
      resultados.pastas_senha_fraca.length === 0 &&
      resultados.arquivos_grandes.length === 0 &&
      resultados.usuarios_senha_fraca.length === 0) {
    html += "<p style='color:lime'>✅ Nenhuma vulnerabilidade crítica encontrada.</p>";
    document.getElementById("resultado-seguranca").innerHTML = html;
    logSetor("seguranca_info", "🔍 Scanner interno concluído — sem problemas críticos.");
    return;
  }

  if (resultados.pastas_sem_senha.length) {
    html += `<p style="color:orange">⚠️ Pastas sem senha: ${resultados.pastas_sem_senha.join(", ")}</p>`;
  }
  if (resultados.pastas_senha_fraca.length) {
    html += "<p style='color:orange'>⚠️ Pastas com senha fraca:</p><ul>";
    resultados.pastas_senha_fraca.forEach(p => html += `<li>${p.nome} (senha: "${p.senha}")</li>`);
    html += "</ul>";
  }
  if (resultados.arquivos_grandes.length) {
    html += "<p style='color:orange'>⚠️ Arquivos grandes detectados:</p><ul>";
    resultados.arquivos_grandes.forEach(a => html += `<li>${a.pasta}/${a.arquivo} — ~${Math.round(a.tamanhoBytes/1024)} KB</li>`);
    html += "</ul>";
  }
  if (resultados.usuarios_senha_fraca.length) {
    html += `<p style='color:orange'>⚠️ Usuários com senha fraca: ${resultados.usuarios_senha_fraca.join(", ")}</p>`;
  }

  document.getElementById("resultado-seguranca").innerHTML = html;
  logSetor("seguranca_info", "🔍 Scanner interno detectou possíveis riscos.");
}


/**
 * armadilhaDigital()
 * - Cria uma pasta "honeypot" com arquivos falsos e marca como 'honeypot'.
 * - Se alguém abrir a pasta, a função abrirPasta() (existente) vai abrir normalmente.
 * - Para "detecção", adicionamos um contador em localStorage.logs_contra_inteligencia.
 */
function armadilhaDigital() {
  const pastas = JSON.parse(localStorage.getItem("pastas") || "{}");
  const fakeName = "HONEY_POT_" + Math.floor(Math.random() * 9000 + 1000);
  const now = new Date().toLocaleString();

  // Cria arquivos falsos (texto)
  const arquivos = {
    "README_HONEYPOT.txt": btoa(`AVISO: Acesso monitorado\nCriado em: ${now}`),
    "secrets_list.txt": btoa("senha1:12345\nsenha2:abcdef\n-- arquivo honeypot --")
  };

  pastas[fakeName] = {
    senha: "",           // sem senha para atrair curiosos
    fake: true,
    honeypot: true,
    arquivos
  };

  localStorage.setItem("pastas", JSON.stringify(pastas));

  // registre no log de contra-inteligência
  const logs = JSON.parse(localStorage.getItem("logs_contra_inteligencia") || "[]");
  logs.push(`${new Date().toLocaleTimeString()} - Armadilha criada: ${fakeName}`);
  localStorage.setItem("logs_contra_inteligencia", JSON.stringify(logs));

  document.getElementById("resultado-contra").innerHTML =
    `<p>🪤 Armadilha digital criada: <strong>${fakeName}</strong> (qualquer acesso será registrado).</p>`;
  logSetor("contra_inteligencia", `🪤 Armadilha criada: ${fakeName}`);
}

/**
 * Detecção "passiva" de honeypot: quando uma pasta é aberta através de abrirPasta(),
 * essa função não precisa ser chamda manualmente — mas podemos aumentar a checagem:
 * Adicione no topo da função abrirPasta (no seu código) após validar senha:
 *
 * if (pastas[nome].honeypot) {
 *   const logs = JSON.parse(localStorage.getItem("logs_contra_inteligencia")||"[]");
 *   logs.push(`${new Date().toLocaleTimeString()} - Acesso honeypot: ${nome} por ${usuarioAtual ? usuarioAtual.nome : 'anônimo'}`);
 *   localStorage.setItem("logs_contra_inteligencia", JSON.stringify(logs));
 * }
 *
 * (Se quiser, eu já adapto o seu abrirPasta para incluir essa checagem.)
 */

/**
 * detectarDuplicidade()
 * - Verifica duplicações entre usuários:
 *   - mesma frase secreta entre 2+ usuários,
 *   - mesma senha bruta entre 2+ usuários (avisa).
 * - Mostra resultado em #resultado-contra e registra logSetor.
 */
function detectarDuplicidade() {
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  const mapaFrases = {};
  const mapaSenhas = {};
  const duplicadosFrase = [];
  const duplicadosSenha = [];

  for (let nome in usuarios) {
    const u = usuarios[nome];
    const frase = (u.frase || "").toString();
    const senha = (u.senha || "").toString();

    if (frase) {
      if (!mapaFrases[frase]) mapaFrases[frase] = [];
      mapaFrases[frase].push(nome);
    }
    if (senha) {
      if (!mapaSenhas[senha]) mapaSenhas[senha] = [];
      mapaSenhas[senha].push(nome);
    }
  }

  for (let f in mapaFrases) {
    if (mapaFrases[f].length > 1) duplicadosFrase.push({ frase: f, usuarios: mapaFrases[f] });
  }
  for (let s in mapaSenhas) {
    if (mapaSenhas[s].length > 1) duplicadosSenha.push({ senha: s, usuarios: mapaSenhas[s] });
  }

  let html = "<h4>🕵️ Detector de Duplicidade</h4>";
  if (duplicadosFrase.length === 0 && duplicadosSenha.length === 0) {
    html += "<p style='color:lime'>✅ Nenhuma duplicidade encontrada.</p>";
    document.getElementById("resultado-contra").innerHTML = html;
    logSetor("contra_inteligencia", "🕵️ Detector executado — sem duplicidades.");
    return;
  }

  if (duplicadosFrase.length) {
    html += "<p style='color:orange'>⚠️ Frases de segurança duplicadas:</p><ul>";
    duplicadosFrase.forEach(d => html += `<li>Frase "${d.frase}" — Usuários: ${d.usuarios.join(", ")}</li>`);
    html += "</ul>";
  }

  if (duplicadosSenha.length) {
    html += "<p style='color:orange'>⚠️ Senhas idênticas encontradas (recomenda-se alteração):</p><ul>";
    duplicadosSenha.forEach(d => html += `<li>Senha "${d.senha}" — Usuários: ${d.usuarios.join(", ")}</li>`);
    html += "</ul>";
  }

  document.getElementById("resultado-contra").innerHTML = html;
  logSetor("contra_inteligencia", "🕵️ Detector de duplicidade executado.");
}


/**
 * depositoPIX() e depositoBTC()
 * - Simulam cobranças/links sem chamar servidores reais.
 * - Geram um objeto salvo em localStorage ("transacoesPIX" / "transacoesBTC") para auditoria.
 */

// Simula um pequeno delay
function _delay(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

async function depositoPIX() {
  // Pede dados ao usuário
  const paraUser = prompt("ID do agente que vai receber (nome de usuário):");
  const valorCentavos = parseInt(prompt("Valor (centavos):"), 10);
  if (!paraUser || isNaN(valorCentavos) || valorCentavos <= 0) {
    return alert("Dados inválidos. Operação cancelada.");
  }

  // Simula processamento
  document.getElementById("resultado-financas").innerHTML = "<p>Processando cobrança PIX...</p>";
  await _delay(700);

  const txid = "PIX" + Date.now().toString(36).toUpperCase().slice(-10);
  const copia_cola = `000201...${txid}...CEPAGTO`; // placeholder legível

  // Salva transação
  const transacoes = JSON.parse(localStorage.getItem("transacoesPIX") || "[]");
  transacoes.push({
    txid,
    paraUser,
    valorCentavos,
    status: "pendente",
    criadoEm: new Date().toISOString()
  });
  localStorage.setItem("transacoesPIX", JSON.stringify(transacoes));

  document.getElementById("resultado-financas").innerHTML =
    `<p>✅ Cobrança PIX gerada (simulada)</p>
     <p><strong>TXID:</strong> ${txid}</p>
     <p><strong>Valor:</strong> R$ ${(valorCentavos/100).toFixed(2)}</p>
     <p><strong>PIX Copia e Cola:</strong></p>
     <textarea rows="3">${copia_cola}</textarea>
     <p style="font-size:0.9em;color:gray">Status: pendente (simulação)</p>`;

  logSetor("financas", `⚡ PIX simulado criado para ${paraUser} — TXID ${txid}`);
}

async function depositoBTC() {
  const paraUser = prompt("ID do agente que vai receber (nome de usuário):");
  const valorUSD = parseFloat(prompt("Valor (USD):"));
  if (!paraUser || isNaN(valorUSD) || valorUSD <= 0) {
    return alert("Dados inválidos. Operação cancelada.");
  }

  document.getElementById("resultado-financas").innerHTML = "<p>Gerando fatura BTC (simulada)...</p>";
  await _delay(700);

  const id = "BTC" + Date.now().toString(36).toUpperCase().slice(-10);
  const fakeUrl = `https://pay.example/btc/invoice/${id}`;

  // Salva transação
  const transacoes = JSON.parse(localStorage.getItem("transacoesBTC") || "[]");
  transacoes.push({
    id,
    paraUser,
    valorUSD,
    url: fakeUrl,
    status: "aguardando",
    criadoEm: new Date().toISOString()
  });
  localStorage.setItem("transacoesBTC", JSON.stringify(transacoes));

  document.getElementById("resultado-financas").innerHTML =
    `<p>✅ Fatura BTC gerada (simulada)</p>
     <p><strong>ID:</strong> ${id}</p>
     <p><strong>Valor:</strong> US$ ${valorUSD.toFixed(2)}</p>
     <p><strong>Link de pagamento:</strong> <a href="${fakeUrl}" target="_blank">${fakeUrl}</a></p>
     <p style="font-size:0.9em;color:gray">Status: aguardando (simulação)</p>`;

  logSetor("financas", `₿ Fatura BTC simulada para ${paraUser} — ID ${id}`);
}

// Mostrar tela de login
function irParaLogin() {
  document.getElementById("telaCadastro").style.display = "none";
  document.getElementById("telaLogin").style.display = "block";
}

// Mostrar tela de cadastro (quando clica em "Novo agente")
function irParaCadastro() {
  document.getElementById("telaLogin").style.display = "none";
  document.getElementById("telaCadastro").style.display = "block";
}

async function firebaseSignIn() {
  try {
    const userCred = await auth.signInAnonymously();
    usuarioAtual = usuarioAtual || { nome: `anon-${userCred.user.uid}`, nivel: 'Iniciado' };
    logAcao(`🔐 Conectado ao Firebase como ${userCred.user.uid}`);
    return userCred.user;
  } catch (e) {
    console.error("Erro auth Firebase:", e);
    alert("Erro ao autenticar: " + e.message);
  }
}

// Envia mensagem cifrada AES-GCM com passphrase da sala
async function firebaseSendMessage(sala, texto, passphrase) {
  if (!usuarioAtual) await firebaseSignIn();
  const cript = await encryptMessageWithPassword(texto, passphrase); // usa helper que já temos
  const ts = Date.now();
  const ref = db.ref("chats/" + sala + "/messages");
  await ref.push({
    from: usuarioAtual.nome,
    meta: cript, // objeto {salt, iv, cipher}
    ts
  });
  logAcao(`✉️ Mensagem enviada na sala "${sala}"`);
}

// Escuta mensagens em tempo real
function firebaseListenMessages(sala, passphrase) {
  const ref = db.ref("chats/" + sala + "/messages");
  ref.on("child_added", async snap => {
    const msg = snap.val();
    try {
      const texto = await decryptMessageWithPassword(msg.meta, passphrase);
      log(`💬 [${msg.from}] ${texto}`);
      mostrarMensagemNaUI(msg.from, texto, msg.ts); // você pode criar essa função para exibir
    } catch (e) {
      console.warn("Falha ao descriptografar mensagem", e);
    }
  });
}

function abrirChatOnline() {
  const conteudo = document.getElementById("conteudo");
  clearElement(conteudo);

  appendSafe(conteudo, "h2", "💬 Chat Online");

  const salaInput = document.createElement("input");
  salaInput.placeholder = "Nome da sala";
  conteudo.appendChild(salaInput);

  const passInput = document.createElement("input");
  passInput.type = "password";
  passInput.placeholder = "Passphrase da sala";
  conteudo.appendChild(passInput);

  const joinBtn = document.createElement("button");
  joinBtn.textContent = "Entrar";
  joinBtn.onclick = () => {
    const sala = salaInput.value.trim();
    const pass = passInput.value.trim();
    if (!sala || !pass) return alert("Informe sala e passphrase");
    iniciarChatSala(sala, pass);
  };
  conteudo.appendChild(joinBtn);

  const msgsDiv = document.createElement("div");
  msgsDiv.id = "chat-online-mensagens";
  msgsDiv.style.height = "300px";
  msgsDiv.style.overflowY = "auto";
  msgsDiv.style.border = "1px solid #333";
  conteudo.appendChild(msgsDiv);

  const input = document.createElement("input");
  input.placeholder = "Digite sua mensagem...";
  conteudo.appendChild(input);

  const sendBtn = document.createElement("button");
  sendBtn.textContent = "Enviar";
  conteudo.appendChild(sendBtn);

  sendBtn.onclick = async () => {
    const texto = input.value.trim();
    if (!texto) return;
    await firebaseSendMessage(window.salaAtual, texto, window.passAtual);
    input.value = "";
  };
}

function iniciarChatSala(sala, passphrase) {
  window.salaAtual = sala;
  window.passAtual = passphrase;
  firebaseSignIn().then(() => {
    firebaseListenMessages(sala, passphrase);
    logAcao(`📡 Conectado à sala "${sala}"`);
  });
}

function mostrarMensagemNaUI(from, texto, ts) {
  const msgsDiv = document.getElementById("chat-online-mensagens");
  if (!msgsDiv) return;
  const p = document.createElement("p");
  p.textContent = `[${new Date(ts).toLocaleTimeString()}] ${from}: ${texto}`;
  msgsDiv.appendChild(p);
  msgsDiv.scrollTop = msgsDiv.scrollHeight;
}

// ====== Painel Analítico Avançado ======
// Requer helpers: safeTextNode, appendSafe, clearElement, loadChats, saveChats, getPastas
// e (opcional) Firebase inicializado na variável `db` (realtime database compat).

function abrirPainelAnalise() {
  const conteudo = document.getElementById('conteudo');
  clearElement(conteudo);

  appendSafe(conteudo, 'h2', '📊 Painel Analítico — Cyber-Nexis');

  const controls = document.createElement('div');
  controls.style.display = 'flex';
  controls.style.gap = '8px';
  controls.style.marginBottom = '10px';

  const btnAtualizar = document.createElement('button');
  btnAtualizar.textContent = '🔄 Atualizar Agora';
  btnAtualizar.onclick = () => atualizarPainelAnalise();
  controls.appendChild(btnAtualizar);

  const autoChk = document.createElement('input');
  autoChk.type = 'checkbox';
  autoChk.id = 'analise-auto';
  controls.appendChild(autoChk);
  const lbl = document.createElement('label');
  lbl.htmlFor = 'analise-auto';
  lbl.textContent = 'Auto-refresh 10s';
  controls.appendChild(lbl);

  const btnExport = document.createElement('button');
  btnExport.textContent = '📤 Exportar CSV';
  btnExport.onclick = () => exportAnaliseCSV();
  controls.appendChild(btnExport);

  appendSafe(conteudo, 'div', ''); // spacer
  conteudo.appendChild(controls);

  // area resumo
  const resumo = document.createElement('div');
  resumo.id = 'analise-resumo';
  resumo.style.border = '1px solid lime';
  resumo.style.padding = '8px';
  resumo.style.background = '#000';
  resumo.style.maxHeight = '60vh';
  resumo.style.overflow = 'auto';
  conteudo.appendChild(resumo);

  // details area
  const detalhe = document.createElement('div');
  detalhe.id = 'analise-detalhe';
  detalhe.style.marginTop = '10px';
  conteudo.appendChild(detalhe);

  // iniciar primeira coleta
  atualizarPainelAnalise();

  // auto-refresh handler
  if (window._analiseInterval) clearInterval(window._analiseInterval);
  document.getElementById('analise-auto').onchange = (e) => {
    if (e.target.checked) {
      window._analiseInterval = setInterval(atualizarPainelAnalise, 10000);
    } else {
      clearInterval(window._analiseInterval);
      window._analiseInterval = null;
    }
  };
}

// Função central que coleta métricas
async function coletarMetricas() {
  // 1) dados do localStorage
  const usuarios = JSON.parse(localStorage.getItem('usuarios') || '{}');
  const usuariosArr = Object.keys(usuarios);
  const numUsuarios = usuariosArr.length;

  const observadoresExpirados = usuariosArr.filter(n => usuarios[n].nivel === 'Observador' && usuarios[n].criadoEm && (Date.now() > usuarios[n].criadoEm + 24*60*60*1000)).length;
  const numObservadores = usuariosArr.filter(n => usuarios[n].nivel === 'Observador').length;

  const sessoes = JSON.parse(localStorage.getItem('sessaoAtual') ? JSON.stringify([JSON.parse(localStorage.getItem('sessaoAtual')).nome]) : '[]');
  const numSessoesSalvas = (localStorage.getItem('sessaoAtual') ? 1 : 0); // cliente único

  // pastas e arquivos
  const pastas = getPastas ? getPastas() : JSON.parse(localStorage.getItem('pastas') || '{}');
  const listaPastas = Object.keys(pastas || {});
  const numPastas = listaPastas.length;
  let numArquivos = 0;
  listaPastas.forEach(p => {
    const arquivos = pastas[p].arquivos || {};
    numArquivos += Object.keys(arquivos).length;
  });

  // mensagens locais (mensagens secretas)
  const mensagens = JSON.parse(localStorage.getItem('mensagens') || '{}');
  let numMensagensLocais = 0;
  for (let dest in mensagens) {
    numMensagensLocais += mensagens[dest].length;
  }

  // missoes e operacoes
  const missoes = JSON.parse(localStorage.getItem('missoes') || '[]');
  const operacoes = JSON.parse(localStorage.getItem('operacoes') || '[]');
  const numMissoes = missoes.length;
  const numOperacoes = operacoes.length;

  // chaves AES locais
  const chavesAES = JSON.parse(localStorage.getItem('chavesAES') || '[]');
  const numChavesAES = chavesAES.length;

  // usuarios com historico de localizacao
  const usuariosComLoc = usuariosArr.filter(n => usuarios[n].historicoLocais && usuarios[n].historicoLocais.length > 0).length;

  // dados de chats locais (o chat encriptado que criamos antes)
  const chatsLocal = JSON.parse(localStorage.getItem('chats_v1') || '{}');
  const numConversasLocais = Object.keys(chatsLocal || {}).length;
  let numMensagensLocaisChat = 0;
  for (let c in chatsLocal) numMensagensLocaisChat += (chatsLocal[c].messages || []).length;

  // 2) dados do Firebase (se existir db)
  let firebaseStats = { rooms: 0, messages: 0 };
  if (typeof db !== 'undefined') {
    try {
      // tenta ler conteudo mínimo (uma vez)
      const snap = await db.ref('chats').once('value');
      const val = snap.val() || {};
      firebaseStats.rooms = Object.keys(val).length;
      let total = 0;
      for (let room in val) {
        const msgs = val[room].messages || {};
        total += Object.keys(msgs).length;
      }
      firebaseStats.messages = total;
    } catch (e) {
      // falha ao acessar Firebase (regra/permission) — apenas log
      console.warn('Firebase não disponível para estatísticas:', e);
    }
  }

  return {
    numUsuarios,
    numObservadores,
    observadoresExpirados,
    numSessoesSalvas,
    numPastas,
    numArquivos,
    numMensagensLocais,
    numMissoes,
    numOperacoes,
    numChavesAES,
    usuariosComLoc,
    numConversasLocais,
    numMensagensLocaisChat,
    firebaseRooms: firebaseStats.rooms,
    firebaseMessages: firebaseStats.messages,
    timestamp: Date.now(),
    detalhes: {
      usuariosList: usuariosArr,
      pastasList: listaPastas,
      conversasList: Object.keys(chatsLocal || {})
    }
  };
}

// Atualiza o painel visual
async function atualizarPainelAnalise() {
  const resumo = document.getElementById('analise-resumo');
  const detalhe = document.getElementById('analise-detalhe');
  if (!resumo || !detalhe) return;
  clearElement(resumo);
  clearElement(detalhe);

  appendSafe(resumo, 'p', 'Coletando métricas...');
  const m = await coletarMetricas();

  // montar tabela simples
  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  table.style.fontFamily = 'monospace';
  const header = document.createElement('tr');
  ['Métrica','Contagem','Ação'].forEach(t => {
    const th = document.createElement('th');
    th.style.border = '1px solid lime';
    th.style.padding = '6px';
    th.style.background = '#050';
    th.textContent = t;
    header.appendChild(th);
  });
  table.appendChild(header);

  function addRow(name, value, detailFn) {
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.style.border='1px solid #0f0'; td1.style.padding='6px'; td1.textContent = name;
    const td2 = document.createElement('td'); td2.style.border='1px solid #0f0'; td2.style.padding='6px'; td2.textContent = String(value);
  const td3 = document.createElement('td');
  td3.style.border='1px solid #0f0'; td3.style.padding='6px';
    if (detailFn) {
      const b = document.createElement('button');
      b.textContent = 'Detalhar';
      b.onclick = () => detailFn();
      td3.appendChild(b);
    } else {
      td3.textContent = '-';
    }
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    table.appendChild(tr);
  }

  addRow('Usuários cadastrados', m.numUsuarios, () => mostrarDetalhe('Usuários', m.detalhes.usuariosList));
  addRow('Observadores (total)', m.numObservadores, () => mostrarDetalhe('Observadores', m.detalhes.usuariosList.filter(n => {
    const u = JSON.parse(localStorage.getItem('usuarios') || '{}')[n];
    return u && u.nivel === 'Observador';
  })));
  addRow('Observadores expirados (24h)', m.observadoresExpirados);
  addRow('Sessões salvas (navegador)', m.numSessoesSalvas);
  addRow('Pastas', m.numPastas, () => mostrarDetalhe('Pastas', m.detalhes.pastasList));
  addRow('Arquivos (total)', m.numArquivos);
  addRow('Mensagens locais (inbox)', m.numMensagensLocais);
  addRow('Conversas locais (chat)', m.numConversasLocais, () => mostrarDetalhe('Conversas Locais', m.detalhes.conversasList));
  addRow('Mensagens locais (chat)', m.numMensagensLocaisChat);
  addRow('Missões registradas', m.numMissoes);
  addRow('Operações ativas', m.numOperacoes);
  addRow('Chaves AES (locais)', m.numChavesAES);
  addRow('Usuários com histórico de local', m.usuariosComLoc);
  addRow('Firebase: salas (remoto)', m.firebaseRooms);
  addRow('Firebase: mensagens (remoto)', m.firebaseMessages);

  // timestamp
  addRow('Última atualização (ms)', m.timestamp);

  // substituir conteudo do resumo
  clearElement(resumo);
  resumo.appendChild(table);

  // detalhe vazio por enquanto
  appendSafe(detalhe, 'h3', 'Detalhes');
  appendSafe(detalhe, 'p', 'Clique em "Detalhar" para ver listas específicas.');

  // armazenar a última coleta para export
  window.__ultimaAnalise = m;
}

// função que mostra um painel com lista detalhada
function mostrarDetalhe(titulo, lista) {
  const detalhe = document.getElementById('analise-detalhe');
  clearElement(detalhe);
  appendSafe(detalhe, 'h3', `🔎 Detalhe: ${titulo}`);
  if (!lista || lista.length === 0) {
    appendSafe(detalhe, 'p', '(vazio)');
    return;
  }
  const ul = document.createElement('ul');
  ul.style.listStyle = 'none';
  ul.style.padding = '0';
  lista.forEach(item => {
    const li = document.createElement('li');
    li.style.padding = '6px';
    li.style.borderBottom = '1px dashed #222';
    li.appendChild(safeTextNode('div', String(item)));
    ul.appendChild(li);
  });
  detalhe.appendChild(ul);
  const back = document.createElement('button');
  back.textContent = '← Voltar';
  back.onclick = () => atualizarPainelAnalise();
  detalhe.appendChild(back);
}

// Export CSV
function exportAnaliseCSV() {
  const m = window.__ultimaAnalise;
  if (!m) return alert('Nenhuma análise disponível. Atualize primeiro.');
  const rows = [
    ['Métrica','Valor'],
    ['Usuários cadastrados', m.numUsuarios],
    ['Observadores', m.numObservadores],
    ['Observadores expirados', m.observadoresExpirados],
    ['Sessões salvas', m.numSessoesSalvas],
    ['Pastas', m.numPastas],
    ['Arquivos', m.numArquivos],
    ['Mensagens locais', m.numMensagensLocais],
    ['Conversas locais', m.numConversasLocais],
    ['Mensagens locais (chat)', m.numMensagensLocaisChat],
    ['Missões', m.numMissoes],
    ['Operações', m.numOperacoes],
    ['Chaves AES', m.numChavesAES],
    ['Usuários com local', m.usuariosComLoc],
    ['Firebase rooms', m.firebaseRooms],
    ['Firebase messages', m.firebaseMessages],
    ['timestamp', m.timestamp]
  ];
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `analise_cybernexis_${Date.now()}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// Inicializa painel automaticamente se já aberto
// (opcional) você pode chamar abrirPainelAnalise() em outros momentos

// ===== FIM DO BLOCO =====

</script>
</body>
</html>
