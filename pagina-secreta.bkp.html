<!DOCTYPE html>
<html lang="pt-br">
<head>
  <!-- Leaflet CSS -->
<link 
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<!-- Leaflet JS -->
<script 
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
</script>
<script>
  if (location.protocol === "file:") {
    alert("âš ï¸ Para o sistema funcionar corretamente, abra esta pÃ¡gina em um servidor local (http://). Use o VS Code Live Server ou 'python -m http.server'.");
    throw new Error("ExecuÃ§Ã£o bloqueada â€” pÃ¡gina aberta via file://");
  }
</script>
 <!-- Firebase SDKs (Compat) -->
 <!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cyber-Nexis - Sistema Secreto</title>
 <style>
/* === BASE DO SISTEMA (mantida do design original) === */
body {
  background-color: black;
  color: lime;
  font-family: monospace;
  cursor: crosshair;
  margin: 0;
  padding: 0;
}

.oculto { display: none; }

input, button, select, textarea {
  background: black;
  color: lime;
  border: 1px solid lime;
  padding: 5px;
  margin: 5px;
  width: calc(100% - 22px);
}

.header, .menu, .content, .logs {
  border: 1px solid lime;
  padding: 10px;
  margin: 5px;
}

.container {
  display: flex;
  flex-wrap: wrap;
}

.menu {
  width: 220px;
}

.content {
  flex: 1;
}

ul {
  list-style: none;
  padding: 0;
}
ul li {
  cursor: pointer;
  padding: 4px;
}
ul li:hover {
  background-color: #0f0;
  color: black;
}
.codebox {
  background: #111;
  border: 1px dashed lime;
  padding: 10px;
  font-family: monospace;
  white-space: pre-wrap;
  margin-top: 10px;
}
.logo {
  width: 100px;
  display: block;
  margin: 10px auto;
}
.log-item {
  background-color: black;
  color: lime;
  font-family: monospace;
  padding: 5px 10px;
  margin-bottom: 3px;
  border-left: 3px solid lime;
  border-radius: 2px;
  white-space: pre-wrap;
}

/* === EFEITOS DE TEXTO E ANIMAÃ‡ÃƒO (mantidos) === */
.typewriter {
  overflow: hidden;
  border-right: .15em solid #00ff00;
  white-space: nowrap;
  animation: typing 2.5s steps(30, end), blink-caret .75s step-end infinite;
}
@keyframes typing {
  from { width: 0 }
  to { width: 100% }
}
@keyframes blink-caret {
  from, to { border-color: transparent }
  50% { border-color: #00ff00; }
}
.fade-in {
  opacity: 0;
  transform: translateY(10px);
  animation: fadeInUp 0.8s ease forwards;
}
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes flicker {
  0%, 18%, 22%, 25%, 53%, 57%, 100% { opacity: 1; }
  20%, 24%, 55% { opacity: 0.4; }
}
.glow {
  color: #00ff00;
  text-shadow: 0 0 5px #00ff00, 0 0 15px #00ff00, 0 0 25px #00ff00;
  animation: flicker 3s infinite;
}

/* === NOVO DESIGN: LAYOUT DIVIDIDO (CADASTRO / LOGIN) === */
.painel-cadastro {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  border: 2px solid lime;
  margin: 50px auto;
  width: 90%;
  max-width: 1000px;
  background-color: #000;
  box-shadow: 0 0 15px #00ff0088;
}

/* Lado esquerdo */
.lado-esquerdo {
  width: 50%;
  border-right: 2px solid lime;
  padding: 20px;
  text-align: center;
}
.titulo-cadastro {
  color: lime;
  font-size: 22px;
  margin-bottom: 5px;
}
.subtexto {
  font-size: 14px;
  color: lime;
  margin-bottom: 20px;
}
.area-logo {
  border: 1px solid lime;
  margin: 10px auto;
  padding: 20px;
  width: 80%;
  height: 180px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.logo-cadastro {
  max-height: 120px;
  filter: drop-shadow(0 0 10px #00ff00);
}
.texto-animado {
  border: 1px solid lime;
  padding: 10px;
  margin-top: 20px;
  font-size: 13px;
  text-align: left;
  color: lime;
}

/* Lado direito */
.lado-direito {
  width: 50%;
  padding: 25px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  text-align: left;
}

.lado-direito label {
  font-weight: bold;
  text-align: left;
  display: block;
  margin-top: 10px;
  color: lime;
}

.lado-direito input, 
.lado-direito select {
  width: 100%;
  background: black;
  border: 1px solid lime;
  color: lime;
  padding: 8px;
  margin-top: 5px;
  outline: none;
}
.lado-direito input:focus, 
.lado-direito select:focus {
  box-shadow: 0 0 10px lime;
}
.lado-direito button {
  width: 100%;
  margin-top: 15px;
  background: black;
  color: lime;
  border: 1px solid lime;
  padding: 10px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}
.lado-direito button:hover {
  background: lime;
  color: black;
  box-shadow: 0 0 20px lime;
}

/* Responsividade */
@media (max-width: 800px) {
  .painel-cadastro {
    flex-direction: column;
  }
  .lado-esquerdo, .lado-direito {
    width: 100%;
    border: none;
    border-bottom: 2px solid lime;
  }
}
</style>
</head>
<body>

<!--SOM-->
<audio id="som-baixo" src="Sons/error_sound-221445.mp3"></audio>
<audio id="som-medio" src="Sons/beep-warning-6387.mp3"></audio>
<audio id="som-critico" src="Sons/siren-alert-96052.mp3"></audio>

<!-- ğŸ”¹ TELA DE CADASTRO -->
<div id="telaCadastro" class="tela">
  <div class="painel-cadastro">

    <!-- ğŸ”¸ Lado esquerdo: logotipo + texto -->
    <div class="lado-esquerdo">
      <h2 class="titulo-cadastro">CADASTRO DO AGENTE</h2>
      <p class="subtexto">Pequeno texto de instruÃ§Ã£o do sistema...</p>
      
      <div class="area-logo">
        <img src="Imagem/Logo terminal.png" alt="Logo Cyber-Nexis" class="logo-cadastro">
      </div>

      <div class="texto-animado">
        <p class="typewriter">O Sistema Cyber-Nexis conecta mentes e dados em uma teia digital sigilosa.  
        Sua funÃ§Ã£o Ã© observar, proteger e agir sem ser detectado.</p>
      </div>
    </div>

    <!-- ğŸ”¸ Lado direito: formulÃ¡rio -->
    <div class="lado-direito">
      <label>USUÃRIO:</label>
      <input id="cadastro-usuario" placeholder="Digite seu nome de agente"><br>

      <label>SENHA:</label>
      <input id="cadastro-senha" type="password" placeholder="Crie uma senha segura"><br>

      <label>FRASE DE SEGURANÃ‡A:</label>
      <input id="cadastro-frase" placeholder="Digite sua frase de seguranÃ§a"><br>

      <label>NÃVEL:</label>
      <select id="cadastro-nivel" onchange="mostrarSetorSeComandante()">
        <option value="Observador">Observador</option>
        <option value="Iniciado">Iniciado</option>
        <option value="Operador">Operador</option>
        <option value="Comandante">Comandante</option>
        <option value="Arquiteto">Arquiteto</option>
        <option value="LÃ­der Supremo">LÃ­der Supremo</option>
      </select><br>

 <button onclick="verificarCadastro()">Cadastrar</button>
      <button onclick="irParaLogin()">JÃ¡ tenho cadastro</button>
    </div>

  </div>
</div>
  
<div id="escolha-setor" style="display:none; margin-top:10px;">
    
  <label>Escolha o Setor:</label>
  <select id="cadastro-setor">
    <option value="">-- Selecione o setor --</option>
    <option value="seguranca_info">ğŸ”’ SeguranÃ§a da InformaÃ§Ã£o</option>
    <option value="psicologia">ğŸ§  Psicologia EstratÃ©gica</option>
    <option value="contra_inteligencia">ğŸ­ Contra-InteligÃªncia</option>
    <option value="financas">ğŸ’° FinanÃ§as Secretas</option>
    <option value="operacao_campo">ğŸ›°ï¸ OperaÃ§Ã£o de Campo</option>
    <option value="ia_estrategica">ğŸ¤– IA EstratÃ©gica</option>
  </select>
</div>
  <p id="cadastro-msg"></p>
</div>

<!-- ğŸ”¹ TELA DE LOGIN -->
<div id="telaLogin" class="tela oculto">
  <div class="painel-cadastro">

    <!-- ğŸ”¸ Lado esquerdo: logotipo + texto -->
    <div class="lado-esquerdo">
      <h2 class="titulo-cadastro">LOGIN DO AGENTE ğŸ‘¤</h2>
      <p class="subtexto">AutenticaÃ§Ã£o requerida...</p>
      
      <div class="area-logo">
        <img src="Imagem/Logo terminal.png" alt="Logo Cyber-Nexis" class="logo-cadastro">
      </div>

      <div class="texto-animado">
        <p class="typewriter">
          Acesso restrito. Apenas agentes autorizados podem entrar.<br>
          Toda tentativa de login Ã© monitorada pelo sistema central da Cyber-Nexis.
        </p>
      </div>
    </div>

    <!-- ğŸ”¸ Lado direito: formulÃ¡rio -->
    <div class="lado-direito">
      <label>USUÃRIO:</label>
      <input type="text" id="login-usuario" placeholder="Nome de agente" /><br>

      <label>SENHA:</label>
      <input type="password" id="login-senha" placeholder="Senha de acesso" /><br>

      <label>FRASE SECRETA / TOKEN:</label>
      <input type="text" id="login-frase" placeholder="Digite sua frase de seguranÃ§a" /><br>

      <button onclick="login()">Entrar</button>
      <button onclick="irParaCadastro()">Novo agente</button>

      <p id="login-msg"></p>
    </div>

  </div>
</div>

<!-- TELA DO SISTEMA PRINCIPAL -->
<div id="telaSistema" class="oculto">
 <h1 class="glow">CYBER-NEXIS ACCESS GRANTED</h1>
  <div class="header">
   
    <div id="alertaSistema">NÃ­vel de Alerta: ğŸŸ¢ Baixo</div>
    <button onclick="trocarAlerta()">ğŸ” Alternar Alerta</button>
    <button onclick="logout()">ğŸšª Sair</button>
  </div>

  <div class="container">
    <div class="menu">
      <h3>Setores</h3>
      <ul>
       <li onclick="abrirChatOnline()">ğŸ’¬ Chat Online</li>
       <li onclick="abrirPainelAnalise()">ğŸ“Š Painel AnalÃ­tico</li>
        <li onclick="mostrarSetor('hacker')">ğŸ’» Hacker AvanÃ§ado</li>
        <li onclick="abrirCriptografia()">ğŸ” Criptografia AES</li>
        <li onclick="abrirLogs()">ğŸ“œ Logs & LocalizaÃ§Ã£o</li>
        <li onclick="abrirMensagens()">ğŸ’¬ Mensagens Secretas</li>
        <li onclick="abrirQuiz()">ğŸ§  Teste PsicolÃ³gico</li>
        <li onclick="abrirOperacoes()">ğŸ›°ï¸ OperaÃ§Ãµes ao Vivo</li>
     <li onclick="abrirPastas()">ğŸ“ Pastas Seguras</li>
<li onclick="abrirSetor('seguranca_info')">ğŸ”’ DivisÃ£o de SeguranÃ§a da InformaÃ§Ã£o</li>
<li onclick="abrirSetor('psicologia')">ğŸ§  DivisÃ£o de Psicologia EstratÃ©gica</li>
<li onclick="abrirSetor('contra_inteligencia')">ğŸ­ DivisÃ£o Contra-InteligÃªncia</li>
<li onclick="abrirSetor('financas')">ğŸ’° DivisÃ£o de FinanÃ§as Secretas</li>
<li onclick="abrirSetor('operacao_campo')">ğŸ›°ï¸ DivisÃ£o de OperaÃ§Ã£o de Campo</li>
<li onclick="abrirSetor('ia_estrategica')">ğŸ¤– DivisÃ£o de IA EstratÃ©gica & Deep Learning</li>
 
        <li onclick="abrirAdmin()">ğŸ‘‘ Painel do LÃ­der Supremo</li>
      </ul>
    </div>

<div id="mapa-cybernexis" style="width:100%; height:400px; border:1px solid #0f0; margin-top:20px;"></div>

   <div class="content" id="conteudo">
   <h2 class="typewriter">Inicializando Sistema Cyber-Nexis...</h2>
  <h1 class="glow">CYBER-NEXIS ACCESS GRANTED</h1>
 <img src="Imagem/Logo terminal.png" width="100" height="200" alt="Logo terminal" class="logo" />
</div>
  <div class="logs">
    <h3>Logs do Sistema</h3>
    <ul id="log-list"></ul>
  </div>
</div>

<div></div>
<script>

if (!localStorage.getItem("setores")) {
  localStorage.setItem("setores", JSON.stringify({}));
}
// ConfiguraÃ§Ã£o do Firebase (seu projeto)
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAiWudBVRnLbXXBe3MRXvFecKHOPo8cuHM",
  authDomain: "logins-2369a.firebaseapp.com",
  databaseURL: "https://logins-2369a-default-rtdb.firebaseio.com",
  projectId: "logins-2369a",
  storageBucket: "logins-2369a.firebasestorage.app",
  messagingSenderId: "588838531095",
  appId: "1:588838531095:web:6c48b687b2ed2106d5ac52",
  measurementId: "G-4GFEJL7B44"
};

// Inicializa Firebase (verificando se SDK foi carregado)
if (!window.firebase || typeof firebase.initializeApp !== "function") {
  console.error("Firebase SDK nÃ£o carregado corretamente.");
} else if (!firebase.apps || !firebase.apps.length) {
  firebase.initializeApp(FIREBASE_CONFIG);
  console.log("âœ… Firebase inicializado.");
} else {
  console.log("â„¹ï¸ Firebase jÃ¡ estava inicializado.");
}

const auth = firebase.auth();
const db = firebase.database();
   
console.log("ğŸ”§ Sistema Cyber-Nexis carregado com sucesso!");
console.log("ğŸŒ Protocolo atual:", location.protocol);
// ---------- Helpers de seguranÃ§a ----------
function safeTextNode(tag, text) {
  const el = document.createElement(tag || "div");
  el.textContent = text;
  return el;
}

function appendSafe(parent, tag, text) {
  parent.appendChild(safeTextNode(tag, text));
}

function clearElement(el) {
  while (el.firstChild) el.removeChild(el.firstChild);
}

async function gerarSalt() {
  const salt = crypto.getRandomValues(new Uint8Array(16));
  return Array.from(salt).map(b => ('00' + b.toString(16)).slice(-2)).join('');
}

async function pbkdf2Hash(password, saltHex, iterations = 200000) {
  const enc = new TextEncoder().encode(password);
  const salt = new Uint8Array(saltHex.match(/.{2}/g).map(h => parseInt(h,16)));
  const key = await crypto.subtle.importKey('raw', enc, {name:'PBKDF2'}, false, ['deriveBits']);
  const derived = await crypto.subtle.deriveBits(
    { name: 'PBKDF2', salt, iterations, hash: 'SHA-256' },
    key,
    256
  );
  return btoa(String.fromCharCode(...new Uint8Array(derived)));
}

// Criptografia de mensagens helpers
async function deriveKeyFromPassword(password, saltHex) {
  const enc = new TextEncoder().encode(password);
  const salt = new Uint8Array(saltHex.match(/.{2}/g).map(h => parseInt(h,16)));
  const baseKey = await crypto.subtle.importKey('raw', enc, 'PBKDF2', false, ['deriveKey']);
  const key = await crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt, iterations: 200000, hash: 'SHA-256' },
    baseKey,
    { name: 'AES-GCM', length: 256 },
    false, // non-extractable
    ['encrypt','decrypt']
  );
  return key;
}

function bytesToBase64(bytes) {
  return btoa(String.fromCharCode(...bytes));
}
function base64ToBytes(b64) {
  return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
}

async function encryptMessageWithPassword(message, password) {
  const salt = await gerarSalt();
  const key = await deriveKeyFromPassword(password, salt);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, new TextEncoder().encode(message));
  return {
    salt,
    iv: Array.from(iv),
    cipher: Array.from(new Uint8Array(ciphertext))
  };
}

async function decryptMessageWithPassword(obj, password) {
  const key = await deriveKeyFromPassword(password, obj.salt);
  const iv = new Uint8Array(obj.iv);
  const cipher = new Uint8Array(obj.cipher);
  const plain = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, cipher);
  return new TextDecoder().decode(plain);
}    
    
function mostrarSetorSeComandante() {
  const nivel = document.getElementById("cadastro-nivel").value;
  const setorDiv = document.getElementById("escolha-setor");
  setorDiv.style.display = (nivel === "Comandante") ? "block" : "none";
}
let usuarioAtual = null;
let alertaAtual = "baixo";

// ===== FUNÃ‡ÃƒO DE CADASTRO =====
// ===== FUNÃ‡ÃƒO DE CADASTRO CORRIGIDA =====
async function verificarCadastro() {
  const nome = document.getElementById("cadastro-usuario").value.trim();
  const senha = document.getElementById("cadastro-senha").value;
  const frase = document.getElementById("cadastro-frase").value.trim().toLowerCase();
  const nivel = document.getElementById("cadastro-nivel").value;

  // VerificaÃ§Ã£o bÃ¡sica
  if (!nome || !senha || !frase || !nivel) {
    alert("âš ï¸ Preencha todos os campos.");
    return;
  }

  // Carregar usuÃ¡rios
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");

  // Impedir duplicaÃ§Ã£o
  if (usuarios[nome]) {
    alert("âš ï¸ Este agente jÃ¡ existe.");
    return;
  }

  // Gerar verificador de senha
  const salt = await gerarSalt();
  const verificador = await pbkdf2Hash(senha, salt);

  // ============================
  // âœ… CASE 1 â€” COMANDANTE
  // ============================
  if (nivel === "Comandante") {

    // Ler setor escolhido
    const setorEscolhido = document.getElementById("cadastro-setor").value;

    if (!setorEscolhido) {
      alert("âš ï¸ Escolha um setor para o Comandante.");
      return;
    }

    // Garante que "setores" exista
    const setores = JSON.parse(localStorage.getItem("setores") || "{}");

    // Verificar se jÃ¡ existe Comandante nesse setor
    const jaExiste = Object.values(usuarios)
      .some(u => u.nivel === "Comandante" && u.setor === setorEscolhido);

    if (jaExiste) {
      alert(`â›” JÃ¡ existe um Comandante para o setor ${setorEscolhido}.`);
      return;
    }

    // âœ… Criar usuÃ¡rio Comandante
    usuarios[nome] = {
      salt,
      verificador,
      nivel,
      frase,
      setor: setorEscolhido,
      criadoEm: Date.now()
    };

    // âœ… Registrar comandante no mapa de setores
    setores[setorEscolhido] = nome;
    localStorage.setItem("setores", JSON.stringify(setores));

    // âœ… Salvar usuÃ¡rios
    localStorage.setItem("usuarios", JSON.stringify(usuarios));

    alert(`âœ… Cadastro concluÃ­do! ${nome} Ã© o novo Comandante do setor ${setorEscolhido}.`);

    abrirSetor(setorEscolhido);
    return;
  }

  // ============================
  // âœ… CASE 2 â€” LÃDER SUPREMO
  // ============================
  if (nivel === "LÃ­der Supremo") {
    const existeSupremo = Object.values(usuarios)
      .some(u => u.nivel === "LÃ­der Supremo");

    if (existeSupremo) {
      alert("â›” JÃ¡ existe um LÃ­der Supremo. A criaÃ§Ã£o nÃ£o Ã© permitida.");
      return;
    }
  }

  // ============================
  // âœ… CASE 3 â€” OBSERVADOR OU OUTROS NÃVEIS
  // ============================
  usuarios[nome] = {
    salt,
    verificador,
    nivel,
    frase,
    criadoEm: Date.now(),
    expiraEm: (nivel === "Observador" ? Date.now() + 24 * 60 * 60 * 1000 : null)
  };

  localStorage.setItem("usuarios", JSON.stringify(usuarios));

  alert("âœ… Cadastro realizado com sucesso!");
  irParaLogin();
}

// ===== FUNÃ‡ÃƒO DE LOGIN COM VALIDAÃ‡ÃƒO DE OBSERVADOR =====
async function login() {
  const nome = document.getElementById("login-usuario").value.trim();
  const senha = document.getElementById("login-senha").value;
  const frase = document.getElementById("login-frase").value.trim();

  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");

  if (!usuarios[nome]) {
    document.getElementById("login-msg").innerText = "UsuÃ¡rio nÃ£o encontrado!";
    return;
  }

  const u = usuarios[nome];

  // Recalcula o verificador com a senha informada
  const verificadorLogin = await pbkdf2Hash(senha, u.salt);

  if (u.verificador !== verificadorLogin || u.frase !== frase) {
    document.getElementById("login-msg").innerText = "Senha ou frase secreta incorreta!";
    return;
  }

  // Se passou, login bem-sucedido
  usuarioAtual = { nome, nivel: u.nivel, criadoEm: u.criadoEm };
  localStorage.setItem("sessaoAtual", JSON.stringify(usuarioAtual));

  document.getElementById("login-msg").innerText = "Login realizado com sucesso!";
  logAcao(`ğŸ”‘ UsuÃ¡rio ${nome} logou no sistema.`);
  mostrarTela("telaSistema");

  // chama a funÃ§Ã£o Ãºnica e externa de geolocalizaÃ§Ã£o
  if (typeof registrarAcessoComGeolocalizacao === 'function') {
    try { registrarAcessoComGeolocalizacao(usuarioAtual); } catch(e) { console.warn(e); }
  }

  const usuario = usuarios[nome];

  // Limite de 24h para Observador
  if (usuario.nivel === "Observador" && usuario.criadoEm) {
    const agora = Date.now();
    const limite = usuario.criadoEm + 24 * 60 * 60 * 1000; // 24h em ms
    if (agora > limite) {
      alert("â›” Sua conta de Observador expirou. Login bloqueado.");
      return;
    }
    // se ainda vÃ¡lido, iniciar cronÃ´metro
    iniciarCronometroObservador();
  }
}

// ===== FUNÃ‡ÃƒO DE CRONÃ”METRO PARA OBSERVADOR =====
async function iniciarCronometroObservador() {
  const areaAlerta = document.getElementById("alertaSistema");
  const limite = usuarioAtual.criadoEm + 24 * 60 * 60 * 1000;

  const interval = setInterval(() => {
    const restante = limite - Date.now();
    if (restante <= 0) {
      clearInterval(interval);
      alert("â›” Tempo de Observador expirou. VocÃª serÃ¡ desconectado.");
      logout();
      return;
    }
    const horas = Math.floor(restante / (1000 * 60 * 60));
    const minutos = Math.floor((restante % (1000 * 60 * 60)) / (1000 * 60));
    const segundos = Math.floor((restante % (1000 * 60)) / 1000);
    areaAlerta.innerHTML = `NÃ­vel de Alerta: ğŸŸ¢ Baixo | Tempo restante: ${horas}h ${minutos}m ${segundos}s`;
  }, 1000);
}

// ===== FUNÃ‡Ã•ES DE NAVEGAÃ‡ÃƒO =====
function mostrarTela(id) {
  // Oculta todas as telas
  document.querySelectorAll('.tela').forEach(t => t.classList.add('oculto'));

  // Mostra apenas a tela especificada
  const tela = document.getElementById(id);
  if (tela) {
    tela.classList.remove('oculto');
    tela.classList.add('fade-in');
  } else {
    console.warn("Tela nÃ£o encontrada:", id);
  }
}

function irParaLogin() {
  mostrarTela("telaLogin");
}

function irParaCadastro() {
  mostrarTela("telaCadastro");
}

// ===== LOGOUT =====
function logout() {
  usuarioAtual = null;
  localStorage.removeItem("sessaoAtual");
  mostrarTela("telaLogin");
  logAcao("ğŸšª SessÃ£o encerrada.");
}

// ===== LOG =====
function log(mensagem) {
  const ul = document.getElementById("log-list");
  const li = document.createElement("li");
  li.textContent = new Date().toLocaleTimeString() + " - " + mensagem;
  li.classList.add("log-item"); // aplica o estilo de terminal
  ul.appendChild(li);
}

// ===== RESTAURAR SESSÃƒO =====
window.onload = () => {
    const salvo = JSON.parse(localStorage.getItem("sessaoAtual"));
    if (salvo) {
        usuarioAtual = salvo;
        mostrarTela("telaSistema");
        log("ğŸ” SessÃ£o restaurada automaticamente.");

        try {
            registrarAcessoComGeolocalizacao();
        } catch (e) {
            console.error("Erro na geolocalizaÃ§Ã£o:", e);
        }

        if (usuarioAtual.nivel === "Observador") {
            iniciarCronometroObservador();
        }
    } else {
        mostrarTela("telaCadastro");
    }
};

  function tocarSomAlerta(nivel) {
  document.getElementById("som-baixo").pause();
  document.getElementById("som-medio").pause();
  document.getElementById("som-critico").pause();

  if (nivel === "baixo") document.getElementById("som-baixo").play();
  else if (nivel === "mÃ©dio") document.getElementById("som-medio").play();
  else if (nivel === "crÃ­tico") document.getElementById("som-critico").play();
}

function trocarAlerta() {
  const alerta = document.getElementById("alertaSistema");
  if (alertaAtual === "baixo") {
    alertaAtual = "mÃ©dio";
    alerta.innerHTML = "NÃ­vel de Alerta: ğŸŸ¡ MÃ©dio";
    alerta.style.color = "yellow";
  } else if (alertaAtual === "mÃ©dio") {
    alertaAtual = "crÃ­tico";
    alerta.innerHTML = "NÃ­vel de Alerta: ğŸ”´ CrÃ­tico";
    alerta.style.color = "red";
  } else {
    alertaAtual = "baixo";
    alerta.innerHTML = "NÃ­vel de Alerta: ğŸŸ¢ Baixo";
    alerta.style.color = "lime";
  }
  tocarSomAlerta(alertaAtual); // ğŸ”Š reproduz som
  log("ğŸš¨ Alerta ajustado para " + alertaAtual.toUpperCase());
}

  function registrarAcessoComGeolocalizacao() {
    if (!navigator.geolocation) {
      log("ğŸ›‘ GeolocalizaÃ§Ã£o nÃ£o suportada.");
      return;
    }

    if (confirm("Deseja compartilhar sua localizaÃ§Ã£o com a base da Cyber-Nexis?")) {
      navigator.geolocation.getCurrentPosition(async position => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
          const data = await response.json();
          const cidade = data.address.city || data.address.town || data.address.village || "Desconhecida";
          const pais = data.address.country || "Desconhecido";
          log(`ğŸ›°ï¸ Agente ${usuarioAtual.nome} acessou de ${cidade}, ${pais}`);
        } catch {
          log(`ğŸŒ Acesso de ${usuarioAtual.nome}, mas falha ao localizar.`);
        }
      }, () => {
        log(`âš ï¸ LocalizaÃ§Ã£o negada por ${usuarioAtual.nome}.`);
      });
    } else {
      log("ğŸ“Œ LocalizaÃ§Ã£o nÃ£o autorizada.");
    }
  };
</script>

<script>
  const perguntasQuiz = [
    {
      imagem: "Imagem/ .jpg",
      pergunta: "VocÃª descobriu uma falha que dÃ¡ acesso a dados bancÃ¡rios. O que faz?",
      opcoes: [
        { texto: "Explora para ganhar dinheiro.", pontos: 0 },
        { texto: "Ignora, nÃ£o Ã© problema seu.", pontos: 1 },
        { texto: "Reporta de forma anÃ´nima.", pontos: 2 }
      ]
    },
    {
      imagem: "quiz2.jpg",
      pergunta: "Seu melhor amigo estÃ¡ cometendo crimes digitais. VocÃª:",
      opcoes: [
        { texto: "Encobre para protegÃª-lo.", pontos: 0 },
        { texto: "Confronta, mas nÃ£o denuncia.", pontos: 1 },
        { texto: "Reporta ou tenta impedir.", pontos: 2 }
      ]
    },
    {
      imagem: "quiz3.jpg",
      pergunta: "Um sistema opressor censura a internet. VocÃª:",
      opcoes: [
        { texto: "Invade e sabota servidores.", pontos: 2 },
        { texto: "Faz protesto pacÃ­fico online.", pontos: 1 },
        { texto: "Evita se envolver.", pontos: 0 }
      ]
    },
    {
      imagem: "quiz4.jpg",
      pergunta: "Te oferecem muito dinheiro para vazar dados de inocentes. VocÃª:",
      opcoes: [
        { texto: "Aceita sem pensar.", pontos: 0 },
        { texto: "Recusa a oferta.", pontos: 2 },
        { texto: "Finge aceitar e avisa a vÃ­tima.", pontos: 1 }
      ]
    },
    {
      imagem: "quiz5.jpg",
      pergunta: "VocÃª pode sabotar um polÃ­tico corrupto. VocÃª:",
      opcoes: [
        { texto: "ExpÃµe dados com provas reais.", pontos: 2 },
        { texto: "Divulga fakes para enfraquecer.", pontos: 0 },
        { texto: "NÃ£o se envolve com polÃ­tica.", pontos: 1 }
      ]
    },
    {
      imagem: "quiz6.jpg",
      pergunta: "Se fosse lÃ­der da Cyber-Nexis, seu foco seria:",
      opcoes: [
        { texto: "Poder e dominaÃ§Ã£o digital.", pontos: 0 },
        { texto: "EducaÃ§Ã£o e liberdade da informaÃ§Ã£o.", pontos: 2 },
        { texto: "ProteÃ§Ã£o e sigilo absoluto.", pontos: 1 }
      ]
    },
    {
      imagem: "quiz7.jpg",
      pergunta: "VocÃª vÃª injustiÃ§a social aumentada por tecnologia. VocÃª:",
      opcoes: [
        { texto: "Cria soluÃ§Ãµes acessÃ­veis para todos.", pontos: 2 },
        { texto: "Denuncia online com provas.", pontos: 1 },
        { texto: "Ignora, pois nÃ£o Ã© afetado.", pontos: 0 }
      ]
    },
    {
      imagem: "quiz8.jpg",
      pergunta: "VocÃª tem acesso a um sistema de vigilÃ¢ncia global. VocÃª:",
      opcoes: [
        { texto: "Usa para monitorar e proteger.", pontos: 1 },
        { texto: "Divulga as falhas ao pÃºblico.", pontos: 2 },
        { texto: "Usa para espionar rivais.", pontos: 0 }
      ]
    },
    {
      imagem: "quiz9.jpg",
      pergunta: "Se pudesse apagar todo histÃ³rico digital de alguÃ©m. VocÃª:",
      opcoes: [
        { texto: "Usa como chantagem.", pontos: 0 },
        { texto: "Apaga para dar segunda chance.", pontos: 2 },
        { texto: "Venda para empresas.", pontos: 0 }
      ]
    },
    {
      imagem: "quiz10.jpg",
      pergunta: "O que significa 'Ã©tica hacker' para vocÃª?",
      opcoes: [
        { texto: "Quebrar regras por diversÃ£o.", pontos: 0 },
        { texto: "Usar o conhecimento com responsabilidade.", pontos: 2 },
        { texto: "Fazer o que for necessÃ¡rio.", pontos: 1 }
      ]
    }
  ];

  let indiceAtual = 0;
  let pontuacao = 0;

  function abrirQuiz() {
    indiceAtual = 0;
    pontuacao = 0;
    mostrarPerguntaQuiz();
    log("ğŸ§  Iniciou Teste PsicolÃ³gico");
  }

  function mostrarPerguntaQuiz() {
    const conteudo = document.getElementById("conteudo");
    const pergunta = perguntasQuiz[indiceAtual];

    let opcoesHtml = "";
    pergunta.opcoes.forEach((op, i) => {
      opcoesHtml += `<button onclick="responderQuiz(${op.pontos})">${op.texto}</button><br>`;
    });
   conteudo.innerHTML = `
      <h2>ğŸ§  Teste PsicolÃ³gico (${indiceAtual + 1}/10)</h2>
      <img src="${pergunta.imagem}" alt="Imagem Quiz" style="max-width:100%; border:1px solid lime; margin-bottom:10px;"><br>
      <p><strong>${pergunta.pergunta}</strong></p>
      ${opcoesHtml}
    `;
  }
function responderQuiz(pontos) {
  pontuacao += pontos;
  indiceAtual++;
  if (indiceAtual < perguntasQuiz.length) {
    mostrarPerguntaQuiz();
  } else {
    finalizarQuiz();
  }
}

// final do quiz
function finalizarQuiz() {
  let nivelFinal = "";
  if (pontuacao <= 3) {
    nivelFinal = "Observador";
  } else if (pontuacao <= 6) {
    nivelFinal = "Iniciado";
  } else if (pontuacao <= 8) {
    nivelFinal = "Operador";
  } else {
    nivelFinal = "Comandante";
  }

  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  usuarios[usuarioAtual.nome].nivel = nivelFinal;
  localStorage.setItem("usuarios", JSON.stringify(usuarios));
  usuarioAtual.nivel = nivelFinal;

  const conteudo = document.getElementById("conteudo");
  conteudo.innerHTML = `
    <h2>âœ… Teste Finalizado</h2>
    <p>VocÃª atingiu <strong>${pontuacao} ponto(s)</strong>.</p>
    <p>NÃ­vel atribuÃ­do: <strong>${nivelFinal}</strong></p>
  `;
  log(`ğŸ§  Teste concluÃ­do â€” novo nÃ­vel: ${nivelFinal}`);
}
  
</script>

<script>
  // ===== CRIPTOGRAFIA AES =====
  let chaveAES = null;

  function abrirCriptografia() {
    const conteudo = document.getElementById("conteudo");
    conteudo.innerHTML = `
      <h2>ğŸ” Criptografia AES (GCM)</h2>
      <button onclick="gerarChave()">ğŸ”‘ Gerar Nova Chave</button><br><br>
      <label>Mensagem:</label><br>
      <textarea id="mensagem-cripto" rows="4"></textarea><br>
      <button onclick="criptografarAES()">Criptografar</button>
      <button onclick="descriptografarAES()">Descriptografar</button><br><br>
      <label>Resultado:</label><br>
      <textarea id="resultado-cripto" rows="4" readonly></textarea><br>
      <label>Chave AES (Base64):</label><br>
      <textarea id="chave-base64" rows="2" readonly></textarea>
    `;
    log("ğŸ” Acessou mÃ³dulo de Criptografia");
  }

  async function gerarChave() {
    chaveAES = await crypto.subtle.generateKey({ name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]);
    const raw = await crypto.subtle.exportKey("raw", chaveAES);
    const base64 = btoa(String.fromCharCode(...new Uint8Array(raw)));
    document.getElementById("chave-base64").value = base64;
    log("ğŸ”‘ Nova chave AES gerada");
  }

  async function criptografarAES() {
    const texto = document.getElementById("mensagem-cripto").value;
    if (!chaveAES) return alert("Gere a chave primeiro.");
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const dados = new TextEncoder().encode(texto);
    const cifrado = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, chaveAES, dados);
    const resultado = {
      iv: Array.from(iv),
      dados: Array.from(new Uint8Array(cifrado))
    };
    document.getElementById("resultado-cripto").value = btoa(JSON.stringify(resultado));
    log("ğŸ”’ Mensagem criptografada");
  }

  async function descriptografarAES() {
    const base64 = document.getElementById("resultado-cripto").value;
    if (!chaveAES) return alert("Gere a chave primeiro.");
    try {
      const obj = JSON.parse(atob(base64));
      const iv = new Uint8Array(obj.iv);
      const dados = new Uint8Array(obj.dados);
      const decifrado = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, chaveAES, dados);
      const texto = new TextDecoder().decode(decifrado);
      document.getElementById("mensagem-cripto").value = texto;
      log("ğŸ”“ Mensagem descriptografada");
    } catch {
      alert("âŒ Erro na descriptografia.");
      log("âš ï¸ Falha na descriptografia");
    }
  }

  // ===== MENSAGENS SECRETAS COM TEMPO LIMITADO =====
function abrirMensagens() {
  const conteudo = document.getElementById("conteudo");
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");

  let opcoes = "";
  for (let nome in usuarios) {
    if (nome !== usuarioAtual.nome) {
      opcoes += `<option value="${nome}">${nome}</option>`;
    }
  }

  conteudo.innerHTML = `
    <h2>ğŸ’¬ Mensagens Secretas</h2>
    <h3>Enviar Mensagem</h3>
    <select id="destinatario">${opcoes}</select><br>
    <textarea id="mensagem-secreta" rows="4"></textarea><br>
    <label>Tempo de expiraÃ§Ã£o (segundos):</label>
    <input type="number" id="tempo-expiracao" value="60" min="5" max="3600"><br>
    <button onclick="enviarMensagem()">Enviar</button>
    <h3>ğŸ“¥ Caixa de Entrada</h3>
    <div id="caixa-entrada"></div>
  `;

  exibirMensagens();
  log("ğŸ’¬ Acessou Mensagens Secretas");

  // Atualiza automaticamente a cada 5 segundos
  setInterval(() => {
    if (document.getElementById("caixa-entrada")) {
      exibirMensagens();
    }
  }, 5000);
}

function enviarMensagem() {
  const para = document.getElementById("destinatario").value;
  const texto = document.getElementById("mensagem-secreta").value.trim();
  const tempo = parseInt(document.getElementById("tempo-expiracao").value, 10) || 60;

  if (!texto) return alert("Digite uma mensagem!");
  if (tempo < 5) return alert("O tempo mÃ­nimo Ã© 5 segundos.");

  const expiracao = Date.now() + tempo * 1000;
  const codificada = btoa(texto);
  const todas = JSON.parse(localStorage.getItem("mensagens") || "{}");
  if (!todas[para]) todas[para] = [];

  todas[para].push({
    de: usuarioAtual.nome,
    conteudo: codificada,
    data: new Date().toLocaleString(),
    expiracao
  });

  localStorage.setItem("mensagens", JSON.stringify(todas));
  document.getElementById("mensagem-secreta").value = "";
  alert(`Mensagem enviada! Ela serÃ¡ apagada automaticamente em ${tempo} segundos.`);
  log(`ğŸ“¨ Mensagem enviada para ${para}`);
  exibirMensagens();
}

function exibirMensagens() {
  const caixa = document.getElementById("caixa-entrada");
  const todas = JSON.parse(localStorage.getItem("mensagens") || "{}");
  const agora = Date.now();

  // Remove mensagens expiradas
  for (let usuario in todas) {
    todas[usuario] = todas[usuario].filter(msg => !msg.expiracao || msg.expiracao > agora);
  }
  localStorage.setItem("mensagens", JSON.stringify(todas));

  const mensagens = todas[usuarioAtual.nome] || [];
  if (mensagens.length === 0) {
    caixa.innerHTML = "<p>(Nenhuma mensagem recebida)</p>";
    return;
  }

  let html = "<ul>";
  mensagens.forEach((msg, i) => {
    const tempoRestante = Math.max(0, Math.floor((msg.expiracao - agora) / 1000));
    html += `
      <li>
        <strong>De:</strong> ${msg.de}<br>
        <strong>Data:</strong> ${msg.data}<br>
        <strong>Mensagem:</strong> ${atob(msg.conteudo)}<br>
        <em>â±ï¸ Expira em: ${tempoRestante}s</em>
      </li><hr>`;
  });
  html += "</ul>";
  caixa.innerHTML = html;
}

  // ===== OPERAÃ‡Ã•ES EM TEMPO REAL =====
  let operacoes = JSON.parse(localStorage.getItem("operacoes") || "[]");

  function abrirOperacoes() {
    const conteudo = document.getElementById("conteudo");
    conteudo.innerHTML = `
      <h2>ğŸ›°ï¸ OperaÃ§Ãµes ao Vivo</h2>
      <button onclick="novaOperacao()">â• Nova OperaÃ§Ã£o</button>
      <div id="lista-operacoes"></div>`;
    exibirOperacoes();
    log("ğŸ¯ Acessou OperaÃ§Ãµes ao Vivo");
  }

  function novaOperacao() {
    const nome = prompt("Nome da nova operaÃ§Ã£o:");
    if (!nome) return;
    const nova = {
      id: Date.now(),
      nome,
      criador: usuarioAtual.nome,
      status: "Ativa",
      eventos: [
        { hora: new Date().toLocaleTimeString(), descricao: `ğŸ”ƒ OperaÃ§Ã£o '${nome}' iniciada por ${usuarioAtual.nome}` }
      ]
    };
    operacoes.push(nova);
    localStorage.setItem("operacoes", JSON.stringify(operacoes));
    exibirOperacoes();
    log(`â• Nova operaÃ§Ã£o: ${nome}`);
  }

  function exibirOperacoes() {
    const area = document.getElementById("lista-operacoes");
    if (operacoes.length === 0) {
      area.innerHTML = "<p>(Nenhuma operaÃ§Ã£o ativa)</p>";
      return;
    }

    area.innerHTML = "";
    operacoes.forEach(op => {
      area.innerHTML += `
        <div style="border:1px solid lime; padding:10px; margin:10px;">
          <h3>ğŸ›°ï¸ ${op.nome}</h3>
          <p><strong>Criador:</strong> ${op.criador} | <strong>Status:</strong> ${op.status}</p>
          <div id="linha-${op.id}" style="background:#000; padding:5px; border:1px solid #0f0; max-height:150px; overflow:auto;">
            ${op.eventos.map(e => `<p>ğŸ•’ ${e.hora} - ${e.descricao}</p>`).join("")}
          </div>
          <textarea id="input-${op.id}" rows="2" cols="50" placeholder="Atualizar operaÃ§Ã£o..."></textarea><br>
          <button onclick="atualizarOperacao(${op.id})">â¤ Atualizar</button>
          <button onclick="encerrarOperacao(${op.id})">ğŸ›‘ Encerrar</button>
        </div>`;
    });
  }

  function atualizarOperacao(id) {
    const index = operacoes.findIndex(op => op.id === id);
    const texto = document.getElementById(`input-${id}`).value.trim();
    if (!texto) return;

    const evento = {
      hora: new Date().toLocaleTimeString(),
      descricao: `${usuarioAtual.nome}: ${texto}`
    };

    operacoes[index].eventos.push(evento);
    localStorage.setItem("operacoes", JSON.stringify(operacoes));
    exibirOperacoes();
    log(`ğŸ“¡ OperaÃ§Ã£o ${operacoes[index].nome} atualizada`);
  }

  function encerrarOperacao(id) {
    const index = operacoes.findIndex(op => op.id === id);
    operacoes[index].status = "Encerrada";
    operacoes[index].eventos.push({
      hora: new Date().toLocaleTimeString(),
      descricao: `ğŸ›‘ OperaÃ§Ã£o encerrada por ${usuarioAtual.nome}`
    });
    localStorage.setItem("operacoes", JSON.stringify(operacoes));
    exibirOperacoes();
    log(`ğŸ›‘ OperaÃ§Ã£o encerrada: ${operacoes[index].nome}`);
  }

  // ===== PAINEL DO LÃDER SUPREMO =====
  function abrirAdmin() {
    if (!usuarioAtual || usuarioAtual.nivel !== "LÃ­der Supremo") {
      alert("â›” Acesso restrito ao LÃ­der Supremo.");
      log("ğŸš« Tentativa de acesso nÃ£o autorizada ao Painel do LÃ­der");
      return;
    }

const conteudo = document.getElementById("conteudo");
    const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");

    let lista = "";
    for (let nome in usuarios) {
      lista += `
        <li>
          ğŸ‘¤ ${nome} â€” ${usuarios[nome].nivel}
          <button onclick="removerUsuario('${nome}')">ğŸ—‘ï¸</button>
          <button onclick="promoverUsuario('${nome}')">â¬†ï¸</button>
        </li>
      `;
    }
    
    conteudo.innerHTML = `
      <h2>ğŸ‘‘ Painel Administrativo - LÃ­der Supremo</h2>
      <h3>ğŸŒ HistÃ³rico de LocalizaÃ§Ãµes</h3>
<div id="historico-local"></div>
      <h3>ğŸ•µï¸ Agentes Registrados</h3>
      <ul>${lista}</ul>
      <hr>
      <h3>âš™ï¸ Controles Globais</h3>
      <button onclick="limparTudo()">ğŸ§¨ Resetar Sistema</button>
      <button onclick="limparLogs()">ğŸ§¹ Limpar Logs Visuais</button>
    `;
    log("ğŸ‘‘ LÃ­der Supremo acessou o Painel Administrativo");
  }

  function removerUsuario(nome) {
    if (confirm(`Deseja remover o agente ${nome}?`)) {
      const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
      delete usuarios[nome];
      localStorage.setItem("usuarios", JSON.stringify(usuarios));
      log(`âŒ Agente ${nome} removido`);
      abrirAdmin(); // Recarrega
    }
  }

function mostrarHistoricoLocal() {
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  let html = "<ul>";
  for (let nome in usuarios) {
    if (usuarios[nome].historicoLocais) {
      html += `<li><strong>${nome}</strong><ul>`;
      usuarios[nome].historicoLocais.forEach(loc => {
        html += `<li>ğŸ“ ${loc.cidade}, ${loc.pais} â€” ${loc.data} (Â±${loc.precisao}m)</li>`;
      });
      html += "</ul></li>";
    }
  }
  html += "</ul>";
  document.getElementById("historico-local").innerHTML = html;
}
  function promoverUsuario(nome) {
    const novoNivel = prompt(`Digite o novo nÃ­vel para ${nome} (ex: Operador, Comandante):`);
    if (!novoNivel) return;
    const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
    usuarios[nome].nivel = novoNivel;
    localStorage.setItem("usuarios", JSON.stringify(usuarios));
    log(`â¬†ï¸ Agente ${nome} promovido para ${novoNivel}`);
    abrirAdmin(); // Recarrega
  }

  function limparTudo() {
    if (confirm("âš ï¸ Isso apagarÃ¡ TODOS os dados da Cyber-Nexis. Tem certeza?")) {
      localStorage.clear();
      log("ğŸ§¨ Sistema foi resetado pelo LÃ­der Supremo");
      alert("Sistema reiniciado. Recarregue a pÃ¡gina.");
      location.reload();
    }
  }

  function limparLogs() {
    document.getElementById("log-list").innerHTML = "";
    log("ğŸ§¹ Logs visuais foram apagados");
  }
  
// ===== UTILITÃRIOS =====
function getPastas() {
  return JSON.parse(localStorage.getItem("pastas") || "{}");
}

function setPastas(pastas) {
  localStorage.setItem("pastas", JSON.stringify(pastas));
}

function logAcao(mensagem) {
  const logList = document.getElementById("log-list");
  const li = document.createElement("li");
  li.textContent = `${new Date().toLocaleTimeString()} - ${mensagem}`;
  logList.appendChild(li);
}

// ===== ABRIR PASTAS =====
function abrirPastas() {
  const conteudo = document.getElementById("conteudo");
  const pastas = getPastas();

  let listaPastas = "";
  for (let nome in pastas) {
    listaPastas += `
      <li>
        ${nome} 
        <button onclick="abrirPasta('${nome}')">Abrir</button>
        <button onclick="removerPasta('${nome}')">ğŸ—‘ï¸ Apagar</button>
      </li>`;
  }

  conteudo.innerHTML = `
    <h2>ğŸ“ Pastas Seguras</h2>
    <h3>Criar Nova Pasta</h3>
    <input type="text" id="nova-pasta-nome" placeholder="Nome da pasta"><br>
    <input type="password" id="nova-pasta-senha" placeholder="Senha da pasta"><br>
    <button onclick="criarPasta()">Criar Pasta</button>
    <hr>
    <h3>Pastas Existentes</h3>
    <ul>${listaPastas || "<p>(Nenhuma pasta criada)</p>"}</ul>
    <div id="area-pasta"></div>
  `;
}

// ===== CRIAR PASTA =====
// ===== LIMITES DE ARQUIVOS =====
const LIMITE_ARQUIVOS_PASTA = 10;   // mÃ¡ximo por pasta
const LIMITE_ARQUIVOS_GLOBAL = 50;  // mÃ¡ximo global
const LIMITE_EXPORTACAO = 5;        // mÃ¡ximo para exportar de uma vez
function criarPasta() {
  const nome = document.getElementById("nova-pasta-nome").value.trim();
  const senha = document.getElementById("nova-pasta-senha").value;

  if (!nome || !senha) return alert("Preencha nome e senha!");

  const pastas = getPastas();
  if (pastas[nome]) return alert("Pasta jÃ¡ existe!");

  pastas[nome] = { senha, arquivos: {} };
  setPastas(pastas);
  alert(`Pasta "${nome}" criada com sucesso!`);
  abrirPastas();
  logAcao(`Pasta "${nome}" criada.`);
}

// ===== ABRIR PASTA =====
function abrirPasta(nome) {
  const senha = prompt(`Digite a senha da pasta "${nome}":`);
  if (!senha) return;

  const pastas = getPastas();
  if (!pastas[nome]) return alert("Pasta nÃ£o encontrada!");
  if (pastas[nome].senha !== senha) return alert("Senha incorreta!");

  mostrarConteudoPasta(nome, pastas[nome]);
  logAcao(`Pasta "${nome}" aberta.`);
}

// ===== MOSTRAR CONTEÃšDO DA PASTA =====
function mostrarConteudoPasta(nome, pasta) {
  const area = document.getElementById("area-pasta");

  // Ordenar arquivos por nome
  const arquivosOrdenados = Object.keys(pasta.arquivos).sort();

  let listaArquivos = "";
  arquivosOrdenados.forEach(arquivo => {
    listaArquivos += `
      <li>
        ${arquivo} 
        <button onclick="editarArquivo('${nome}','${arquivo}')">âœï¸ Editar</button>
        <button onclick="baixarArquivo('${arquivo}', '${pasta.arquivos[arquivo]}')">â¬‡ï¸ Baixar</button>
        <button onclick="removerArquivo('${nome}','${arquivo}')">ğŸ—‘ï¸ Apagar</button>
      </li>`;
  });

  area.innerHTML = `
    <h3>ğŸ“‚ Pasta: ${nome}</h3>
    <button onclick="exportarArquivos('${nome}')">ğŸ“¤ Exportar Arquivos</button>

    <h4>Criar Arquivo de Texto</h4>
    <input type="text" id="novo-arquivo-nome" placeholder="Nome do arquivo"><br>
    <textarea id="novo-arquivo-conteudo" rows="4" placeholder="ConteÃºdo"></textarea><br>
    <button onclick="criarArquivo('${nome}')">Salvar Arquivo</button>

    <h4>ğŸ“¤ Upload de Arquivo</h4>
    <input type="file" id="upload-arquivo"><br>
    <div id="drop-area" style="border:2px dashed lime; padding:20px; margin-top:10px; text-align:center;">
      Arraste arquivos aqui
    </div>
    <button onclick="uploadArquivo('${nome}')">Enviar Arquivo</button>

    <hr>
    <h4>Arquivos Existentes</h4>
    <ul>${listaArquivos || "<p>(Nenhum arquivo)</p>"}</ul>

    <div id="preview-arquivo"></div>
  `;

  // Drag & Drop
  const dropArea = document.getElementById("drop-area");
  dropArea.addEventListener("dragover", e => { e.preventDefault(); dropArea.style.background="#222"; });
  dropArea.addEventListener("dragleave", e => { dropArea.style.background=""; });
  dropArea.addEventListener("drop", e => {
    e.preventDefault();
    const arquivos = e.dataTransfer.files;
    handleUploadFiles(nome, arquivos);
  });
}

// ===== CRIAR ARQUIVO DE TEXTO =====
function criarArquivo(nomePasta) {
  const arquivo = document.getElementById("novo-arquivo-nome").value.trim();
  const conteudo = document.getElementById("novo-arquivo-conteudo").value;

  if (!arquivo) return alert("Digite o nome do arquivo!");

  const pastas = getPastas();
  pastas[nomePasta] = pastas[nomePasta] || { arquivos: {} };

  // Conta total global
  let totalArquivos = 0;
  for (let p in pastas) {
    totalArquivos += Object.keys(pastas[p].arquivos || {}).length;
  }

  // Verifica limite global
  if (totalArquivos >= LIMITE_ARQUIVOS_GLOBAL) {
    alert("â›” Limite global de arquivos atingido!");
    return;
  }

  // Verifica limite da pasta
  if (Object.keys(pastas[nomePasta].arquivos).length >= LIMITE_ARQUIVOS_PASTA) {
    alert(`â›” A pasta "${nomePasta}" jÃ¡ atingiu o limite de ${LIMITE_ARQUIVOS_PASTA} arquivos!`);
    return;
  }

  pastas[nomePasta].arquivos[arquivo] = btoa(conteudo);
  setPastas(pastas);

  alert(`Arquivo "${arquivo}" salvo!`);
  abrirPasta(nomePasta);
  logAcao(`Arquivo "${arquivo}" criado na pasta "${nomePasta}".`);
}

// ===== EDITAR ARQUIVO =====
function editarArquivo(nomePasta, arquivo) {
  const pastas = getPastas();
  const conteudo = atob(pastas[nomePasta].arquivos[arquivo]);

  const novoConteudo = prompt(`Editar arquivo "${arquivo}":`, conteudo);
  if (novoConteudo === null) return;

  pastas[nomePasta].arquivos[arquivo] = btoa(novoConteudo);
  setPastas(pastas);
  alert(`Arquivo "${arquivo}" atualizado!`);
  abrirPasta(nomePasta);
  logAcao(`Arquivo "${arquivo}" editado na pasta "${nomePasta}".`);
}

// ===== DOWNLOAD DE ARQUIVO =====
function baixarArquivo(nomeArquivo, dataBase64) {
  const conteudo = atob(dataBase64);
  const blob = new Blob([conteudo], { type: "application/octet-stream" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = nomeArquivo;
  a.click();
  URL.revokeObjectURL(url);

  logAcao(`Arquivo "${nomeArquivo}" baixado.`);
}

// ===== EXPORTAR ARQUIVOS DA PASTA =====
function exportarArquivos(nomePasta) {
  const pastas = getPastas();
  if (!pastas[nomePasta]) return alert("â›” Pasta nÃ£o encontrada");

  const arquivos = Object.keys(pastas[nomePasta].arquivos || {});

  // Verifica limite de exportaÃ§Ã£o
  if (arquivos.length > LIMITE_EXPORTACAO) {
    alert(`âš ï¸ SÃ³ Ã© permitido exportar atÃ© ${LIMITE_EXPORTACAO} arquivos por vez.`);
    return;
  }

  const blob = new Blob([JSON.stringify(pastas[nomePasta].arquivos, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `export_${nomePasta}_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);

  logAcao(`ğŸ“¤ Exportando ${arquivos.length} arquivos da pasta "${nomePasta}"`);
}

// ===== REMOVER ARQUIVO =====
function removerArquivo(nomePasta, arquivo) {
  if (!confirm(`Apagar arquivo "${arquivo}"?`)) return;

  const pastas = getPastas();
  delete pastas[nomePasta].arquivos[arquivo];
  setPastas(pastas);
  abrirPasta(nomePasta);
  logAcao(`Arquivo "${arquivo}" removido da pasta "${nomePasta}".`);
}

// ===== REMOVER PASTA =====
function removerPasta(nome) {
  if (!confirm(`Apagar pasta "${nome}" e todos os arquivos?`)) return;

  const pastas = getPastas();
  delete pastas[nome];
  setPastas(pastas);
  abrirPastas();
  logAcao(`Pasta "${nome}" removida.`);
}

// ===== UPLOAD DE ARQUIVOS =====
function uploadArquivo(nomePasta) {
  const fileInput = document.getElementById("upload-arquivo");
  if (fileInput.files.length === 0) return alert("Selecione um arquivo!");
  handleUploadFiles(nomePasta, fileInput.files);
}

// ===== HANDLER DE UPLOAD =====
function handleUploadFiles(nomePasta, arquivos) {
  const pastas = getPastas();
  Array.from(arquivos).forEach(file => {
    if (file.size > 2 * 1024 * 1024) return alert(`Arquivo "${file.name}" excede 2MB!`);
    const allowed = ['image/png','image/jpeg','text/plain','application/pdf'];
    if (!allowed.includes(file.type)) return alert(`Tipo de arquivo "${file.type}" nÃ£o permitido: ${file.name}`);

    const reader = new FileReader();
    reader.onload = function(e) {
      pastas[nomePasta].arquivos[file.name] = e.target.result;
      setPastas(pastas);
      abrirPasta(nomePasta);
      logAcao(`Arquivo "${file.name}" enviado para pasta "${nomePasta}".`);
    };
    reader.readAsDataURL(file);
  });
}

function notificarSistema(mensagem) {
  const area = document.getElementById("conteudo"); // ou outra div de notificaÃ§Ãµes
  const div = document.createElement("div");
  div.textContent = mensagem;
  div.classList.add("log-item"); // mesmo estilo de terminal
  area.prepend(div); // adiciona no topo da Ã¡rea
}

function mostrarMapa(lat, lon, cidade, pais) {
  const conteudo = document.getElementById("conteudo");
  conteudo.innerHTML = `
    <h2>ğŸŒ LocalizaÃ§Ã£o Atual</h2>
    <p>ğŸ“ ${cidade}, ${pais}</p>
    <div id="mapa" style="height:400px; border:1px solid lime; margin-top:10px;"></div>
  `;

  const mapa = L.map('mapa').setView([lat, lon], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(mapa);

  L.marker([lat, lon]).addTo(mapa)
    .bindPopup(`Agente ${usuarioAtual.nome}<br>${cidade}, ${pais}`)
    .openPopup();
}

function abrirSetor(idSetor) {
  const setores = JSON.parse(localStorage.getItem("setores") || "{}");
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");

  // Verifica se existe comandante registrado
  if (!setores[idSetor]) {
    alert("âš ï¸ Ainda nÃ£o existe comandante para este setor.");
    log(`ğŸš« Tentativa de acesso ao setor ${idSetor} sem comandante.`);
    return;
  }

  // Verifica se usuÃ¡rio tem permissÃ£o
  if (
    usuarioAtual.nome !== setores[idSetor] &&
    usuarioAtual.nivel !== "LÃ­der Supremo"
  ) {
    alert("â›” Acesso negado. Apenas o comandante deste setor ou o LÃ­der Supremo podem acessar.");
    log(`ğŸš« Acesso negado ao setor ${idSetor} por ${usuarioAtual.nome}`);
    return;
  }

  // Nome bonito para cada setor
  const nomesSetores = {
    seguranca_info: "ğŸ”’ DivisÃ£o de SeguranÃ§a da InformaÃ§Ã£o",
    psicologia: "ğŸ§  DivisÃ£o de Psicologia EstratÃ©gica",
    contra_inteligencia: "ğŸ­ DivisÃ£o Contra-InteligÃªncia",
    financas: "ğŸ’° DivisÃ£o de FinanÃ§as Secretas",
    operacao_campo: "ğŸ›°ï¸ DivisÃ£o de OperaÃ§Ã£o de Campo",
    ia_estrategica: "ğŸ¤– DivisÃ£o de IA EstratÃ©gica & Deep Learning"
  };
  
  if (idSetor === "psicologia") {
  document.getElementById("acoes-psicologia").innerHTML = `
    <h3>ğŸ§  Ferramentas de Psicologia EstratÃ©gica</h3>
    <button onclick="listarPerfis()">ğŸ“Š Ver Perfis PsicolÃ³gicos</button>
    <button onclick="avaliarRisco()">âš ï¸ Avaliar Risco dos Agentes</button>
    <button onclick="mensagemSubliminar()">ğŸ’­ Enviar Mensagem Subliminar</button>
    <button onclick="controleMoral()">ğŸ“ˆ Controle de Moral</button>
    <div id="resultado-psicologia" style="margin-top:10px;"></div>
  `;
}
 
if (idSetor === "financas") {
  document.getElementById("acoes-financas").innerHTML = `
    <h3>ğŸ’° Ferramentas de FinanÃ§as Secretas</h3>
    <button onclick="mostrarSaldos()">ğŸ“Š Cofre Virtual</button>
    <button onclick="transferirCreditos()">ğŸ’¸ Transferir CrÃ©ditos</button>
    <button onclick="auditoriaFinanceira()">ğŸ“œ Auditoria de TransaÃ§Ãµes</button>
    <button onclick="depositoPIX()">âš¡ Depositar via PIX</button>
    <button onclick="depositoBTC()">â‚¿ Depositar via Bitcoin</button>
    <div id="resultado-financas" style="margin-top:10px;"></div>
  `;
}

if (idSetor === "operacao_campo") {
  document.getElementById("acoes-operacao_campo").innerHTML = `
    <h3>ğŸ›°ï¸ Ferramentas de OperaÃ§Ã£o de Campo</h3>
    <button onclick="criarMissao()">ğŸ¯ Criar Nova MissÃ£o</button>
    <button onclick="listarMissoes()">ğŸ“‹ Listar MissÃµes</button>
    <button onclick="mapaMissoes()">ğŸ—ºï¸ Mostrar no Mapa</button>
    <button onclick="atualizarStatusMissao()">âš¡ Atualizar Status</button>
    <div id="resultado-operacao" style="margin-top:10px;"></div>
    <div id="mapa-missoes" style="height:400px; margin-top:10px;"></div>
  `;
}

if (idSetor === "ia_estrategica") {
  document.getElementById("acoes-ia_estrategica").innerHTML = `
    <h3>ğŸ¤– Ferramentas de IA EstratÃ©gica</h3>
    <button onclick="analisarLogsGlobais()">ğŸ“Š Analisar Logs Globais</button>
    <button onclick="detectarRiscoEstrategico()">âš ï¸ Detectar Risco EstratÃ©gico</button>
    <button onclick="previsaoOperacoes()">ğŸ“ˆ PrevisÃ£o de OperaÃ§Ãµes</button>
    <button onclick="gerarRelatorioEstrategico()">ğŸ“ Gerar RelatÃ³rio EstratÃ©gico</button>
    <div id="resultado-ia" style="margin-top:10px;"></div>
  `;
}

  // Exibir painel
  const conteudo = document.getElementById("conteudo");
  conteudo.innerHTML = `
    <h2>${nomesSetores[idSetor]}</h2>
    <p>ğŸ‘¤ Comandante responsÃ¡vel: <strong>${setores[idSetor]}</strong></p>
    <div id="logs-${idSetor}" style="border:1px solid lime; padding:10px; margin-top:10px; background:#000; height:200px; overflow:auto;"></div>
    <div id="acoes-${idSetor}" style="margin-top:15px;">
      <p>(Ferramentas especÃ­ficas desta divisÃ£o aparecerÃ£o aqui)</p>
    </div>
  `;

  logSetor(idSetor, `âœ… ${usuarioAtual.nome} acessou o painel administrativo`);
}

function logSetor(setorId, mensagem) {
  const key = `logs_${setorId}`;
  const logs = JSON.parse(localStorage.getItem(key) || "[]");
  logs.push(`${new Date().toLocaleTimeString()} - ${mensagem}`);
  localStorage.setItem(key, JSON.stringify(logs));

  // Exibir se o painel estiver aberto
  const area = document.getElementById(`logs-${setorId}`);
  if (area) {
    area.innerHTML = logs.map(l => `<div class="log-item">${l}</div>`).join("");
    area.scrollTop = area.scrollHeight; // auto-scroll
  }
}

// ======= DIVISÃƒO DE SEGURANÃ‡A DA INFORMAÃ‡ÃƒO =======

// 1. Monitor de Incidentes
function registrarIncidente() {
  const descricao = prompt("Descreva o incidente detectado:");
  if (!descricao) return;
  logSetor("seguranca_info", `âš ï¸ Incidente registrado: ${descricao}`);
  document.getElementById("resultado-seguranca").innerHTML =
    `<p style="color:yellow">âš ï¸ Incidente registrado: ${descricao}</p>`;
}

// 2. Gerenciamento de Chaves AES
function gerarChaveSeguranca() {
  crypto.subtle.generateKey({ name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"])
    .then(async chave => {
      const raw = await crypto.subtle.exportKey("raw", chave);
      const base64 = btoa(String.fromCharCode(...new Uint8Array(raw)));
      const chaves = JSON.parse(localStorage.getItem("chavesAES") || "[]");
      chaves.push(base64);
      localStorage.setItem("chavesAES", JSON.stringify(chaves));
      logSetor("seguranca_info", "ğŸ”‘ Nova chave AES gerada.");
      listarChaves();
    });
}

function listarChaves() {
  const chaves = JSON.parse(localStorage.getItem("chavesAES") || "[]");
  const area = document.getElementById("resultado-seguranca");
  if (chaves.length === 0) {
    area.innerHTML = "<p>(Nenhuma chave registrada)</p>";
    return;
  }
  let html = "<h4>ğŸ”‘ Chaves AES Ativas</h4><ul>";
  chaves.forEach((chave, i) => {
    html += `<li>${chave.substring(0,20)}... 
      <button onclick="revogarChave(${i})">ğŸ—‘ï¸ Revogar</button></li>`;
  });
  html += "</ul>";
  area.innerHTML = html;
}

function revogarChave(index) {
  let chaves = JSON.parse(localStorage.getItem("chavesAES") || "[]");
  if (!chaves[index]) return;
  if (confirm("Revogar esta chave?")) {
    chaves.splice(index, 1);
    localStorage.setItem("chavesAES", JSON.stringify(chaves));
    logSetor("seguranca_info", "ğŸ—‘ï¸ Uma chave AES foi revogada.");
    listarChaves();
  }
}

// 3. SimulaÃ§Ã£o de Ataque
function simularAtaque() {
  logSetor("seguranca_info", "ğŸš¨ ALERTA: Tentativa de invasÃ£o detectada!");
  document.getElementById("resultado-seguranca").innerHTML =
    `<p style="color:red">ğŸš¨ SimulaÃ§Ã£o: Tentativa de invasÃ£o detectada!</p>`;
}

// 4. Scanner Interno
function scannerInterno() {
  const pastas = JSON.parse(localStorage.getItem("pastas") || "{}");
  let vulneraveis = [];
  for (let nome in pastas) {
    if (!pastas[nome].senha || pastas[nome].senha.trim() === "") {
      vulneraveis.push(nome);
    }
  }
  if (vulneraveis.length === 0) {
    document.getElementById("resultado-seguranca").innerHTML =
      "<p style='color:lime'>âœ… Nenhuma vulnerabilidade encontrada.</p>";
    logSetor("seguranca_info", "ğŸ” Scanner concluÃ­do â€” nenhuma falha encontrada.");
  } else {
    document.getElementById("resultado-seguranca").innerHTML =
      `<p style="color:orange">âš ï¸ Pastas vulnerÃ¡veis: ${vulneraveis.join(", ")}</p>`;
    logSetor("seguranca_info", `âš ï¸ Scanner encontrou pastas vulnerÃ¡veis: ${vulneraveis.join(", ")}`);
  }
}

// ======= DIVISÃƒO DE PSICOLOGIA ESTRATÃ‰GICA =======

// 1. Listar perfis psicolÃ³gicos (baseado no quiz)
function listarPerfis() {
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  let html = "<h4>ğŸ“Š Perfis PsicolÃ³gicos</h4><ul>";
  for (let nome in usuarios) {
    html += `<li>${nome} â€” Perfil: ${usuarios[nome].perfil || "â“ NÃ£o definido"}</li>`;
  }
  html += "</ul>";
  document.getElementById("resultado-psicologia").innerHTML = html;
  logSetor("psicologia", "ğŸ“Š Listagem de perfis psicolÃ³gicos exibida.");
}

// 2. AvaliaÃ§Ã£o de risco
function avaliarRisco() {
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  let html = "<h4>âš ï¸ AvaliaÃ§Ã£o de Risco</h4><ul>";
  for (let nome in usuarios) {
    const perfil = usuarios[nome].perfil || "indefinido";
    let risco = "âœ… EstÃ¡vel";
    if (perfil.includes("sombrio")) risco = "ğŸš¨ CrÃ­tico";
    else if (perfil.includes("neutro")) risco = "âš ï¸ InstÃ¡vel";
    html += `<li>${nome} â€” ${risco}</li>`;
  }
  html += "</ul>";
  document.getElementById("resultado-psicologia").innerHTML = html;
  logSetor("psicologia", "âš ï¸ AvaliaÃ§Ã£o de risco realizada.");
}

// 3. Mensagens subliminares
function mensagemSubliminar() {
  const usuario = prompt("Enviar mensagem subliminar para qual agente?");
  const msg = prompt("Digite a mensagem subliminar:");
  if (!usuario || !msg) return;
  logSetor("psicologia", `ğŸ’­ Mensagem subliminar enviada para ${usuario}`);
  const area = document.getElementById("resultado-psicologia");
  area.innerHTML = `<p style="color:cyan">ğŸ’­ ${usuario} recebeu: "${msg}"</p>`;
  setTimeout(() => {
    area.innerHTML = "<p style='color:gray'>(Mensagem subliminar expirada)</p>";
  }, 5000);
}

// 4. Controle de moral
function controleMoral() {
  const usuario = prompt("Controle de moral â€” Qual agente?");
  const valor = parseInt(prompt("Digite o novo nÃ­vel de moral (0 a 100):"), 10);
  if (!usuario || isNaN(valor)) return;

  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  if (!usuarios[usuario]) {
    alert("Agente nÃ£o encontrado!");
    return;
  }

  usuarios[usuario].moral = Math.max(0, Math.min(100, valor));
  localStorage.setItem("usuarios", JSON.stringify(usuarios));
  logSetor("psicologia", `ğŸ“ˆ Moral de ${usuario} ajustada para ${valor}.`);
  document.getElementById("resultado-psicologia").innerHTML =
    `<p>ğŸ“ˆ Moral de ${usuario} agora Ã© ${valor}.</p>`;
}

// ======= DIVISÃƒO DE CONTRA-INTELIGÃŠNCIA =======

// 1. VerificaÃ§Ã£o de Logs Suspeitos
function verificarLogsSuspeitos() {
  const logs = JSON.parse(localStorage.getItem("logs_contra_inteligencia") || "[]");
  if (logs.length === 0) {
    document.getElementById("resultado-contra").innerHTML =
      "<p>âœ… Nenhum acesso suspeito registrado.</p>";id=""
  } else {
    document.getElementById("resultado-contra").innerHTML =
      "<h4>ğŸ“œ Logs Suspeitos</h4><ul>" +
      logs.map(l => `<li>${l}</li>`).join("") + "</ul>";
  }
  logSetor("contra_inteligencia", "ğŸ“œ VerificaÃ§Ã£o de logs realizada.");
}

// 2. Rastrear Comportamento
function rastrearComportamento() {
  const logs = JSON.parse(localStorage.getItem("logs_contra_inteligencia") || "[]");
  let contador = {};
  logs.forEach(l => {
    const match = l.match(/por (\w+)/);
    if (match) {
      const user = match[1];
      contador[user] = (contador[user] || 0) + 1;
    }
  });

  let html = "<h4>ğŸ‘€ Rastreio de Tentativas</h4><ul>";
  for (let u in contador) {
    html += `<li>${u} â€” ${contador[u]} tentativas</li>`;
  }
  html += "</ul>";

  document.getElementById("resultado-contra").innerHTML = html;
  logSetor("contra_inteligencia", "ğŸ‘€ Rastreamento de comportamento executado.");
}

// 3. Armadilha Digital
function armadilhaDigital() {
  const pastas = JSON.parse(localStorage.getItem("pastas") || "{}");
  const fakeName = "TOP_SECRET_" + Math.floor(Math.random() * 1000);
  pastas[fakeName] = { senha: "", fake: true };
  localStorage.setItem("pastas", JSON.stringify(pastas));
  logSetor("contra_inteligencia", `ğŸª¤ Armadilha criada: ${fakeName}`);
  document.getElementById("resultado-contra").innerHTML =
    `<p>ğŸª¤ Armadilha digital criada: ${fakeName}</p>`;
}

// 4. Detector de Identidades Duplicadas
function detectarDuplicidade() {
  const usuarios = lJSON.parse(localStorage.getItem("usuarios") || "{}");
  let frases = {};
  let duplicados = [];

  for (let nome in usuarios) {
    const frase = usuarios[nome].frase || "";
    if (frases[frase]) {
      duplicados.push(`${nome} e ${frases[frase]} usam a mesma frase de seguranÃ§a`);
    } else {
      frases[frase] = nome;
    }
  }

  if (duplicados.length === 0) {
    document.getElementById("resultado-contra").innerHTML =
      "<p>âœ… Nenhuma identidade duplicada encontrada.</p>";
  } else {
    document.getElementById("resultado-contra").innerHTML =
      "<h4>ğŸ•µï¸ Identidades Duplicadas</h4><ul>" +
      duplicados.map(d => `<li>${d}</li>`).join("") + "</ul>";
  }

  logSetor("contra_inteligencia", "ğŸ•µï¸ Detector de identidades duplicadas executado.");
}

async function depositoPIX() {
  const paraUser = prompt("ID do agente que vai receber (nÃºmero):");
  const valor = parseInt(prompt("Valor (centavos):"), 10);
  const r = await fetch("http://localhost:8080/api/pix/charge", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ paraUser: Number(paraUser), valorCentavos: valor })
  });
  const j = await r.json();
  document.getElementById("resultado-financas").innerHTML =
    `<p>TXID: ${j.txid}</p><p>PIX Copia e Cola:</p><textarea>${j.copia_cola}</textarea>`;
}

async function depositoBTC() {
  const paraUser = prompt("ID do agente que vai receber (nÃºmero):");
  const valorUSD = parseFloat(prompt("Valor (USD):"));
  const r = await fetch("http://localhost:8080/api/btc/charge", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ paraUser: Number(paraUser), valorUSD })
  });
  const j = await r.json();
  document.getElementById("resultado-financas").innerHTML =
    `<p>Abra para pagar em BTC:</p><a href="${j.url}" target="_blank">${j.url}</a>`;
}

// ======= DIVISÃƒO DE OPERAÃ‡ÃƒO DE CAMPO =======

// Criar missÃ£o
function criarMissao() {
  const titulo = prompt("TÃ­tulo da missÃ£o:");
  const local = prompt("Local da missÃ£o (ex: SÃ£o Paulo - SP):");
  const agentes = prompt("Agentes envolvidos (separados por vÃ­rgula):");
  const lat = parseFloat(prompt("Latitude do local:"));
  const lng = parseFloat(prompt("Longitude do local:"));

  if (!titulo || !local || !lat || !lng) {
    alert("âŒ InformaÃ§Ãµes insuficientes para criar missÃ£o!");
    return;
  }

  const missoes = JSON.parse(localStorage.getItem("missoes") || "[]");
  const id = "M" + String(missoes.length + 1).padStart(3, "0");

  const nova = {
    id,
    titulo,
    local,
    coordenadas: [lat, lng],
    agentes: agentes.split(",").map(a => a.trim()),
    status: "ativa",
    criadoEm: new Date().toISOString()
  };

  missoes.push(nova);
  localStorage.setItem("missoes", JSON.stringify(missoes));

  document.getElementById("resultado-operacao").innerHTML =
    `<p>âœ… MissÃ£o criada: <strong>${nova.titulo}</strong> (${nova.id})</p>`;
  logSetor("operacao_campo", `ğŸ¯ MissÃ£o criada: ${nova.titulo} (${nova.id})`);
}

// Listar missÃµes
function listarMissoes() {
  const missoes = JSON.parse(localStorage.getItem("missoes") || "[]");
  if (missoes.length === 0) {
    document.getElementById("resultado-operacao").innerHTML =
      "<p>ğŸ“­ Nenhuma missÃ£o registrada.</p>";
    return;
  }

  let html = "<h4>ğŸ“‹ MissÃµes Registradas</h4><ul>";
  missoes.forEach(m => {
    html += `<li>${m.id} â€” ${m.titulo} | ${m.local} | Status: ${m.status} | Agentes: ${m.agentes.join(", ")}</li>`;
  });
  html += "</ul>";

  document.getElementById("resultado-operacao").innerHTML = html;
  logSetor("operacao_campo", "ğŸ“‹ Listagem de missÃµes exibida.");
}

// Mostrar no mapa
function mapaMissoes() {
  const missoes = JSON.parse(localStorage.getItem("missoes") || "[]");
  if (missoes.length === 0) {
    alert("âš ï¸ Nenhuma missÃ£o cadastrada!");
    return;
  }

  const divMapa = document.getElementById("mapa-missoes");
  divMapa.innerHTML = ""; // limpar
  const mapa = L.map(divMapa).setView(missoes[0].coordenadas, 5);

  function mapaMissoes() {
  const divMapa = document.getElementById("mapa-missoes");
  divMapa.innerHTML = ""; // limpa antes de recarregar

  // Inicia o mapa
  var mapa = L.map("mapa-missoes").setView([-15.7801, -47.9292], 4);

  // Camada base do mapa (OpenStreetMap)
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> colaboradores'
  }).addTo(mapa);

  // Recupera missÃµes do localStorage
  const missoes = JSON.parse(localStorage.getItem("missoes") || "[]");

  missoes.forEach(m => {
    if (m.local && m.local.lat && m.local.lng) {
      L.marker([m.local.lat, m.local.lng])
        .addTo(mapa)
        .bindPopup(`<b>${m.nome}</b><br>Status: ${m.status}`);
    }
  });
}

  missoes.forEach(m => {
    L.marker(m.coordenadas).addTo(mapa)
      .bindPopup(`<b>${m.titulo}</b><br>${m.local}<br>Status: ${m.status}`);
  });
<!--  -->
  logSetor("operacao_campo", "ğŸ—ºï¸ Mapa de missÃµes exibido.");
}

// Atualizar status da missÃ£o
function atualizarStatusMissao() {
  const id = prompt("Digite o ID da missÃ£o (ex: M001):");
  const status = prompt("Novo status (ativa, concluida, falha):");
  if (!id || !status) return;

  const missoes = JSON.parse(localStorage.getItem("missoes") || "[]");
  const missao = missoes.find(m => m.id === id);
  if (!missao) {
    alert("âŒ MissÃ£o nÃ£o encontrada!");
    return;
  }

  missao.status = status;
  localStorage.setItem("missoes", JSON.stringify(missoes));

  document.getElementById("resultado-operacao").innerHTML =
    `<p>âš¡ MissÃ£o ${id} atualizada para <strong>${status}</strong>.</p>`;
  logSetor("operacao_campo", `âš¡ MissÃ£o ${id} atualizada para ${status}.`);
}

// ======= DIVISÃƒO DE IA ESTRATÃ‰GICA & DEEP LEARNING =======

// 1. Analisar logs globais
function analisarLogsGlobais() {
  const setores = ["seguranca_info","psicologia","contra_inteligencia","financas","operacao_campo","ia_estrategica"];
  let html = "<h4>ğŸ“Š AnÃ¡lise de Logs Globais</h4><ul>";

  setores.forEach(s => {
    const logs = JSON.parse(localStorage.getItem("logs_" + s) || "[]");
    html += `<li>${s}: ${logs.length} eventos registrados</li>`;
  });

  html += "</ul>";
  document.getElementById("resultado-ia").innerHTML = html;
  logSetor("ia_estrategica", "ğŸ“Š Logs globais analisados.");
}

// 2. Detectar risco estratÃ©gico
function detectarRiscoEstrategico() {
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  let risco = [];

  for (let nome in usuarios) {
    const u = usuarios[nome];
    if ((u.moral || 100) < 30) {
      risco.push(`${nome} â€” ğŸš¨ Moral crÃ­tica`);
    }
    if ((u.perfil || "").includes("sombrio")) {
      risco.push(`${nome} â€” âš ï¸ Perfil psicolÃ³gico sombrio`);
    }
  }

  if (risco.length === 0) {
    document.getElementById("resultado-ia").innerHTML = "<p>âœ… Nenhum risco estratÃ©gico detectado.</p>";
  } else {
    document.getElementById("resultado-ia").innerHTML =
      "<h4>âš ï¸ Agentes em Zona de Risco</h4><ul>" + risco.map(r => `<li>${r}</li>`).join("") + "</ul>";
  }

  logSetor("ia_estrategica", "âš ï¸ DetecÃ§Ã£o de risco estratÃ©gico executada.");
}

// 3. PrevisÃ£o de operaÃ§Ãµes (baseada em missÃµes concluÃ­das/falhas)
function previsaoOperacoes() {
  const missoes = JSON.parse(localStorage.getItem("missoes") || "[]");
  const concluidas = missoes.filter(m => m.status === "concluida").length;
  const falhas = missoes.filter(m => m.status === "falha").length;
  const total = concluidas + falhas;

  let chance = "Indefinida";
  if (total > 0) {
    chance = Math.round((concluidas / total) * 100) + "%";
  }

  document.getElementById("resultado-ia").innerHTML =
    `<p>ğŸ“ˆ Chance estimada de sucesso em prÃ³ximas operaÃ§Ãµes: <strong>${chance}</strong></p>`;
  logSetor("ia_estrategica", "ğŸ“ˆ PrevisÃ£o de operaÃ§Ãµes calculada.");
}

// 4. Gerar relatÃ³rio estratÃ©gico (download .txt)
function gerarRelatorioEstrategico() {
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  const missoes = JSON.parse(localStorage.getItem("missoes") || "[]");
  const auditoria = JSON.parse(localStorage.getItem("auditoria_financas") || "[]");

  let relatorio = "=== RELATÃ“RIO ESTRATÃ‰GICO CYBER NEXIS ===\n\n";

  relatorio += "ğŸ‘¥ UsuÃ¡rios Registrados:\n";
  for (let nome in usuarios) {
    relatorio += `- ${nome} | NÃ­vel: ${usuarios[nome].nivel} | Moral: ${usuarios[nome].moral || 100}\n`;
  }

  relatorio += "\nğŸ¯ MissÃµes:\n";
  missoes.forEach(m => {
    relatorio += `- ${m.id} | ${m.titulo} | Status: ${m.status} | Agentes: ${m.agentes.join(", ")}\n`;
  });

  relatorio += "\nğŸ’° Auditoria Financeira:\n";
  auditoria.slice(-5).forEach(a => {
    relatorio += `- ${a.de || "?"} -> ${a.para || "?"} | ${a.valor} | ${a.data}\n`;
  });

  const blob = new Blob([relatorio], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "relatorio_estrategico.txt";
  a.click();
  URL.revokeObjectURL(url);

  logSetor("ia_estrategica", "ğŸ“ RelatÃ³rio estratÃ©gico gerado.");
}

function mostrarFormularioComandante(nome, senha, nivel) {
  const conteudo = document.getElementById("conteudo");
  conteudo.innerHTML = `
    <h2>ğŸ“‹ Cadastro de Comandante</h2>
    <p>UsuÃ¡rio: <strong>${nome}</strong></p>
    <p>NÃ­vel: <strong>${nivel}</strong></p>

    <label>Escolha a divisÃ£o:</label>
    <select id="setorComando" onchange="mostrarPerguntasSetor()">
      <option value="">-- Selecione --</option>
      <option value="seguranca_info">ğŸ”’ SeguranÃ§a da InformaÃ§Ã£o</option>
      <option value="psicologia">ğŸ§  Psicologia EstratÃ©gica</option>
      <option value="contra_inteligencia">ğŸ­ Contra-InteligÃªncia</option>
      <option value="financas">ğŸ’° FinanÃ§as Secretas</option>
      <option value="operacao_campo">ğŸ›°ï¸ OperaÃ§Ã£o de Campo</option>
      <option value="ia_estrategica">ğŸ¤– IA EstratÃ©gica</option>
    </select>

    <div id="perguntas-setor" style="margin-top:15px;"></div>
    <button onclick="finalizarCadastroComandante('${nome}','${senha}','${nivel}')">âœ… Finalizar Cadastro</button>
  `;
}

function mostrarPerguntasSetor() {
  const setor = document.getElementById("setorComando").value;
  const area = document.getElementById("perguntas-setor");

  let html = "";
  if (setor === "seguranca_info") {
    html = `
      <p>1. VocÃª tem experiÃªncia com criptografia AES?</p>
      <input type="text" id="q1">
      <p>2. Como reagiria a uma tentativa de invasÃ£o?</p>
      <input type="text" id="q2">
    `;
  } else if (setor === "psicologia") {
    html = `
      <p>1. Como lidaria com um agente em colapso emocional?</p>
      <input type="text" id="q1">
      <p>2. O que significa disciplina estratÃ©gica para vocÃª?</p>
      <input type="text" id="q2">
    `;
  } else if (setor === "contra_inteligencia") {
    html = `
      <p>1. Como identificaria um infiltrado?</p>
      <input type="text" id="q1">
      <p>2. Qual seria sua primeira aÃ§Ã£o ao detectar duplicidade de identidade?</p>
      <input type="text" id="q2">
    `;
  } else if (setor === "financas") {
    html = `
      <p>1. Como garantiria a integridade de recursos secretos?</p>
      <input type="text" id="q1">
      <p>2. Como lidaria com suspeita de corrupÃ§Ã£o interna?</p>
      <input type="text" id="q2">
    `;
  } else if (setor === "operacao_campo") {
    html = `
      <p>1. Como coordenaria agentes em campo sob risco?</p>
      <input type="text" id="q1">
      <p>2. O que significa â€œdisciplina operacionalâ€ para vocÃª?</p>
      <input type="text" id="q2">
    `;
  } else if (setor === "ia_estrategica") {
    html = `
      <p>1. Qual a importÃ¢ncia de prever falhas antes de ocorrerem?</p>
      <input type="text" id="q1">
      <p>2. Como usaria IA para melhorar operaÃ§Ãµes da organizaÃ§Ã£o?</p>
      <input type="text" id="q2">
    `;
  }

  area.innerHTML = html;
}
function finalizarCadastroComandante(nome, senha, nivel) {
  const setor = document.getElementById("setorComando").value;
  if (!setor) {
    alert("âŒ VocÃª precisa escolher uma divisÃ£o!");
    return;
  }

  const setores = JSON.parse(localStorage.getItem("setores") || "{}");
  if (setores[setor]) {
    alert(`âŒ JÃ¡ existe um comandante registrado na divisÃ£o ${setor}.`);
    return;
  }

  const resposta1 = document.getElementById("q1")?.value || "";
  const resposta2 = document.getElementById("q2")?.value || "";

  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  usuarios[nome] = { senha, nivel, setor, respostas: [resposta1, resposta2] };
  localStorage.setItem("usuarios", JSON.stringify(usuarios));

  setores[setor] = nome;
  localStorage.setItem("setores", JSON.stringify(setores));

  log(`âœ… Comandante ${nome} registrado na divisÃ£o ${setor}.`);
  alert(`âœ… Cadastro concluÃ­do! Agora ${nome} Ã© o comandante de ${setor}.`);

  abrirSetor(setor); // jÃ¡ abre o painel do setor escolhido
}

function irParaLogin() {
  const conteudo = document.getElementById("conteudo");
  conteudo.innerHTML = `
    <h2>ğŸ”‘ Login</h2>
    <input id="login-nome" placeholder="UsuÃ¡rio"><br>
    <input id="login-senha" type="password" placeholder="Senha"><br>
    <button onclick="fazerLogin()">Entrar</button>
  `;
}

function fazerLogin() {
  const nome = document.getElementById("login-nome").value;
  const senha = document.getElementById("login-senha").value;

  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  if (!usuarios[nome]) {
    alert("âŒ UsuÃ¡rio nÃ£o encontrado!");
    return;
  }

  if (usuarios[nome].senha !== senha) {
    alert("âŒ Senha incorreta!");
    return;
  }

  alert(`âœ… Bem-vindo ${nome}!`);
  abrirPainel(usuarios[nome]); // essa funÃ§Ã£o jÃ¡ deve existir no seu sistema
}

<!-- COLE ESTE BLOCO DENTRO DO MESMO <script> (ou em app.js) -->
// ===== IMPLEMENTAÃ‡Ã•ES REAIS (MÃ“DULOS) =====

/**
 * scannerInterno()
 * - Varre pastas, arquivos e usuÃ¡rios em busca de vulnerabilidades simples:
 *   - pastas sem senha, senhas fracas (<6), arquivos grandes (>1MB em dataURL),
 *   - usuÃ¡rios com senha fraca (<6).
 * - Exibe resultados em #resultado-seguranca e registra logSetor.
 */
function scannerInterno() {
  const pastas = JSON.parse(localStorage.getItem("pastas") || "{}");
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");

  let resultados = {
    pastas_sem_senha: [],
    pastas_senha_fraca: [],
    arquivos_grandes: [],
    usuarios_senha_fraca: []
  };

  // Verifica pastas
  for (let nome in pastas) {
    const p = pastas[nome];
    const senha = (p.senha || "").toString();
    if (!senha) resultados.pastas_sem_senha.push(nome);
    else if (senha.length < 6) resultados.pastas_senha_fraca.push({ nome, senha });

    // arquivos (procuramos dataURLs grandes)
    for (let arq in (p.arquivos || {})) {
      const conteudo = p.arquivos[arq];
      // se for dataURL verifique o tamanho aproximado
      if (typeof conteudo === "string" && conteudo.startsWith("data:")) {
        // estima tamanho do payload base64
        const base64 = conteudo.split(",")[1] || "";
        const tamanhoBytes = Math.round((base64.length * 3) / 4);
        if (tamanhoBytes > 1 * 1024 * 1024) { // >1MB
          resultados.arquivos_grandes.push({ pasta: nome, arquivo: arq, tamanhoBytes });
        }
      }
    }
  }

  // Verifica senhas fracas de usuÃ¡rios
  for (let nome in usuarios) {
    const u = usuarios[nome];
    const s = (u.senha || "").toString();
    if (!s || s.length < 6) resultados.usuarios_senha_fraca.push(nome);
  }

  // Monta saÃ­da legÃ­vel
  let html = "<h4>ğŸ” Resultado do Scanner Interno</h4>";
  if (resultados.pastas_sem_senha.length === 0 &&
      resultados.pastas_senha_fraca.length === 0 &&
      resultados.arquivos_grandes.length === 0 &&
      resultados.usuarios_senha_fraca.length === 0) {
    html += "<p style='color:lime'>âœ… Nenhuma vulnerabilidade crÃ­tica encontrada.</p>";
    document.getElementById("resultado-seguranca").innerHTML = html;
    logSetor("seguranca_info", "ğŸ” Scanner interno concluÃ­do â€” sem problemas crÃ­ticos.");
    return;
  }

  if (resultados.pastas_sem_senha.length) {
    html += `<p style="color:orange">âš ï¸ Pastas sem senha: ${resultados.pastas_sem_senha.join(", ")}</p>`;
  }
  if (resultados.pastas_senha_fraca.length) {
    html += "<p style='color:orange'>âš ï¸ Pastas com senha fraca:</p><ul>";
    resultados.pastas_senha_fraca.forEach(p => html += `<li>${p.nome} (senha: "${p.senha}")</li>`);
    html += "</ul>";
  }
  if (resultados.arquivos_grandes.length) {
    html += "<p style='color:orange'>âš ï¸ Arquivos grandes detectados:</p><ul>";
    resultados.arquivos_grandes.forEach(a => html += `<li>${a.pasta}/${a.arquivo} â€” ~${Math.round(a.tamanhoBytes/1024)} KB</li>`);
    html += "</ul>";
  }
  if (resultados.usuarios_senha_fraca.length) {
    html += `<p style='color:orange'>âš ï¸ UsuÃ¡rios com senha fraca: ${resultados.usuarios_senha_fraca.join(", ")}</p>`;
  }

  document.getElementById("resultado-seguranca").innerHTML = html;
  logSetor("seguranca_info", "ğŸ” Scanner interno detectou possÃ­veis riscos.");
}


/**
 * armadilhaDigital()
 * - Cria uma pasta "honeypot" com arquivos falsos e marca como 'honeypot'.
 * - Se alguÃ©m abrir a pasta, a funÃ§Ã£o abrirPasta() (existente) vai abrir normalmente.
 * - Para "detecÃ§Ã£o", adicionamos um contador em localStorage.logs_contra_inteligencia.
 */
function armadilhaDigital() {
  const pastas = JSON.parse(localStorage.getItem("pastas") || "{}");
  const fakeName = "HONEY_POT_" + Math.floor(Math.random() * 9000 + 1000);
  const now = new Date().toLocaleString();

  // Cria arquivos falsos (texto)
  const arquivos = {
    "README_HONEYPOT.txt": btoa(`AVISO: Acesso monitorado\nCriado em: ${now}`),
    "secrets_list.txt": btoa("senha1:12345\nsenha2:abcdef\n-- arquivo honeypot --")
  };

  pastas[fakeName] = {
    senha: "",           // sem senha para atrair curiosos
    fake: true,
    honeypot: true,
    arquivos
  };

  localStorage.setItem("pastas", JSON.stringify(pastas));

  // registre no log de contra-inteligÃªncia
  const logs = JSON.parse(localStorage.getItem("logs_contra_inteligencia") || "[]");
  logs.push(`${new Date().toLocaleTimeString()} - Armadilha criada: ${fakeName}`);
  localStorage.setItem("logs_contra_inteligencia", JSON.stringify(logs));

  document.getElementById("resultado-contra").innerHTML =
    `<p>ğŸª¤ Armadilha digital criada: <strong>${fakeName}</strong> (qualquer acesso serÃ¡ registrado).</p>`;
  logSetor("contra_inteligencia", `ğŸª¤ Armadilha criada: ${fakeName}`);
}

/**
 * DetecÃ§Ã£o "passiva" de honeypot: quando uma pasta Ã© aberta atravÃ©s de abrirPasta(),
 * essa funÃ§Ã£o nÃ£o precisa ser chamda manualmente â€” mas podemos aumentar a checagem:
 * Adicione no topo da funÃ§Ã£o abrirPasta (no seu cÃ³digo) apÃ³s validar senha:
 *
 * if (pastas[nome].honeypot) {
 *   const logs = JSON.parse(localStorage.getItem("logs_contra_inteligencia")||"[]");
 *   logs.push(`${new Date().toLocaleTimeString()} - Acesso honeypot: ${nome} por ${usuarioAtual ? usuarioAtual.nome : 'anÃ´nimo'}`);
 *   localStorage.setItem("logs_contra_inteligencia", JSON.stringify(logs));
 * }
 *
 * (Se quiser, eu jÃ¡ adapto o seu abrirPasta para incluir essa checagem.)
 */

/**
 * detectarDuplicidade()
 * - Verifica duplicaÃ§Ãµes entre usuÃ¡rios:
 *   - mesma frase secreta entre 2+ usuÃ¡rios,
 *   - mesma senha bruta entre 2+ usuÃ¡rios (avisa).
 * - Mostra resultado em #resultado-contra e registra logSetor.
 */
function detectarDuplicidade() {
  const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
  const mapaFrases = {};
  const mapaSenhas = {};
  const duplicadosFrase = [];
  const duplicadosSenha = [];

  for (let nome in usuarios) {
    const u = usuarios[nome];
    const frase = (u.frase || "").toString();
    const senha = (u.senha || "").toString();

    if (frase) {
      if (!mapaFrases[frase]) mapaFrases[frase] = [];
      mapaFrases[frase].push(nome);
    }
    if (senha) {
      if (!mapaSenhas[senha]) mapaSenhas[senha] = [];
      mapaSenhas[senha].push(nome);
    }
  }

  for (let f in mapaFrases) {
    if (mapaFrases[f].length > 1) duplicadosFrase.push({ frase: f, usuarios: mapaFrases[f] });
  }
  for (let s in mapaSenhas) {
    if (mapaSenhas[s].length > 1) duplicadosSenha.push({ senha: s, usuarios: mapaSenhas[s] });
  }

  let html = "<h4>ğŸ•µï¸ Detector de Duplicidade</h4>";
  if (duplicadosFrase.length === 0 && duplicadosSenha.length === 0) {
    html += "<p style='color:lime'>âœ… Nenhuma duplicidade encontrada.</p>";
    document.getElementById("resultado-contra").innerHTML = html;
    logSetor("contra_inteligencia", "ğŸ•µï¸ Detector executado â€” sem duplicidades.");
    return;
  }

  if (duplicadosFrase.length) {
    html += "<p style='color:orange'>âš ï¸ Frases de seguranÃ§a duplicadas:</p><ul>";
    duplicadosFrase.forEach(d => html += `<li>Frase "${d.frase}" â€” UsuÃ¡rios: ${d.usuarios.join(", ")}</li>`);
    html += "</ul>";
  }

  if (duplicadosSenha.length) {
    html += "<p style='color:orange'>âš ï¸ Senhas idÃªnticas encontradas (recomenda-se alteraÃ§Ã£o):</p><ul>";
    duplicadosSenha.forEach(d => html += `<li>Senha "${d.senha}" â€” UsuÃ¡rios: ${d.usuarios.join(", ")}</li>`);
    html += "</ul>";
  }

  document.getElementById("resultado-contra").innerHTML = html;
  logSetor("contra_inteligencia", "ğŸ•µï¸ Detector de duplicidade executado.");
}


/**
 * depositoPIX() e depositoBTC()
 * - Simulam cobranÃ§as/links sem chamar servidores reais.
 * - Geram um objeto salvo em localStorage ("transacoesPIX" / "transacoesBTC") para auditoria.
 */

// Simula um pequeno delay
function _delay(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

async function depositoPIX() {
  // Pede dados ao usuÃ¡rio
  const paraUser = prompt("ID do agente que vai receber (nome de usuÃ¡rio):");
  const valorCentavos = parseInt(prompt("Valor (centavos):"), 10);
  if (!paraUser || isNaN(valorCentavos) || valorCentavos <= 0) {
    return alert("Dados invÃ¡lidos. OperaÃ§Ã£o cancelada.");
  }

  // Simula processamento
  document.getElementById("resultado-financas").innerHTML = "<p>Processando cobranÃ§a PIX...</p>";
  await _delay(700);

  const txid = "PIX" + Date.now().toString(36).toUpperCase().slice(-10);
  const copia_cola = `000201...${txid}...CEPAGTO`; // placeholder legÃ­vel

  // Salva transaÃ§Ã£o
  const transacoes = JSON.parse(localStorage.getItem("transacoesPIX") || "[]");
  transacoes.push({
    txid,
    paraUser,
    valorCentavos,
    status: "pendente",
    criadoEm: new Date().toISOString()
  });
  localStorage.setItem("transacoesPIX", JSON.stringify(transacoes));

  document.getElementById("resultado-financas").innerHTML =
    `<p>âœ… CobranÃ§a PIX gerada (simulada)</p>
     <p><strong>TXID:</strong> ${txid}</p>
     <p><strong>Valor:</strong> R$ ${(valorCentavos/100).toFixed(2)}</p>
     <p><strong>PIX Copia e Cola:</strong></p>
     <textarea rows="3">${copia_cola}</textarea>
     <p style="font-size:0.9em;color:gray">Status: pendente (simulaÃ§Ã£o)</p>`;

  logSetor("financas", `âš¡ PIX simulado criado para ${paraUser} â€” TXID ${txid}`);
}

async function depositoBTC() {
  const paraUser = prompt("ID do agente que vai receber (nome de usuÃ¡rio):");
  const valorUSD = parseFloat(prompt("Valor (USD):"));
  if (!paraUser || isNaN(valorUSD) || valorUSD <= 0) {
    return alert("Dados invÃ¡lidos. OperaÃ§Ã£o cancelada.");
  }

  document.getElementById("resultado-financas").innerHTML = "<p>Gerando fatura BTC (simulada)...</p>";
  await _delay(700);

  const id = "BTC" + Date.now().toString(36).toUpperCase().slice(-10);
  const fakeUrl = `https://pay.example/btc/invoice/${id}`;

  // Salva transaÃ§Ã£o
  const transacoes = JSON.parse(localStorage.getItem("transacoesBTC") || "[]");
  transacoes.push({
    id,
    paraUser,
    valorUSD,
    url: fakeUrl,
    status: "aguardando",
    criadoEm: new Date().toISOString()
  });
  localStorage.setItem("transacoesBTC", JSON.stringify(transacoes));

  document.getElementById("resultado-financas").innerHTML =
    `<p>âœ… Fatura BTC gerada (simulada)</p>
     <p><strong>ID:</strong> ${id}</p>
     <p><strong>Valor:</strong> US$ ${valorUSD.toFixed(2)}</p>
     <p><strong>Link de pagamento:</strong> <a href="${fakeUrl}" target="_blank">${fakeUrl}</a></p>
     <p style="font-size:0.9em;color:gray">Status: aguardando (simulaÃ§Ã£o)</p>`;

  logSetor("financas", `â‚¿ Fatura BTC simulada para ${paraUser} â€” ID ${id}`);
}

// Mostrar tela de login
function irParaLogin() {
  document.getElementById("telaCadastro").style.display = "none";
  document.getElementById("telaLogin").style.display = "block";
}

// Mostrar tela de cadastro (quando clica em "Novo agente")
function irParaCadastro() {
  document.getElementById("telaLogin").style.display = "none";
  document.getElementById("telaCadastro").style.display = "block";
}

async function firebaseSignIn() {
  try {
    const userCred = await auth.signInAnonymously();
    usuarioAtual = usuarioAtual || { nome: `anon-${userCred.user.uid}`, nivel: 'Iniciado' };
    logAcao(`ğŸ” Conectado ao Firebase como ${userCred.user.uid}`);
    return userCred.user;
  } catch (e) {
    console.error("Erro auth Firebase:", e);
    alert("Erro ao autenticar: " + e.message);
  }
}

// Envia mensagem cifrada AES-GCM com passphrase da sala
async function firebaseSendMessage(sala, texto, passphrase) {
  if (!usuarioAtual) await firebaseSignIn();
  const cript = await encryptMessageWithPassword(texto, passphrase); // usa helper que jÃ¡ temos
  const ts = Date.now();
  const ref = db.ref("chats/" + sala + "/messages");
  await ref.push({
    from: usuarioAtual.nome,
    meta: cript, // objeto {salt, iv, cipher}
    ts
  });
  logAcao(`âœ‰ï¸ Mensagem enviada na sala "${sala}"`);
}

// Escuta mensagens em tempo real
function firebaseListenMessages(sala, passphrase) {
  const ref = db.ref("chats/" + sala + "/messages");
  ref.on("child_added", async snap => {
    const msg = snap.val();
    try {
      const texto = await decryptMessageWithPassword(msg.meta, passphrase);
      log(`ğŸ’¬ [${msg.from}] ${texto}`);
      mostrarMensagemNaUI(msg.from, texto, msg.ts); // vocÃª pode criar essa funÃ§Ã£o para exibir
    } catch (e) {
      console.warn("Falha ao descriptografar mensagem", e);
    }
  });
}

function abrirChatOnline() {
  const conteudo = document.getElementById("conteudo");
  clearElement(conteudo);

  appendSafe(conteudo, "h2", "ğŸ’¬ Chat Online");

  const salaInput = document.createElement("input");
  salaInput.placeholder = "Nome da sala";
  conteudo.appendChild(salaInput);

  const passInput = document.createElement("input");
  passInput.type = "password";
  passInput.placeholder = "Passphrase da sala";
  conteudo.appendChild(passInput);

  const joinBtn = document.createElement("button");
  joinBtn.textContent = "Entrar";
  joinBtn.onclick = () => {
    const sala = salaInput.value.trim();
    const pass = passInput.value.trim();
    if (!sala || !pass) return alert("Informe sala e passphrase");
    iniciarChatSala(sala, pass);
  };
  conteudo.appendChild(joinBtn);

  const msgsDiv = document.createElement("div");
  msgsDiv.id = "chat-online-mensagens";
  msgsDiv.style.height = "300px";
  msgsDiv.style.overflowY = "auto";
  msgsDiv.style.border = "1px solid #333";
  conteudo.appendChild(msgsDiv);

  const input = document.createElement("input");
  input.placeholder = "Digite sua mensagem...";
  conteudo.appendChild(input);

  const sendBtn = document.createElement("button");
  sendBtn.textContent = "Enviar";
  conteudo.appendChild(sendBtn);

  sendBtn.onclick = async () => {
    const texto = input.value.trim();
    if (!texto) return;
    await firebaseSendMessage(window.salaAtual, texto, window.passAtual);
    input.value = "";
  };
}

function iniciarChatSala(sala, passphrase) {
  window.salaAtual = sala;
  window.passAtual = passphrase;
  firebaseSignIn().then(() => {
    firebaseListenMessages(sala, passphrase);
    logAcao(`ğŸ“¡ Conectado Ã  sala "${sala}"`);
  });
}

function mostrarMensagemNaUI(from, texto, ts) {
  const msgsDiv = document.getElementById("chat-online-mensagens");
  if (!msgsDiv) return;
  const p = document.createElement("p");
  p.textContent = `[${new Date(ts).toLocaleTimeString()}] ${from}: ${texto}`;
  msgsDiv.appendChild(p);
  msgsDiv.scrollTop = msgsDiv.scrollHeight;
}

// ====== Painel AnalÃ­tico AvanÃ§ado ======
// Requer helpers: safeTextNode, appendSafe, clearElement, loadChats, saveChats, getPastas
// e (opcional) Firebase inicializado na variÃ¡vel `db` (realtime database compat).

function abrirPainelAnalise() {
  const conteudo = document.getElementById('conteudo');
  clearElement(conteudo);

  appendSafe(conteudo, 'h2', 'ğŸ“Š Painel AnalÃ­tico â€” Cyber-Nexis');

  const controls = document.createElement('div');
  controls.style.display = 'flex';
  controls.style.gap = '8px';
  controls.style.marginBottom = '10px';

  const btnAtualizar = document.createElement('button');
  btnAtualizar.textContent = 'ğŸ”„ Atualizar Agora';
  btnAtualizar.onclick = () => atualizarPainelAnalise();
  controls.appendChild(btnAtualizar);

  const autoChk = document.createElement('input');
  autoChk.type = 'checkbox';
  autoChk.id = 'analise-auto';
  controls.appendChild(autoChk);
  const lbl = document.createElement('label');
  lbl.htmlFor = 'analise-auto';
  lbl.textContent = 'Auto-refresh 10s';
  controls.appendChild(lbl);

  const btnExport = document.createElement('button');
  btnExport.textContent = 'ğŸ“¤ Exportar CSV';
  btnExport.onclick = () => exportAnaliseCSV();
  controls.appendChild(btnExport);

  appendSafe(conteudo, 'div', ''); // spacer
  conteudo.appendChild(controls);

  // area resumo
  const resumo = document.createElement('div');
  resumo.id = 'analise-resumo';
  resumo.style.border = '1px solid lime';
  resumo.style.padding = '8px';
  resumo.style.background = '#000';
  resumo.style.maxHeight = '60vh';
  resumo.style.overflow = 'auto';
  conteudo.appendChild(resumo);

  // details area
  const detalhe = document.createElement('div');
  detalhe.id = 'analise-detalhe';
  detalhe.style.marginTop = '10px';
  conteudo.appendChild(detalhe);

  // iniciar primeira coleta
  atualizarPainelAnalise();

  // auto-refresh handler
  if (window._analiseInterval) clearInterval(window._analiseInterval);
  document.getElementById('analise-auto').onchange = (e) => {
    if (e.target.checked) {
      window._analiseInterval = setInterval(atualizarPainelAnalise, 10000);
    } else {
      clearInterval(window._analiseInterval);
      window._analiseInterval = null;
    }
  };
}

// FunÃ§Ã£o central que coleta mÃ©tricas
async function coletarMetricas() {
  // 1) dados do localStorage
  const usuarios = JSON.parse(localStorage.getItem('usuarios') || '{}');
  const usuariosArr = Object.keys(usuarios);
  const numUsuarios = usuariosArr.length;

  const observadoresExpirados = usuariosArr.filter(n => usuarios[n].nivel === 'Observador' && usuarios[n].criadoEm && (Date.now() > usuarios[n].criadoEm + 24*60*60*1000)).length;
  const numObservadores = usuariosArr.filter(n => usuarios[n].nivel === 'Observador').length;

  const sessoes = JSON.parse(localStorage.getItem('sessaoAtual') ? JSON.stringify([JSON.parse(localStorage.getItem('sessaoAtual')).nome]) : '[]');
  const numSessoesSalvas = (localStorage.getItem('sessaoAtual') ? 1 : 0); // cliente Ãºnico

  // pastas e arquivos
  const pastas = getPastas ? getPastas() : JSON.parse(localStorage.getItem('pastas') || '{}');
  const listaPastas = Object.keys(pastas || {});
  const numPastas = listaPastas.length;
  let numArquivos = 0;
  listaPastas.forEach(p => {
    const arquivos = pastas[p].arquivos || {};
    numArquivos += Object.keys(arquivos).length;
  });

  // mensagens locais (mensagens secretas)
  const mensagens = JSON.parse(localStorage.getItem('mensagens') || '{}');
  let numMensagensLocais = 0;
  for (let dest in mensagens) {
    numMensagensLocais += mensagens[dest].length;
  }

  // missoes e operacoes
  const missoes = JSON.parse(localStorage.getItem('missoes') || '[]');
  const operacoes = JSON.parse(localStorage.getItem('operacoes') || '[]');
  const numMissoes = missoes.length;
  const numOperacoes = operacoes.length;

  // chaves AES locais
  const chavesAES = JSON.parse(localStorage.getItem('chavesAES') || '[]');
  const numChavesAES = chavesAES.length;

  // usuarios com historico de localizacao
  const usuariosComLoc = usuariosArr.filter(n => usuarios[n].historicoLocais && usuarios[n].historicoLocais.length > 0).length;

  // dados de chats locais (o chat encriptado que criamos antes)
  const chatsLocal = JSON.parse(localStorage.getItem('chats_v1') || '{}');
  const numConversasLocais = Object.keys(chatsLocal || {}).length;
  let numMensagensLocaisChat = 0;
  for (let c in chatsLocal) numMensagensLocaisChat += (chatsLocal[c].messages || []).length;

  // 2) dados do Firebase (se existir db)
  let firebaseStats = { rooms: 0, messages: 0 };
  if (typeof db !== 'undefined') {
    try {
      // tenta ler conteudo mÃ­nimo (uma vez)
      const snap = await db.ref('chats').once('value');
      const val = snap.val() || {};
      firebaseStats.rooms = Object.keys(val).length;
      let total = 0;
      for (let room in val) {
        const msgs = val[room].messages || {};
        total += Object.keys(msgs).length;
      }
      firebaseStats.messages = total;
    } catch (e) {
      // falha ao acessar Firebase (regra/permission) â€” apenas log
      console.warn('Firebase nÃ£o disponÃ­vel para estatÃ­sticas:', e);
    }
  }

  return {
    numUsuarios,
    numObservadores,
    observadoresExpirados,
    numSessoesSalvas,
    numPastas,
    numArquivos,
    numMensagensLocais,
    numMissoes,
    numOperacoes,
    numChavesAES,
    usuariosComLoc,
    numConversasLocais,
    numMensagensLocaisChat,
    firebaseRooms: firebaseStats.rooms,
    firebaseMessages: firebaseStats.messages,
    timestamp: Date.now(),
    detalhes: {
      usuariosList: usuariosArr,
      pastasList: listaPastas,
      conversasList: Object.keys(chatsLocal || {})
    }
  };
}

// Atualiza o painel visual
async function atualizarPainelAnalise() {
  const resumo = document.getElementById('analise-resumo');
  const detalhe = document.getElementById('analise-detalhe');
  if (!resumo || !detalhe) return;
  clearElement(resumo);
  clearElement(detalhe);

  appendSafe(resumo, 'p', 'Coletando mÃ©tricas...');
  const m = await coletarMetricas();

  // montar tabela simples
  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  table.style.fontFamily = 'monospace';
  const header = document.createElement('tr');
  ['MÃ©trica','Contagem','AÃ§Ã£o'].forEach(t => {
    const th = document.createElement('th');
    th.style.border = '1px solid lime';
    th.style.padding = '6px';
    th.style.background = '#050';
    th.textContent = t;
    header.appendChild(th);
  });
  table.appendChild(header);

  function addRow(name, value, detailFn) {
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.style.border='1px solid #0f0'; td1.style.padding='6px'; td1.textContent = name;
    const td2 = document.createElement('td'); td2.style.border='1px solid #0f0'; td2.style.padding='6px'; td2.textContent = String(value);
  const td3 = document.createElement('td');
  td3.style.border='1px solid #0f0'; td3.style.padding='6px';
    if (detailFn) {
      const b = document.createElement('button');
      b.textContent = 'Detalhar';
      b.onclick = () => detailFn();
      td3.appendChild(b);
    } else {
      td3.textContent = '-';
    }
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    table.appendChild(tr);
  }

  addRow('UsuÃ¡rios cadastrados', m.numUsuarios, () => mostrarDetalhe('UsuÃ¡rios', m.detalhes.usuariosList));
  addRow('Observadores (total)', m.numObservadores, () => mostrarDetalhe('Observadores', m.detalhes.usuariosList.filter(n => {
    const u = JSON.parse(localStorage.getItem('usuarios') || '{}')[n];
    return u && u.nivel === 'Observador';
  })));
  addRow('Observadores expirados (24h)', m.observadoresExpirados);
  addRow('SessÃµes salvas (navegador)', m.numSessoesSalvas);
  addRow('Pastas', m.numPastas, () => mostrarDetalhe('Pastas', m.detalhes.pastasList));
  addRow('Arquivos (total)', m.numArquivos);
  addRow('Mensagens locais (inbox)', m.numMensagensLocais);
  addRow('Conversas locais (chat)', m.numConversasLocais, () => mostrarDetalhe('Conversas Locais', m.detalhes.conversasList));
  addRow('Mensagens locais (chat)', m.numMensagensLocaisChat);
  addRow('MissÃµes registradas', m.numMissoes);
  addRow('OperaÃ§Ãµes ativas', m.numOperacoes);
  addRow('Chaves AES (locais)', m.numChavesAES);
  addRow('UsuÃ¡rios com histÃ³rico de local', m.usuariosComLoc);
  addRow('Firebase: salas (remoto)', m.firebaseRooms);
  addRow('Firebase: mensagens (remoto)', m.firebaseMessages);

  // timestamp
  addRow('Ãšltima atualizaÃ§Ã£o (ms)', m.timestamp);

  // substituir conteudo do resumo
  clearElement(resumo);
  resumo.appendChild(table);

  // detalhe vazio por enquanto
  appendSafe(detalhe, 'h3', 'Detalhes');
  appendSafe(detalhe, 'p', 'Clique em "Detalhar" para ver listas especÃ­ficas.');

  // armazenar a Ãºltima coleta para export
  window.__ultimaAnalise = m;
}

// funÃ§Ã£o que mostra um painel com lista detalhada
function mostrarDetalhe(titulo, lista) {
  const detalhe = document.getElementById('analise-detalhe');
  clearElement(detalhe);
  appendSafe(detalhe, 'h3', `ğŸ” Detalhe: ${titulo}`);
  if (!lista || lista.length === 0) {
    appendSafe(detalhe, 'p', '(vazio)');
    return;
  }
  const ul = document.createElement('ul');
  ul.style.listStyle = 'none';
  ul.style.padding = '0';
  lista.forEach(item => {
    const li = document.createElement('li');
    li.style.padding = '6px';
    li.style.borderBottom = '1px dashed #222';
    li.appendChild(safeTextNode('div', String(item)));
    ul.appendChild(li);
  });
  detalhe.appendChild(ul);
  const back = document.createElement('button');
  back.textContent = 'â† Voltar';
  back.onclick = () => atualizarPainelAnalise();
  detalhe.appendChild(back);
}

// Export CSV
function exportAnaliseCSV() {
  const m = window.__ultimaAnalise;
  if (!m) return alert('Nenhuma anÃ¡lise disponÃ­vel. Atualize primeiro.');
  const rows = [
    ['MÃ©trica','Valor'],
    ['UsuÃ¡rios cadastrados', m.numUsuarios],
    ['Observadores', m.numObservadores],
    ['Observadores expirados', m.observadoresExpirados],
    ['SessÃµes salvas', m.numSessoesSalvas],
    ['Pastas', m.numPastas],
    ['Arquivos', m.numArquivos],
    ['Mensagens locais', m.numMensagensLocais],
    ['Conversas locais', m.numConversasLocais],
    ['Mensagens locais (chat)', m.numMensagensLocaisChat],
    ['MissÃµes', m.numMissoes],
    ['OperaÃ§Ãµes', m.numOperacoes],
    ['Chaves AES', m.numChavesAES],
    ['UsuÃ¡rios com local', m.usuariosComLoc],
    ['Firebase rooms', m.firebaseRooms],
    ['Firebase messages', m.firebaseMessages],
    ['timestamp', m.timestamp]
  ];
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `analise_cybernexis_${Date.now()}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// Inicializa painel automaticamente se jÃ¡ aberto
// (opcional) vocÃª pode chamar abrirPainelAnalise() em outros momentos
</script>

<!-- Firebase SDKs (versÃ£o compatÃ­vel com uso direto no navegador) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js">
</script>
<script>
const sons = {
  digitar: new Audio('son/digitar.mp3'),
  alerta: new Audio('sons/ui-click-menu-modern-interface-select-small-01-230473'),
  abrir: new Audio('sons/abrir.mp3')
};

function tocarSom(nome) {
  const som = sons[nome];
  if (som) {
    som.currentTime = 0;
    som.play().catch(()=>{}); // evita erro em autoplay bloqueado
  }
}

<!-- === ASSISTENTE VIRTUAL CYBER-NEXIS === -->
<style>
/* Assistente: botÃ£o flutuante e chat */
#cn-assistente-btn {
  position: fixed;
  right: 18px;
  bottom: 18px;
  width: 64px;
  height: 64px;
  background: linear-gradient(135deg,#0ff,#0f0);
  border-radius: 50%;
  box-shadow: 0 8px 24px rgba(0,255,0,0.14);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index:9999;
  border:2px solid rgba(0,0,0,0.6);
  font-weight:bold;
}
#cn-assistente-btn:hover { transform: scale(1.04); }

#cn-assistente-panel {
  position: fixed;
  right: 20px;
  bottom: 92px;
  width: 360px;
  max-width: calc(100% - 40px);
  height: 520px;
  background: #050505;
  border: 1px solid #0f0;
  border-radius: 10px;
  box-shadow: 0 18px 40px rgba(0,0,0,0.6);
  z-index: 9999;
  display: none;
  flex-direction: column;
  overflow: hidden;
  color: lime;
  font-family: monospace;
}

#cn-assistente-header {
  padding: 10px;
  background: linear-gradient(90deg,#00110010,#00110020);
  display:flex; align-items:center; justify-content:space-between;
  border-bottom:1px solid rgba(0,255,0,0.06);
}
#cn-assistente-header h4 { margin:0; font-size:14px; color:#bfffbf }
#cn-assistente-close { cursor:pointer; padding:6px; border-radius:6px; background:transparent; color:lime; }

#cn-assistente-content {
  flex:1;
  padding: 10px;
  overflow:auto;
  background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.85));
}
.cn-msg { margin:8px 0; padding:8px 10px; border-radius:8px; max-width:85%; line-height:1.2; }
.cn-msg.assistente { background: rgba(0,255,0,0.06); border:1px solid rgba(0,255,0,0.08); color: #d9ffe0; }
.cn-msg.usuario { background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.03); color: lime; align-self:flex-end; }

#cn-assistente-footer {
  padding: 10px;
  border-top:1px solid rgba(0,255,0,0.04);
  display:flex; gap:8px;
  align-items:center;
}
#cn-input { flex:1; padding:8px; background:black; color:lime; border:1px solid #0f0; border-radius:6px; font-family:monospace; }
.cn-btn { padding:8px 10px; background:#0f0; color:black; border-radius:6px; cursor:pointer; font-weight:bold; }
.cn-mini { padding:6px 8px; background:transparent; color:lime; border:1px solid rgba(0,255,0,0.06); border-radius:6px; cursor:pointer; }

/* quick command list */
#cn-comandos { font-size:12px; color:#bfffbf; margin-top:6px; }
.cn-chip { display:inline-block; padding:4px 6px; margin:4px 4px 0 0; border:1px solid rgba(0,255,0,0.06); border-radius:6px; cursor:pointer; }

/* persona select */
#cn-persona { margin-left:10px; background:black; color:lime; border:1px solid #0f0; padding:4px; border-radius:6px; }

/* responsiveness */
@media (max-width:420px) {
  #cn-assistente-panel { width: calc(100% - 24px); right:12px; left:12px; bottom:80px; height:62vh; }
  #cn-assistente-btn { right:12px; bottom:12px; }
}
</style>

<!-- Button -->
<div id="cn-assistente-btn" title="Assistente Virtual â€” Cyber-Nexis">AI</div>

<!-- Panel -->
<div id="cn-assistente-panel" aria-hidden="true">
  <div id="cn-assistente-header">
    <h4>Assistente Virtual â€” Cyber-Nexis <small id="cn-mode-label"></small></h4>
    <div>
      <select id="cn-persona" title="Personalidade do Assistente">
        <option value="neutro">Neutro & Profissional</option>
        <option value="sombrio">Sombrio & Misterioso</option>
        <option value="militar">Agressivo & Militar</option>
        <option value="tecnico">TÃ©cnico â€” IA</option>
      </select>
      <span id="cn-assistente-close">âœ•</span>
    </div>
  </div>

  <div id="cn-assistente-content"></div>

  <div id="cn-assistente-footer">
    <input id="cn-input" placeholder="Digite sua pergunta, ou use um comando rÃ¡pido..." />
    <button class="cn-btn" id="cn-send">Enviar</button>
  </div>
</div>

<script>
/* ===== Assistente Virtual â€” JS ===== */
(function(){
  const btn = document.getElementById('cn-assistente-btn');
  const panel = document.getElementById('cn-assistente-panel');
  const close = document.getElementById('cn-assistente-close');
  const content = document.getElementById('cn-assistente-content');
  const input = document.getElementById('cn-input');
  const send = document.getElementById('cn-send');
  const personaSel = document.getElementById('cn-persona');
  const modeLabel = document.getElementById('cn-mode-label');

  // Inicial persona / modo
  personaSel.value = 'neutro';

  // Small helpers
  function appendMsg(text, who='assistente') {
    const el = document.createElement('div');
    el.className = 'cn-msg ' + (who==='assistente' ? 'assistente' : 'usuario');
    el.innerHTML = text;
    content.appendChild(el);
    content.scrollTop = content.scrollHeight;
  }
  function sysLog(msg) { // registra no log visual principal e no painel do assistente
    try { logAcao(msg); } catch(e) {}
    appendMsg('<em style="color:#aaffaa;">' + msg + '</em>');
  }

  function getPersonaText(key) {
    const persona = personaSel.value;
    const texts = {
      neutro: {
        welcome: "Bem-vindo ao Cyber-Nexis. Em que posso auxiliar hoje?",
        promptPrefix: "Assistente (Neutro):"
      },
      sombrio: {
        welcome: "Vejo que adentrou a teia. O que busca nesta noite, Agente?",
        promptPrefix: "Assistente (Sombrio):"
      },
      militar: {
        welcome: "Agente, reporte-se. Informe o comando ou solicitaÃ§Ã£o.",
        promptPrefix: "Assistente (Comando):"
      },
      tecnico: {
        welcome: "MÃ³dulos operacionais online. Como posso otimizar sua execuÃ§Ã£o?",
        promptPrefix: "Assistente (IA):"
      }
    };
    return (texts[persona] && texts[persona][key]) || texts.neutro[key];
  }

  // Determina modo de uso (Visitante / Agente / Comandante / LÃ­der)
  function getUserMode() {
    try {
      if (!window.usuarioAtual) return 'Visitante';
      const lvl = usuarioAtual.nivel || '';
      if (lvl === 'LÃ­der Supremo') return 'LÃ­der Supremo';
      if (lvl === 'Comandante') return 'Comandante';
      return 'Agente';
    } catch(e) { return 'Visitante'; }
  }

  // Atualiza label do modo
  function updateModeLabel() {
    modeLabel.textContent = ' â€” ' + getUserMode();
  }

  // Comandos rÃ¡pidos visÃ­veis no assistente
  function showQuickCommands() {
    const html = `
      <div id="cn-comandos">
        Comandos rÃ¡pidos:
        <span class="cn-chip" data-cmd="ajuda">Ajuda</span>
        <span class="cn-chip" data-cmd="cadastro">Como me cadastrar</span>
        <span class="cn-chip" data-cmd="setores">Explicar setores</span>
        <span class="cn-chip" data-cmd="relatorio-dia">RelatÃ³rio do dia</span>
        <span class="cn-chip" data-cmd="relatorio-setor">RelatÃ³rio do meu setor</span>
        <span class="cn-chip" data-cmd="checagem">Checar falhas</span>
      </div>
    `;
    appendMsg(html);
    // attach handlers
    document.querySelectorAll('#cn-comandos .cn-chip').forEach(chip=>{
      chip.onclick = ()=> handleCommand(chip.dataset.cmd);
    });
  }

  // Gera relatÃ³rios a partir do localStorage
  function gerarRelatorio(tipo) {
    const usuarios = JSON.parse(localStorage.getItem("usuarios") || "{}");
    const operacoes = JSON.parse(localStorage.getItem("operacoes") || "[]");
    const mensagens = JSON.parse(localStorage.getItem("mensagens") || "{}");
    const setores = JSON.parse(localStorage.getItem("setores") || "{}");

    if (tipo === 'relatorio-dia') {
      // ex: acessos e operaÃ§Ãµes do dia
      const hoje = new Date().toLocaleDateString();
      const acessos = []; // vamos procurar eventos no localStorage? usamos operacoes como proxy
      operacoes.forEach(op=>{
        op.eventos.forEach(ev=>{
          if (ev.hora && ev.descricao && ev.hora.indexOf(':')>=0) {
            acessos.push(`${ev.hora} â€” ${ev.descricao}`);
          }
        });
      });
      return `ğŸ“… RelatÃ³rio do Dia (${hoje})\n\nOperaÃ§Ãµes:\n- ${acessos.join('\n- ') || '(nenhuma operaÃ§Ã£o registrada)'}\n\nTotal de agentes: ${Object.keys(usuarios).length}`;
    }

    if (tipo === 'relatorio-setor') {
      const modo = getUserMode();
      if (modo === 'Visitante') return 'ğŸ”’ VocÃª precisa estar logado para obter relatÃ³rio de setor.';
      const nome = usuarioAtual.nome;
      // descobrir setor do comandante (se for comandante) ou achar setor do usuÃ¡rio
      const usuarioObj = usuarios[nome] || {};
      const setor = usuarioObj.setor || Object.keys(setores).find(k=>setores[k]===nome) || usuarioObj.setor || '(nÃ£o identificado)';
      // coletar logs do setor
      const logs = JSON.parse(localStorage.getItem(`logs_${setor}`) || "[]");
      return `ğŸ“Š RelatÃ³rio do Setor: ${setor}\nComandante: ${setores[setor] || 'N/A'}\n\nLogs recentes:\n- ${logs.join('\n- ') || '(nenhum log)'}`;
    }

    if (tipo === 'relatorio-moral') {
      let arr=[];
      for (let n in usuarios) {
        arr.push(`${n}: ${usuarios[n].moral ?? 'â€”'}`);
      }
      return `ğŸ“ˆ RelatÃ³rio de Moral â€” agentes:\n${arr.join('\n')}`;
    }

    if (tipo === 'relatorio-mensagens') {
      let total=0;
      for (let u in mensagens) total += (mensagens[u] || []).length;
      return `âœ‰ï¸ Mensagens secretas (total armazenadas): ${total}`;
    }

    if (tipo === 'relatorio-observador') {
      const expirados=[];
      for (let n in usuarios) {
        const u = usuarios[n];
        if (u.nivel === 'Observador' && u.criadoEm) {
          const limite = u.criadoEm + 24*60*60*1000;
          if (Date.now() > limite) expirados.push(n);
        }
      }
      return `â³ Observadores expirados: ${expirados.join(', ') || '(nenhum)'}`;
    }

    return 'âš ï¸ Tipo de relatÃ³rio desconhecido.';
  }

  // Checagens rÃ¡pidas de falhas
  function checarFalhas() {
    const issues = [];
    try {
      if (!localStorage) issues.push('LocalStorage indisponÃ­vel');
    } catch(e) { issues.push('LocalStorage inacessÃ­vel'); }
    try {
      JSON.parse(localStorage.getItem('usuarios') || '{}');
    } catch(e) { issues.push('Erro ao ler usuÃ¡rios (JSON invÃ¡lido)'); }
    // verifica setores
    const setores = JSON.parse(localStorage.getItem('setores') || '{}');
    if (!setores || typeof setores !== 'object') issues.push('Objeto "setores" invÃ¡lido');
    return issues.length ? ('âš ï¸ Problemas encontrados:\n' + issues.join('\n')) : 'âœ… Nenhuma falha detectada localmente.';
  }

  // Responde perguntas simples (rule-based)
  function responderPergunta(text) {
    const t = text.toLowerCase().trim();
    // saudaÃ§Ãµes
    if (/^(oi|olÃ¡|bom dia|boa tarde|boa noite|hello)/i.test(t)) {
      return getPersonaText('welcome');
    }
    if (t.includes('como me cadastrar') || t.includes('cadastrar') || t.includes('criar conta')) {
      return "Para se cadastrar, vÃ¡ em CADASTRO â†’ preencha usuÃ¡rio, senha, frase secreta â†’ escolha um nÃ­vel. Se for Comandante, escolha tambÃ©m o setor. Clique em Cadastrar.";
    }
    if (t.includes('setor') || t.includes('setores')) {
      return "Os setores disponÃ­veis: SeguranÃ§a da InformaÃ§Ã£o, Psicologia EstratÃ©gica, Contra-InteligÃªncia, FinanÃ§as Secretas, OperaÃ§Ã£o de Campo, IA EstratÃ©gica. Comandantes gerenciam cada setor.";
    }
    if (t.includes('relatÃ³rio') && t.includes('dia')) return gerarRelatorio('relatorio-dia');
    if (t.includes('moral')) return gerarRelatorio('relatorio-moral');
    if (t.includes('mensagens')) return gerarRelatorio('relatorio-mensagens');
    if (t.includes('observador')) return gerarRelatorio('relatorio-observador');
    if (t.includes('checagem') || t.includes('falha')) return checarFalhas();
    // default
    return "Desculpe, nÃ£o entendi exatamente. VocÃª pode usar comandos rÃ¡pidos (veja os chips) ou perguntar: 'Como me cadastrar?', 'RelatÃ³rio do dia', 'RelatÃ³rio do meu setor', 'Checar falhas'.";
  }

  // handler for commands
  function handleCommand(cmd) {
    if (!cmd) return;
    if (cmd === 'ajuda') {
      appendMsg('<strong>Ajuda rÃ¡pida:</strong><br>- Pergunte coisas como: "Como me cadastrar?" ou "RelatÃ³rio do dia".', 'assistente');
      showQuickCommands();
      return;
    }
    if (cmd === 'cadastro') { appendMsg('VÃ¡ no formulÃ¡rio de CADASTRO. Preencha usuÃ¡rio, senha e frase. Se for Comandante, escolha setor.'); return; }
    if (cmd === 'setores') { appendMsg('Setores: SeguranÃ§a da InformaÃ§Ã£o, Psicologia, Contra-InteligÃªncia, FinanÃ§as, OperaÃ§Ãµes, IA.'); return; }
    if (cmd === 'relatorio-dia') { appendMsg(gerarRelatorio('relatorio-dia')); return; }
    if (cmd === 'relatorio-setor') { appendMsg(gerarRelatorio('relatorio-setor')); return; }
    if (cmd === 'checagem') { appendMsg(checarFalhas()); return; }
  }

  // send handler
  send.onclick = () => {
    const txt = input.value.trim();
    if (!txt) return;
    appendMsg(txt, 'usuario');
    input.value = '';
    // process
    setTimeout(()=> {
      // quick parse: if starts with "/" treat as explicit command
      if (txt.startsWith('/')) {
        const cmd = txt.slice(1).trim();
        handleCommand(cmd);
        return;
      }
      // else rule based
      const resp = responderPergunta(txt);
      appendMsg(resp, 'assistente');
    }, 250);
  };

  // open/close handlers
  btn.onclick = () => {
    panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
    if (panel.style.display === 'flex') {
      panel.style.flexDirection = 'column';
      content.innerHTML = ''; // limpa ao abrir
      updateModeLabel();
      appendMsg(`<strong>${getPersonaText('welcome')}</strong>`, 'assistente');
      showQuickCommands();
      // mostrar status resumido
      appendMsg(`<em>Estado do sistema: ${navigator.onLine ? 'Online' : 'Offline'} | Protocolo: ${location.protocol}</em>`);
    }
  };
  close.onclick = ()=> { panel.style.display = 'none'; };

  // Enter key
  input.addEventListener('keydown', e=>{
    if (e.key === 'Enter') send.click();
  });

  // persona change
  personaSel.addEventListener('change', ()=> {
    appendMsg(`<em>Personalidade alterada para: ${personaSel.options[personaSel.selectedIndex].text}</em>`);
  });

  // auto-close if user logs out - observe session changes
  const originalOnStorage = window.onstorage;
  window.addEventListener('storage', (e)=>{
    if (e.key === 'sessaoAtual') {
      updateModeLabel();
    }
  });

  // expose for debugging
  window.cnAssistente = {
    gerarRelatorio, checarFalhas, handleCommand
  };

  // initial small demo message in console
  console.log('ğŸ¤– Assistente Virtual Cyber-Nexis carregado.');
})();

<!-- === MAPA MUNDI â€” CYBER-NEXIS === -->
<style>
/* Mapa mundi modal */
#cn-mundi-btn { cursor:pointer; padding:8px 10px; background:transparent; border:1px solid lime; color:lime; border-radius:6px; display:inline-block; margin:6px 0; }
#cn-mundi-modal {
  position: fixed; left: 20px; right: 20px; top: 40px; bottom: 40px;
  background: #000; border:1px solid #0f0; border-radius:8px; z-index:9998;
  display:none; overflow:hidden; color:lime; font-family:monospace;
  box-shadow:0 20px 60px rgba(0,255,0,0.06);
}
#cn-mundi-header { padding:8px 12px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(0,255,0,0.06);}
#cn-mundi-body { display:flex; height:calc(100% - 46px); }
#cn-mundi-map { flex:1; min-width:320px; }
#cn-mundi-side { width:360px; border-left:1px solid rgba(0,255,0,0.04); padding:8px; overflow:auto; }
.cn-mundi-row { margin:6px 0; }
.cn-mundi-btn { padding:6px 8px; background:#0f0; color:#000; border-radius:6px; cursor:pointer; display:inline-block; margin-right:6px;}
.cn-mundi-small { padding:6px 8px; background:transparent; color:lime; border-radius:6px; border:1px solid rgba(0,255,0,0.06); cursor:pointer; margin-right:6px;}
.cn-mundi-input { width:100%; padding:6px; margin:6px 0; background:black; color:lime; border:1px solid #0f0; border-radius:6px; }
.mundi-list { max-height:220px; overflow:auto; border-top:1px solid rgba(0,255,0,0.02); margin-top:8px; padding-top:8px; }
.mundi-item { padding:6px; border-bottom:1px dashed rgba(0,255,0,0.03); }
</style>

<!-- Trigger (you can place this button inside menu too) -->
<button id="cn-mundi-open" class="cn-mundi-small" title="Abrir Mapa Mundi Cyber-Nexis">ğŸŒ Mapa Mundi</button>

<!-- Modal -->
<div id="cn-mundi-modal" role="dialog" aria-hidden="true">
  <div id="cn-mundi-header">
    <div><strong>Mapa Mundi â€” Cyber-Nexis</strong> <span style="font-size:12px;color:#bfffbf;margin-left:8px" id="mundi-status"></span></div>
    <div>
      <button id="cn-mundi-close" class="cn-mundi-small">Fechar</button>
    </div>
  </div>
  <div id="cn-mundi-body">
    <div id="cn-mundi-map"></div>
    <div id="cn-mundi-side">
      <div class="cn-mundi-row">
        <button id="cn-add-point" class="cn-mundi-btn">â• Criar Ponto</button>
        <button id="cn-export" class="cn-mundi-small">Exportar JSON</button>
        <input type="file" id="cn-import-file" style="display:none;" />
        <button id="cn-import" class="cn-mundi-small">Importar JSON</button>
      </div>

      <div class="cn-mundi-row">
        <label>Filtro:</label>
        <select id="cn-filter" class="cn-mundi-input">
          <option value="">Todos</option>
          <option value="publico">ğŸ”µ PÃºblico</option>
          <option value="confidencial">ğŸŸ¡ Confidencial</option>
          <option value="alto">ğŸ”´ Alto Sigilo</option>
          <option value="ultra">âš« Ultra Secreto</option>
        </select>
      </div>

      <div class="cn-mundi-row">
        <strong>Pontos registrados</strong>
        <div class="mundi-list" id="mundi-list"></div>
      </div>

      <div style="margin-top:8px;font-size:12px;color:#bfffbf">
        ObservaÃ§Ãµes: detalhes restritos por senha; apenas Comandantes e LÃ­der Supremo podem criar/editar/remover pontos. O LÃ­der Supremo ignora senhas.
      </div>
    </div>
  </div>
</div>

<script>
/* ===== MAPA MUNDI CYBER-NEXIS =====
   Depende de: gerarSalt(), pbkdf2Hash(), usuarioAtual, logAcao(), logSetor()
   Armazena pontos em localStorage['mundi_satellites'] = {id: {...}}
*/

(function(){
  const openBtn = document.getElementById('cn-mundi-open');
  const modal = document.getElementById('cn-mundi-modal');
  const closeBtn = document.getElementById('cn-mundi-close');
  const mapContainer = document.getElementById('cn-mundi-map');
  const addBtn = document.getElementById('cn-add-point');
  const exportBtn = document.getElementById('cn-export');
  const importBtn = document.getElementById('cn-import');
  const importFile = document.getElementById('cn-import-file');
  const filterSel = document.getElementById('cn-filter');
  const listDiv = document.getElementById('mundi-list');
  const status = document.getElementById('mundi-status');

  let map=null, markersLayer=null, loaded=false;
  const STORAGE_KEY = 'mundi_satellites';

  function loadLeaflet(cb) {
    if (window.L) return cb();
    // CSS
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(link);
    // Script
    const s = document.createElement('script');
    s.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    s.onload = cb;
    document.body.appendChild(s);
  }

  function ensureData() {
    if (!localStorage.getItem(STORAGE_KEY)) localStorage.setItem(STORAGE_KEY, JSON.stringify({}));
  }

  function getPoints() {
    ensureData();
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  }
  function setPoints(obj) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
  }
  function addLog(msg) { try{ logAcao && logAcao(msg); }catch(e){} }

  function initMap() {
    if (loaded) return;
    loaded = true;
    map = L.map(mapContainer).setView([20,0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    markersLayer = L.layerGroup().addTo(map);
    renderAll();
  }

  function colorForClassific(c) {
    if (c==='publico') return '#2b9cff';
    if (c==='confidencial') return '#ffd24d';
    if (c==='alto') return '#ff5c5c';
    if (c==='ultra') return '#222';
    return '#9ecf9e';
  }

  function renderAll() {
    markersLayer.clearLayers();
    listDiv.innerHTML = '';
    const pts = getPoints();
    const filtro = filterSel.value;
    for (let id in pts) {
      const p = pts[id];
      if (filtro && p.classificacao !== filtro) continue;

      // marker
      const color = colorForClassific(p.classificacao);
      const marker = L.circleMarker([p.lat, p.lon], { radius:8, color:color, fillColor:color, fillOpacity:0.9 }).addTo(markersLayer);
      marker.on('click', ()=> onClickPoint(id));

      // list
      const div = document.createElement('div'); div.className='mundi-item';
      div.innerHTML = `<strong>${p.nome}</strong> <br><small>${p.classificacao || ''}</small>
        <div style="margin-top:6px;">
          <button class="cn-mundi-small" data-id="${id}" data-action="view">Ver</button>
          <button class="cn-mundi-small" data-id="${id}" data-action="loc">Ir</button>
        </div>`;
      listDiv.appendChild(div);
    }
    // attach list handlers
    listDiv.querySelectorAll('button').forEach(b=>{
      b.onclick = async e=>{
        const id = b.dataset.id;
        const action = b.dataset.action;
        if (action === 'view') await onClickPoint(id);
        if (action === 'loc') {
          const p = getPoints()[id];
          if (p && map) map.setView([p.lat, p.lon], 6);
        }
      };
    });
  }

  async function onClickPoint(id) {
    const pts = getPoints();
    const p = pts[id];
    if (!p) return alert('Ponto nÃ£o encontrado.');

    // If user is Leader Supremo -> show details
    if (window.usuarioAtual && usuarioAtual.nivel === 'LÃ­der Supremo') {
      showPointDetails(p, id, true);
      return;
    }

    // visitors or agents: If the point is public, show basic info
    if (p.classificacao === 'publico') {
      showPointDetails(p, id, false);
      return;
    }

    // For confidential/alto/ultra -> ask password
    const tentativa = prompt('Este ponto estÃ¡ protegido. Digite a senha para ver detalhes:');
    if (tentativa === null) return; // cancelou

    // verify pbkdf2
    try {
      const v = await pbkdf2Hash(tentativa, p.salt);
      if (v === p.verifier) {
        showPointDetails(p, id, true);
      } else {
        addLog(`ğŸ”’ Tentativa de acesso falhou ao ponto ${p.nome}`);
        alert('Senha incorreta.');
      }
    } catch (e) {
      console.error(e);
      alert('Erro ao validar senha (crypto).');
    }
  }

  function showPointDetails(p, id, full) {
    // full=true -> show coordinates e info; otherwise basic
    let html = `<h3 style="margin:0">${p.nome}</h3>
      <p><strong>ClassificaÃ§Ã£o:</strong> ${p.classificacao || '(n/a)'}</p>`;
    if (full) {
      html += `<p><strong>Coordenadas:</strong> ${p.lat.toFixed(5)}, ${p.lon.toFixed(5)}</p>
               <p><strong>DescriÃ§Ã£o:</strong> ${p.info || '(sem descriÃ§Ã£o)'}</p>
               <p><strong>Membros:</strong> ${p.membros || '(n/d)'} </p>
               <p style="font-size:12px;color:#aaffaa">Criado por: ${p.criadoPor || 'unknown'} em ${new Date(p.data).toLocaleString()}</p>`;
    } else {
      html += `<p>Detalhes protegidos. Solicite acesso ao Comandante local.</p>`;
    }

    // actions
    const actions = [];
    if (window.usuarioAtual && (usuarioAtual.nivel === 'Comandante' || usuarioAtual.nivel === 'LÃ­der Supremo')) {
      actions.push(`<button class="cn-mundi-btn" data-action="edit" data-id="${id}">âœï¸ Editar</button>`);
      actions.push(`<button class="cn-mundi-btn" data-action="del" data-id="${id}">ğŸ—‘ï¸ Remover</button>`);
    }
    if (p.classificacao === 'ultra' && !(window.usuarioAtual && usuarioAtual.nivel==='LÃ­der Supremo')) {
      // ultra sÃ³ lista, nÃ£o mostrar opÃ§Ã£o de baixar etc.
    }
    // popup-like side display
    const side = document.getElementById('cn-mundi-side');
    // show above the list
    appendAboveList(html + '<div style="margin-top:8px;">' + actions.join(' ') + '</div>');
    // attach handlers
    setTimeout(()=> {
      side.querySelectorAll('button[data-action]').forEach(b=>{
        b.onclick = (e)=> {
          const act = b.dataset.action;
          const id = b.dataset.id;
          if (act === 'edit') openPointEditor(id);
          if (act === 'del') removePoint(id);
        };
      });
    },50);
  }

  // helper: append a transient block above the list
  function appendAboveList(html) {
    // insert at top of side before listDiv
    const side = document.getElementById('cn-mundi-side');
    // remove any previous preview
    const prev = side.querySelector('.mundi-preview');
    if (prev) prev.remove();
    const div = document.createElement('div');
    div.className='mundi-preview';
    div.style.padding='8px';
    div.style.borderBottom='1px solid rgba(0,255,0,0.03)';
    div.innerHTML = html;
    side.insertBefore(div, side.querySelector('.cn-mundi-row + .cn-mundi-row') || listDiv);
  }

  // Editor for creating/editing points
  async function openPointEditor(id) {
    // permission: only Comandante or Lider
    if (!window.usuarioAtual || !(usuarioAtual.nivel === 'Comandante' || usuarioAtual.nivel === 'LÃ­der Supremo')) {
      return alert('Apenas Comandantes ou LÃ­der Supremo podem criar/editar pontos.');
    }
    const isEdit = !!id;
    const pts = getPoints();
    const p = isEdit ? pts[id] : { nome:'', lat:0, lon:0, info:'', membros:'', classificacao:'publico' };

    // create form
    const html = `
      <h3>${isEdit ? 'Editar Ponto' : 'Criar Novo Ponto'}</h3>
      <label>Nome</label><input id="mundi-nome" class="cn-mundi-input" value="${escapeHtml(p.nome)}"/>
      <label>Latitude</label><input id="mundi-lat" class="cn-mundi-input" value="${p.lat}"/>
      <label>Longitude</label><input id="mundi-lon" class="cn-mundi-input" value="${p.lon}"/>
      <label>ClassificaÃ§Ã£o</label>
      <select id="mundi-class" class="cn-mundi-input">
        <option value="publico"${p.classificacao==='publico'?' selected':''}>ğŸ”µ PÃºblico</option>
        <option value="confidencial"${p.classificacao==='confidencial'?' selected':''}>ğŸŸ¡ Confidencial</option>
        <option value="alto"${p.classificacao==='alto'?' selected':''}>ğŸ”´ Alto Sigilo</option>
        <option value="ultra"${p.classificacao==='ultra'?' selected':''}>âš« Ultra Secreto</option>
      </select>
      <label>DescriÃ§Ã£o</label><textarea id="mundi-info" class="cn-mundi-input" rows="3">${escapeHtml(p.info||'')}</textarea>
      <label>Membros (nÃºmero)</label><input id="mundi-membros" class="cn-mundi-input" value="${p.membros||''}"/>
      ${isEdit ? '' : '<label>Senha de acesso (opcional â€” protege detalhes)</label><input id="mundi-senha" class="cn-mundi-input" placeholder="Digite uma senha para proteger detalhes"/>'}
      <div style="margin-top:8px;">
        <button id="mundi-save" class="cn-mundi-btn">${isEdit ? 'Salvar' : 'Criar'}</button>
        <button id="mundi-cancel" class="cn-mundi-small">Cancelar</button>
      </div>
    `;
    appendAboveList(html);
    document.getElementById('mundi-cancel').onclick = ()=> renderAll();
    document.getElementById('mundi-save').onclick = async ()=> {
      const nome = document.getElementById('mundi-nome').value.trim();
      const lat = parseFloat(document.getElementById('mundi-lat').value);
      const lon = parseFloat(document.getElementById('mundi-lon').value);
      const classific = document.getElementById('mundi-class').value;
      const info = document.getElementById('mundi-info').value.trim();
      const membros = document.getElementById('mundi-membros').value.trim();

      if (!nome || isNaN(lat) || isNaN(lon)) return alert('Preencha nome, latitude e longitude vÃ¡lidas.');

      const points = getPoints();

      if (isEdit) {
        points[id].nome = nome; points[id].lat = lat; points[id].lon = lon;
        points[id].classificacao = classific; points[id].info = info; points[id].membros = membros;
        points[id].data = Date.now();
        points[id].criadoPor = usuarioAtual.nome;
        setPoints(points);
        addLog(`âœï¸ Ponto ${nome} editado por ${usuarioAtual.nome}`);
        renderAll();
        return;
      }

      // create new with password hash optional
      const senha = document.getElementById('mundi-senha').value;
      let salt = null, verifier = null;
      if (senha) {
        salt = await gerarSalt();
        verifier = await pbkdf2Hash(senha, salt);
      }
      const newId = 'p_' + Date.now();
      points[newId] = {
        nome, lat, lon, classificacao:classific, info, membros, data: Date.now(),
        criadoPor: usuarioAtual ? usuarioAtual.nome : 'anon',
        salt, verifier
      };
      setPoints(points);
      addLog(`â• Ponto ${nome} criado por ${usuarioAtual ? usuarioAtual.nome : 'anon'}`);
      renderAll();
    };
  }

  function removePoint(id) {
    if (!confirm('Remover este ponto?')) return;
    const pts = getPoints();
    const nome = pts[id] && pts[id].nome;
    delete pts[id];
    setPoints(pts);
    addLog(`ğŸ—‘ï¸ Ponto ${nome} removido por ${usuarioAtual ? usuarioAtual.nome : 'anon'}`);
    renderAll();
  }

  // export / import
  exportBtn.onclick = ()=> {
    const pts = getPoints();
    const blob = new Blob([JSON.stringify(pts, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `mundi_points_${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  };
  importBtn.onclick = ()=> importFile.click();
  importFile.onchange = (e)=> {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = ()=> {
      try {
        const data = JSON.parse(r.result);
        const current = getPoints();
        // merge (overwrite same ids)
        const merged = Object.assign({}, current, data);
        setPoints(merged);
        addLog('ğŸ“¥ Importou pontos no Mapa Mundi.');
        renderAll();
      } catch (err) { alert('Arquivo invÃ¡lido'); }
    };
    r.readAsText(f);
  };

  // event listeners
  openBtn.onclick = ()=> {
    modal.style.display = 'block';
    status.innerText = `Protocolo: ${location.protocol}`;
    loadLeaflet(()=> setTimeout(initMap, 200));
  };
  closeBtn.onclick = ()=> { modal.style.display='none'; };

  addBtn.onclick = ()=> openPointEditor();

  filterSel.onchange = renderAll;

  // helper escape
  function escapeHtml(s) { return String(s||'').replace(/[&<>"]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  // initial ensure
  ensureData();

  // renderAll exposed
  window.cnMundi = { renderAll, openPointEditor, getPoints };

  // If map present on load, try init when user loads module
})();<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Page title</title>
    
    
</head>
<body>   
</body>
</html>
<script>
/*
  INICIALIZAÃ‡ÃƒO DO MAPA PRINCIPAL â€” Cyber-Nexis
  Substitua qualquer script simples de DOMContentLoaded que jÃ¡ cria um mapa 'mapa-cybernexis'.
  Esse bloco integra o mapa principal com o Mapa Mundi (localStorage 'mundi_satellites').
*/

(function(){
  // evita mÃºltiplas inicializaÃ§Ãµes
  if (window.__cnMapaPrincipalInit) return;
  window.__cnMapaPrincipalInit = true;

  // espere atÃ© que o Leaflet esteja carregado
  function whenLeaflet(cb) {
    if (window.L) return cb();
    const s = document.querySelector('script[src*="leaflet"]');
    if (s) {
      s.addEventListener('load', cb);
    } else {
      // fallback, tenta carregar
      const sc = document.createElement('script');
      sc.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      sc.onload = cb;
      document.body.appendChild(sc);
    }
  }

  whenLeaflet(async ()=> {
    // cria mapa apenas quando a tela principal for exibida
    let mapa = null;
    let markersLayer = null;

    function ensureMap() {
      if (mapa) return mapa;
      const cont = document.getElementById('mapa-cybernexis');
      if (!cont) return null;
      mapa = L.map(cont).setView([0,0], 2);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(mapa);
      markersLayer = L.layerGroup().addTo(mapa);

      // controle rÃ¡pido no canto do mapa (pequeno botÃ£o)
      const ctrl = L.control({position: 'topright'});
      ctrl.onAdd = function() {
        const d = L.DomUtil.create('div', 'cn-map-ctrl');
        d.style.cssText = 'background:#0008;border:1px solid #0f0;color:lime;padding:6px;border-radius:6px;font-size:12px;cursor:pointer';
        d.title = 'Sincronizar com Mapa Mundi';
        d.innerHTML = 'ğŸ”„ Mundi';
        d.onclick = ()=> window.mapaPrincipal.renderFromMundi();
        return d;
      };
      ctrl.addTo(mapa);

      return mapa;
    }

    function colorForClassific(c) {
      if (c==='publico') return '#2b9cff';
      if (c==='confidencial') return '#ffd24d';
      if (c==='alto') return '#ff5c5c';
      if (c==='ultra') return '#222';
      return '#9ecf9e';
    }

    function getMundiPoints() {
      try {
        return JSON.parse(localStorage.getItem('mundi_satellites') || '{}');
      } catch(e) { return {}; }
    }

    function clearMarkers() {
      if (markersLayer) markersLayer.clearLayers();
    }

    function addMarkerToMap(p) {
      if (!mapa || !markersLayer) return;
      const color = colorForClassific(p.classificacao);
      const marker = L.circleMarker([p.lat, p.lon], { radius:8, color:color, fillColor:color, fillOpacity:0.9 });
      marker.addTo(markersLayer);
      const basic = `<strong>${p.nome}</strong><br>${p.classificacao || ''}`;
      const full = `${basic}<br>${p.info || '(sem descriÃ§Ã£o)'}<br>membros: ${p.membros||'â€”'}`;
      marker.bindPopup(full);
      return marker;
    }

    // renderiza todos os pontos do mundi
    function renderFromMundi() {
      ensureMap();
      const pts = getMundiPoints();
      clearMarkers();
      let any = 0;
      for (const id in pts) {
        try {
          const p = pts[id];
          if (!p || p.lat==null || p.lon==null) continue;
          addMarkerToMap(p);
          any++;
        } catch(e){}
      }
      if (any === 0) {
        logAcao && logAcao('ğŸŒ Mapa Principal: nenhum ponto do Mapa Mundi encontrado.');
        alert('(Mapa Principal) Nenhum ponto do Mapa Mundi foi encontrado.');
      } else {
        logAcao && logAcao(`ğŸŒ Mapa Principal: sincronizado ${any} pontos do Mapa Mundi.`);
      }
    }

    // expose API
    window.mapaPrincipal = {
      renderFromMundi,
      addMarker: function(lat, lon, label) {
        ensureMap();
        const p = { nome: label||'Ponto', lat: parseFloat(lat), lon: parseFloat(lon), classificacao: 'publico', info: '' };
        return addMarkerToMap(p);
      },
      ensureMap
    };

    // inicializa mapa quando a tela do sistema aparecer
    // se a sessÃ£o jÃ¡ estiver ativa, a tela pode estar visÃ­vel no load
    function tryInitOnVisible() {
      const telaSistema = document.getElementById('telaSistema');
      if (telaSistema && !telaSistema.classList.contains('oculto')) {
        window.mapaPrincipal.ensureMap();
      }
    }

    // observar mudanÃ§as de tela para inicializar mapa ao abrir o painel
    new MutationObserver(()=> {
      tryInitOnVisible();
    }).observe(document.body, { attributes: true, subtree: true, childList: true });

    // tambÃ©m inicializa no load se a tela estiver visÃ­vel
    window.addEventListener('load', tryInitOnVisible);

    // auto-sincronizar ao abrir o modal Mapa Mundi (para refletir no mapa principal)
    const cnOpen = document.getElementById('cn-mundi-open');
    if (cnOpen) cnOpen.addEventListener('click', ()=> {
      // ao abrir o modal, apÃ³s um pequeno delay, sincroniza mapa principal tambÃ©m
      setTimeout(()=> {
        try { window.mapaPrincipal.renderFromMundi(); } catch(e){}
      }, 500);
    });

  }); // whenLeaflet end
})();
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  try {
    // Cria o mapa centralizado no mundo
    const mapa = L.map("mapa-cybernexis").setView([0, 0], 2);

    // Adiciona camada de mapa (OpenStreetMap)
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(mapa);

    // Adiciona marcador central
    const marcadorHQ = L.marker([0, 0])
      .addTo(mapa)
      .bindPopup("ğŸŒ Cyber-Nexis HQ â€” Centro de OperaÃ§Ãµes Globais")
      .openPopup();

    // ğŸ”’ Sistema: Adiciona marcadores secretos de grupos
    const grupos = JSON.parse(localStorage.getItem("gruposMundi") || "[]");
    grupos.forEach(grupo => {
      L.marker([grupo.lat, grupo.lon])
        .addTo(mapa)
        .bindPopup(`ğŸ”’ ${grupo.nome}<br>ğŸ“ ${grupo.localizacao}`);
    });

  } catch (erro) {
    console.error("Erro ao carregar mapa:", erro);
  }
});
</script>
</body>
</html>
